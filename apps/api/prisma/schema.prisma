// Prisma Schema for Momentum
// https://pris.ly/d/prisma-schema

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String    @map("password_hash")
  name            String
  birthDate       DateTime? @map("birth_date") @db.Date
  height          Float?    // in cm
  goalDescription String?   @map("goal_description")
  passwordResetToken     String?   @map("password_reset_token")
  passwordResetExpiresAt DateTime? @map("password_reset_expires_at")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  measurements           Measurement[]
  workouts               Workout[]
  workoutSessions        WorkoutSession[]
  progressionSuggestions ProgressionSuggestion[]
  healthActivities       HealthActivity[]
  syncDevices            SyncDevice[]
  trackableItems         TrackableItem[]

  @@map("users")
}

model Measurement {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id])
  date          DateTime @db.Date

  // Weight in kg
  weight        Float?

  // Upper body (cm)
  neck          Float?
  shoulders     Float?
  chest         Float?

  // Arms (cm) - bilateral
  bicepsLeft    Float?   @map("biceps_left")
  bicepsRight   Float?   @map("biceps_right")
  forearmLeft   Float?   @map("forearm_left")
  forearmRight  Float?   @map("forearm_right")
  wristLeft     Float?   @map("wrist_left")
  wristRight    Float?   @map("wrist_right")

  // Core (cm)
  waist         Float?
  hips          Float?

  // Legs (cm) - bilateral
  thighLeft     Float?   @map("thigh_left")
  thighRight    Float?   @map("thigh_right")
  calfLeft      Float?   @map("calf_left")
  calfRight     Float?   @map("calf_right")
  ankleLeft     Float?   @map("ankle_left")
  ankleRight    Float?   @map("ankle_right")

  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([userId, date])
  @@map("measurements")
}

model Exercise {
  id           String   @id @default(uuid())
  name         String
  muscleGroups String[] @map("muscle_groups")
  createdAt    DateTime @default(now()) @map("created_at")

  workoutItemExercises    WorkoutItemExercise[]
  sessionExercises        SessionExercise[]
  progressionSuggestions  ProgressionSuggestion[]

  @@map("exercises")
}

model Workout {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  items    WorkoutItem[]
  sessions WorkoutSession[]

  @@map("workouts")
}

model WorkoutItem {
  id        String  @id @default(uuid())
  workoutId String  @map("workout_id")
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  type      String  // 'exercise' | 'superset'
  position  Int     // order in workout
  rounds    Int     @default(1) // number of rounds (1 for simple exercise, N for superset)
  restAfter Int     @map("rest_after") // seconds, rest after this item

  exercises        WorkoutItemExercise[]
  sessionExercises SessionExercise[]

  @@index([workoutId, position])
  @@map("workout_items")
}

model WorkoutItemExercise {
  id              String      @id @default(uuid())
  workoutItemId   String      @map("workout_item_id")
  workoutItem     WorkoutItem @relation(fields: [workoutItemId], references: [id], onDelete: Cascade)
  exerciseId      String      @map("exercise_id")
  exercise        Exercise    @relation(fields: [exerciseId], references: [id])
  position        Int         // order in item (1 for simple, 1-N for superset)
  restBetweenSets Int         @map("rest_between_sets") // seconds

  sets             WorkoutSet[]
  sessionExercises SessionExercise[]

  @@index([workoutItemId, position])
  @@map("workout_item_exercises")
}

model WorkoutSet {
  id                    String              @id @default(uuid())
  workoutItemExerciseId String              @map("workout_item_exercise_id")
  workoutItemExercise   WorkoutItemExercise @relation(fields: [workoutItemExerciseId], references: [id], onDelete: Cascade)
  setNumber             Int                 @map("set_number")
  targetReps            Int                 @map("target_reps")
  targetWeight          Float?              @map("target_weight") // kg, nullable

  @@index([workoutItemExerciseId, setNumber])
  @@map("workout_sets")
}

// ============================================
// WORKOUT SESSION MODELS (Story 2.5)
// ============================================

enum SessionStatus {
  in_progress
  completed
  abandoned
}

enum SessionExerciseStatus {
  pending
  in_progress
  completed
  skipped
  substituted
}

model WorkoutSession {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  user        User          @relation(fields: [userId], references: [id])
  workoutId   String        @map("workout_id")
  workout     Workout       @relation(fields: [workoutId], references: [id])
  status      SessionStatus @default(in_progress)
  startedAt   DateTime      @default(now()) @map("started_at")
  completedAt DateTime?     @map("completed_at")
  notes       String?

  exercises              SessionExercise[]
  progressionSuggestions ProgressionSuggestion[]

  @@index([userId, status])
  @@index([workoutId])
  @@map("workout_sessions")
}

model SessionExercise {
  id                    String                @id @default(uuid())
  sessionId             String                @map("session_id")
  session               WorkoutSession        @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  workoutItemExerciseId String?               @map("workout_item_exercise_id")
  workoutItemExercise   WorkoutItemExercise?  @relation(fields: [workoutItemExerciseId], references: [id])
  exerciseId            String                @map("exercise_id")
  exercise              Exercise              @relation(fields: [exerciseId], references: [id])
  status                SessionExerciseStatus @default(pending)
  position              Int                   // Order in session (modifiable via drag & drop)
  substitutedFromId     String?               @map("substituted_from_id") // ID of original exercise if substituted

  // For supersets: reference to parent WorkoutItem
  workoutItemId String?      @map("workout_item_id")
  workoutItem   WorkoutItem? @relation(fields: [workoutItemId], references: [id])

  sets SessionSet[]

  @@index([sessionId, position])
  @@map("session_exercises")
}

model SessionSet {
  id                String          @id @default(uuid())
  sessionExerciseId String          @map("session_exercise_id")
  sessionExercise   SessionExercise @relation(fields: [sessionExerciseId], references: [id], onDelete: Cascade)
  setNumber         Int             @map("set_number")

  // Targets (copied from WorkoutSet at session start)
  targetReps   Int    @map("target_reps")
  targetWeight Float? @map("target_weight")

  // Actual results (entered by user)
  actualReps   Int?   @map("actual_reps")
  actualWeight Float? @map("actual_weight")

  rpe         Int?      // Rate of Perceived Exertion 1-10
  completedAt DateTime? @map("completed_at")

  @@index([sessionExerciseId, setNumber])
  @@map("session_sets")
}

// ============================================
// HEALTH SYNC & TRACKABLE MODELS (Story 5.1)
// ============================================

enum TrackingType {
  boolean
  number
  duration
}

enum GoalFrequency {
  daily
  weekly
  monthly
}

model TrackableItem {
  id           String       @id @default(uuid())
  userId       String       @map("user_id")
  user         User         @relation(fields: [userId], references: [id])
  name         String
  icon         String       // Lucide icon name (e.g., "footprints", "flame")
  color        String       // Hex color (e.g., "#22C55E")
  trackingType TrackingType @map("tracking_type")
  unit         String?      // e.g., "pas", "kcal", "min", "score"
  isSystem     Boolean      @default(false) @map("is_system")
  isActive     Boolean      @default(true) @map("is_active")
  sortOrder    Int          @default(0) @map("sort_order")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  goals   TrackableGoal[]
  entries DailyEntry[]

  @@index([userId])
  @@map("trackable_items")
}

model TrackableGoal {
  id          String        @id @default(uuid())
  trackableId String        @map("trackable_id")
  trackable   TrackableItem @relation(fields: [trackableId], references: [id], onDelete: Cascade)
  targetValue Float         @map("target_value")
  frequency   GoalFrequency
  startDate   DateTime      @default(now()) @map("start_date")
  endDate     DateTime?     @map("end_date")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@map("trackable_goals")
}

model DailyEntry {
  id          String        @id @default(uuid())
  trackableId String        @map("trackable_id")
  trackable   TrackableItem @relation(fields: [trackableId], references: [id], onDelete: Cascade)
  date        DateTime      @db.Date
  value       Float
  notes       String?
  source      String        @default("manual") // "manual" | "health_connect"
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@unique([trackableId, date])
  @@map("daily_entries")
}

model HealthActivity {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id])
  date            DateTime @db.Date
  startTime       DateTime @map("start_time")
  endTime         DateTime @map("end_time")
  activityType    String   @map("activity_type")    // Health Connect exercise type string
  title           String?                             // Custom name if available
  durationMinutes Float    @map("duration_minutes")
  calories        Float?                              // kcal if available
  distance        Float?                              // metres if available
  heartRateAvg    Int?     @map("heart_rate_avg")    // bpm if available
  sourceApp       String?  @map("source_app")        // package name of source app
  hcRecordId      String?  @map("hc_record_id")     // Health Connect record UUID for dedup
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([userId, hcRecordId])
  @@index([userId, date])
  @@map("health_activities")
}

model SyncDevice {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id])
  deviceName String   @map("device_name")
  lastSyncAt DateTime @map("last_sync_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("sync_devices")
}

// ============================================
// PROGRESSIVE OVERLOAD MODELS (Story 2.8)
// ============================================

enum SuggestionType {
  increase_weight
  increase_reps
}

enum SuggestionStatus {
  pending
  accepted
  dismissed
}

model ProgressionSuggestion {
  id             String           @id @default(uuid())
  userId         String           @map("user_id")
  user           User             @relation(fields: [userId], references: [id])
  exerciseId     String           @map("exercise_id")
  exercise       Exercise         @relation(fields: [exerciseId], references: [id])
  sessionId      String           @map("session_id")
  session        WorkoutSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  suggestionType SuggestionType   @map("suggestion_type")
  currentValue   Float            @map("current_value")
  suggestedValue Float            @map("suggested_value")
  reason         String
  status         SuggestionStatus @default(pending)

  createdAt      DateTime         @default(now()) @map("created_at")
  respondedAt    DateTime?        @map("responded_at")

  @@unique([sessionId, exerciseId])
  @@index([userId, exerciseId])
  @@map("progression_suggestions")
}
