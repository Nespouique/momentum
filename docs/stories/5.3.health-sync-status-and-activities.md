# Story 5.3: Endpoints status et activites

## Status: Ready for Review

## Story
**As a** companion Android app and web frontend,
**I want** to check sync status and list synced activities,
**so that** I can display connection state and activity history.

## Acceptance Criteria
1. `GET /health-sync/status` returns sync config for user (last sync, trackables with IDs and goals)
2. `GET /health-sync/activities` returns paginated list of user's health activities
3. Query params `from`, `to`, `activityType`, `limit`, `offset` supported on activities endpoint
4. Endpoints protected by JWT auth
5. Responses follow standard Momentum API format (error codes, pagination with data/total/limit/offset)

## Tasks / Subtasks
- [x] Add Zod query schema for activities endpoint (AC: 3, 5)
  - [x] Add `healthActivitiesQuerySchema` to `src/schemas/health-sync.schema.ts`
  - [x] Use `z.coerce` for query string params (dates, numbers) - same pattern as `sessionQuerySchema` in `session.schema.ts`
  - [x] Define query params: from, to, activityType, limit (default 20), offset (default 0)
  - [x] Export `HealthActivitiesQueryInput` type
- [x] Implement GET /health-sync/status (AC: 1, 4)
  - [x] Add `router.get("/status", ...)` handler to existing `src/routes/health-sync.routes.ts`
  - [x] Add import of `healthActivitiesQuerySchema` from schema file
  - [x] Query latest SyncDevice for the user (orderBy lastSyncAt desc)
  - [x] Query system TrackableItems (isSystem: true) with active goals (endDate: null)
  - [x] Map French trackable names to English response keys via TRACKABLE_KEY_MAP constant
  - [x] Handle case where user has never synced (configured: false, lastSync: null, trackables: {})
- [x] Implement GET /health-sync/activities (AC: 2, 3, 4, 5)
  - [x] Add `router.get("/activities", ...)` handler to existing `src/routes/health-sync.routes.ts`
  - [x] Parse and validate query params with `healthActivitiesQuerySchema`
  - [x] Build Prisma where clause with optional filters (activityType, date range)
  - [x] Query with pagination (take/skip) and ordering by date desc, using Promise.all for data + count
  - [x] Use `select` to return only needed fields (exclude userId, hcRecordId, createdAt, updatedAt)
  - [x] Return `{ data, total, limit, offset }` matching existing session.routes.ts pattern
  - [x] Handle ZodError for invalid query params (400)
- [x] Verify auth middleware applied (AC: 4)
  - [x] Both endpoints inherit from existing `router.use(authMiddleware)` in health-sync.routes.ts

## Dependencies
- Story 5.1: Health Sync Data Schema (Prisma models must exist) - **COMPLETED**
- Story 5.2: Health Sync Endpoint (route file and system trackables logic must exist) - **COMPLETED**

## Dev Notes

### IMPORTANT: Project Context for Fresh Session

**Zod version**: 4.3.5 (NOT v3). Import as `import { z } from "zod"` and `import { ZodError } from "zod"`. The `z.coerce`, `z.infer<>`, and `error.issues` APIs all work in this project. `z.coerce.date()` and `z.coerce.number()` are confirmed working (used in `session.schema.ts`).

**Prisma version**: 7.2.0 with generated client at `src/generated/prisma/`. Import PrismaClient from `../generated/prisma/client.js` (NOT `index.js`).

**Prisma import for singleton**: `import { prisma } from "../lib/prisma.js"` (note `.js` extension for ESM compat).

**Route prefix**: The API has NO `/api/v1` prefix. Routes mount directly (e.g., `/auth`, `/sessions`, `/health-sync`). The PRD references `/api/v1/` but actual Express mounts have no prefix.

**No index.ts changes needed**: Both GET endpoints are sub-routes of the existing `/health-sync` mount in `index.ts` (already set up in Story 5.2). The handler is `router.get("/status", ...)` which becomes `GET /health-sync/status`, and `router.get("/activities", ...)` which becomes `GET /health-sync/activities`.

### Existing Code State (from Story 5.2)

The route file `apps/api/src/routes/health-sync.routes.ts` already contains:
- Imports: `Router`, `Response`, `prisma`, `PrismaClient`, `authMiddleware`, `AuthRequest`, `healthSyncRequestSchema`, `ZodError`
- `PrismaTransactionClient` type alias
- `ErrorCodes` constant (`VALIDATION_ERROR`, `INTERNAL_ERROR`)
- `formatZodError(error: ZodError)` helper function
- `HEALTH_CONNECT_TRACKABLES` constant (4 system trackable definitions)
- `ensureSystemTrackables(tx, userId)` async function
- `router.use(authMiddleware)` applied globally
- `router.post("/", ...)` handler for health data sync
- `export default router`

The schema file `apps/api/src/schemas/health-sync.schema.ts` already contains:
- `dailyMetricSchema`, `sleepStageSchema`, `sleepRecordSchema`, `activityRecordSchema`, `healthSyncRequestSchema`
- All corresponding exported types

**You need to ADD to these files, not create new ones.**

### What to Add to Schema File

Add to `apps/api/src/schemas/health-sync.schema.ts` (after existing schemas, before exports):

```typescript
export const healthActivitiesQuerySchema = z.object({
  from: z.coerce.date().optional(),
  to: z.coerce.date().optional(),
  activityType: z.string().optional(),
  limit: z.coerce.number().int().min(1).max(100).default(20),
  offset: z.coerce.number().int().min(0).default(0),
});

export type HealthActivitiesQueryInput = z.infer<typeof healthActivitiesQuerySchema>;
```

This is the exact same pattern as `sessionQuerySchema` in `session.schema.ts:15-22`.

### What to Add to Route File

Add the import for the new schema at the top of `health-sync.routes.ts`. Change:
```typescript
import { healthSyncRequestSchema } from "../schemas/health-sync.schema.js";
```
To:
```typescript
import { healthSyncRequestSchema, healthActivitiesQuerySchema } from "../schemas/health-sync.schema.js";
```

Then add these two handlers **BEFORE** `export default router;`:

#### GET /status handler

```typescript
// GET /status - Get sync status
router.get("/status", async (req: AuthRequest, res: Response) => {
  try {
    const userId = req.userId!;

    // Get latest sync device for last sync timestamp
    const latestDevice = await prisma.syncDevice.findFirst({
      where: { userId },
      orderBy: { lastSyncAt: "desc" },
    });

    // Get system trackables with their active goals
    const systemTrackables = await prisma.trackableItem.findMany({
      where: { userId, isSystem: true },
      include: {
        goals: {
          where: { endDate: null },
          take: 1,
        },
      },
    });

    // Map French trackable names to English API response keys
    const TRACKABLE_KEY_MAP: Record<string, string> = {
      "Pas": "steps",
      "Calories actives": "activeCalories",
      "Minutes d'activite": "activeMinutes",
      "Durée sommeil": "sleepDuration",
    };

    const trackables: Record<string, { id: string; goalValue: number | null }> = {};
    for (const trackable of systemTrackables) {
      const key = TRACKABLE_KEY_MAP[trackable.name];
      if (key) {
        trackables[key] = {
          id: trackable.id,
          goalValue: trackable.goals[0]?.targetValue ?? null,
        };
      }
    }

    return res.json({
      configured: systemTrackables.length > 0,
      lastSync: latestDevice?.lastSyncAt.toISOString() ?? null,
      trackables,
    });
  } catch (error) {
    console.error("Get health sync status error:", error);
    return res.status(500).json({
      error: {
        code: ErrorCodes.INTERNAL_ERROR,
        message: "An unexpected error occurred",
      },
    });
  }
});
```

#### GET /activities handler

```typescript
// GET /activities - List health activities with pagination and filtering
router.get("/activities", async (req: AuthRequest, res: Response) => {
  try {
    const query = healthActivitiesQuerySchema.parse(req.query);
    const userId = req.userId!;

    // Build where clause
    const where: {
      userId: string;
      activityType?: string;
      date?: { gte?: Date; lte?: Date };
    } = { userId };

    if (query.activityType) {
      where.activityType = query.activityType;
    }

    if (query.from || query.to) {
      where.date = {};
      if (query.from) where.date.gte = query.from;
      if (query.to) where.date.lte = query.to;
    }

    // Query with pagination (same pattern as session.routes.ts)
    const [data, total] = await Promise.all([
      prisma.healthActivity.findMany({
        where,
        orderBy: { date: "desc" },
        skip: query.offset,
        take: query.limit,
        select: {
          id: true,
          date: true,
          startTime: true,
          endTime: true,
          activityType: true,
          title: true,
          durationMinutes: true,
          calories: true,
          distance: true,
          heartRateAvg: true,
          sourceApp: true,
        },
      }),
      prisma.healthActivity.count({ where }),
    ]);

    return res.json({
      data,
      total,
      limit: query.limit,
      offset: query.offset,
    });
  } catch (error) {
    if (error instanceof ZodError) {
      return res.status(400).json({
        error: {
          code: ErrorCodes.VALIDATION_ERROR,
          message: "Validation failed",
          details: formatZodError(error),
        },
      });
    }
    console.error("List health activities error:", error);
    return res.status(500).json({
      error: {
        code: ErrorCodes.INTERNAL_ERROR,
        message: "An unexpected error occurred",
      },
    });
  }
});
```

### Response Formats

#### GET /health-sync/status - Response 200

```json
{
  "configured": true,
  "lastSync": "2026-02-05T08:30:00Z",
  "trackables": {
    "steps": { "id": "uuid", "goalValue": 10000 },
    "activeCalories": { "id": "uuid", "goalValue": 500 },
    "activeMinutes": { "id": "uuid", "goalValue": 90 },
    "sleepDuration": { "id": "uuid", "goalValue": null }
  }
}
```

When user has never synced:
```json
{
  "configured": false,
  "lastSync": null,
  "trackables": {}
}
```

#### GET /health-sync/activities - Response 200

```json
{
  "data": [
    {
      "id": "uuid",
      "date": "2026-02-05",
      "startTime": "2026-02-05T07:00:00Z",
      "endTime": "2026-02-05T08:15:00Z",
      "activityType": "WALKING",
      "title": null,
      "durationMinutes": 75,
      "calories": 320,
      "distance": 5200,
      "heartRateAvg": 125,
      "sourceApp": "com.samsung.android.health"
    }
  ],
  "total": 42,
  "limit": 20,
  "offset": 0
}
```

### Prisma Model References

#### HealthActivity (from schema.prisma)
```
model HealthActivity {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  date            DateTime @db.Date
  startTime       DateTime @map("start_time")
  endTime         DateTime @map("end_time")
  activityType    String   @map("activity_type")
  title           String?
  durationMinutes Float    @map("duration_minutes")
  calories        Float?
  distance        Float?
  heartRateAvg    Int?     @map("heart_rate_avg")
  sourceApp       String?  @map("source_app")
  hcRecordId      String?  @map("hc_record_id")

  @@unique([userId, hcRecordId])
  @@index([userId, date])
}
```

#### SyncDevice (from schema.prisma)
```
model SyncDevice {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  deviceName String   @map("device_name")
  lastSyncAt DateTime @map("last_sync_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
}
```

#### TrackableItem (from schema.prisma)
```
model TrackableItem {
  id           String       @id @default(uuid())
  userId       String       @map("user_id")
  name         String
  icon         String
  color        String
  trackingType TrackingType @map("tracking_type")
  unit         String?
  isSystem     Boolean      @default(false) @map("is_system")
  isActive     Boolean      @default(true) @map("is_active")

  goals   TrackableGoal[]
  entries DailyEntry[]
}
```

#### TrackableGoal (from schema.prisma)
```
model TrackableGoal {
  id          String        @id @default(uuid())
  trackableId String        @map("trackable_id")
  targetValue Float         @map("target_value")
  frequency   GoalFrequency
  startDate   DateTime      @default(now()) @map("start_date")
  endDate     DateTime?     @map("end_date")
}
```

### Testing

**Test Standards:**
- File naming: `*.test.ts` for unit, `*.integration.test.ts` for integration
- No automated test framework is set up in the API currently - all existing routes are tested manually
- All verification is manual via curl/Postman/companion app

**Manual Verification Steps:**

#### GET /health-sync/status
- Returns `{ configured: false, lastSync: null, trackables: {} }` for a user who has never synced
- Returns correct structure after first sync (all 4 trackables with IDs and goal values)
- Returns correct `lastSync` timestamp from most recent SyncDevice
- Returns `goalValue: null` for "sleepDuration" (no default goal)
- Returns 401 for unauthenticated requests

#### GET /health-sync/activities
- Returns empty array `{ data: [], total: 0, limit: 20, offset: 0 }` for user with no activities
- Returns paginated results with correct total count
- Filter by `from` date: only activities on or after that date
- Filter by `to` date: only activities on or before that date
- Filter by `from` + `to`: activities in date range
- Filter by `activityType`: only matching activities returned
- Default limit is 20, default offset is 0
- Custom limit/offset works correctly
- Results ordered by date descending (most recent first)
- Returns 400 for invalid query params (e.g., limit=-1)
- Returns 401 for unauthenticated requests
- User A cannot see User B's activities (userId filter enforced)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial creation | James (Dev) |
| 2026-02-05 | 0.2 | Validation: fixed AC route paths (no /api/v1 prefix), added fresh-session context, added existing code state, fixed Prisma import path, template compliance fixes, added Prisma model references | James (Dev) |
| 2026-02-05 | 0.3 | Pre-impl: renamed "Score sommeil" → "Durée sommeil" (trackingType: duration, unit: min) based on Samsung Health data analysis | James (Dev) |
| 2026-02-05 | 1.0 | Implementation complete: query schema, GET /status, GET /activities. TSC + lint pass. | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
[None]

### Completion Notes List
- Pre-implementation: Renamed "Score sommeil" trackable to "Durée sommeil" (unit: min, trackingType: duration) based on Samsung Health data analysis — Health Connect API provides sleep duration, not a proprietary score
- All 4 tasks implemented, TypeScript compilation passes, lint passes across all workspaces

### File List
- `apps/api/src/schemas/health-sync.schema.ts` — Added `healthActivitiesQuerySchema` and `HealthActivitiesQueryInput` type
- `apps/api/src/routes/health-sync.routes.ts` — Added import of `healthActivitiesQuerySchema`, GET `/status` handler, GET `/activities` handler; pre-impl fix: renamed "Score sommeil" → "Durée sommeil"
- `.gitignore` — Added Samsung Health data export exclusion

## QA Results
[Pending]
