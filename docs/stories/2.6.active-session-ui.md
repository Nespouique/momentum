# Story 2.6: Active Workout Session - UI

## Status: Ready for Review

## Story
**As a** user,
**I want** an optimized interface during my workout with historical comparison,
**so that** I can track my sets efficiently, compare to my previous performance, and manage my exercises flexibly.

## Acceptance Criteria

### Architecture Composants RÃ©utilisables (CRITIQUE)
1. **Composants atomiques** conÃ§us pour Ãªtre rÃ©utilisÃ©s dans les diffÃ©rents Ã©crans :
   - `TimerBlock` : Timer + boutons Â±30s + progress bar + bouton skip
   - `ResultInput` : Objectif affichÃ© + steppers reps/kg pour saisir rÃ©sultat
   - `NextPreview` : Preview de la prochaine sÃ©rie ou exercice avec historique
   - `ExerciseOptionsBar` : Barre Sauter / Reporter / Substituer
   - `SupersetProgress` : Indicateur de tour et progression dans le superset
2. **Pas de duplication de code** entre les Ã©crans exercice standard et superset

### Ã‰cran Exercice en cours (lecture seule)
3. Affichage du nom de l'exercice et groupes musculaires
4. Indicateur de sÃ©rie en cours (ex: "SÃ©rie 2/4" + progress dots â—‹ â— â—‹ â—‹)
5. Bloc comparatif : **Objectif** (reps @ kg) vs **DerniÃ¨re fois** (reps @ kg) avec tendance ğŸ“ˆğŸ“‰â¡ï¸
6. Indication du temps de repos Ã  venir aprÃ¨s la sÃ©rie
7. Bouton large "SÃ‰RIE TERMINÃ‰E" (â‰¥60px) comme unique CTA
8. **Pas de steppers** sur cet Ã©cran (lecture seule)

### Ã‰cran Repos + Saisie rÃ©sultat (aprÃ¨s validation sÃ©rie)
9. `TimerBlock` en haut : timer countdown + Â±30s + progress bar + bouton skip `[ âœ“ ]`
10. `ResultInput` : Objectif affichÃ© + steppers pour saisir actualReps/actualWeight
11. `NextPreview` : Preview de la prochaine sÃ©rie avec objectif et historique
12. Countdown audio : bips Ã  5, 4, 3, 2, 1 secondes, double bip Ã  0
13. Animation visuelle (pulse/couleur) dans les 5 derniÃ¨res secondes

### Ã‰cran Transition exercice (fin d'exercice â†’ prochain)
14. Titre "EXERCICE TERMINÃ‰" + nom de l'exercice complÃ©tÃ©
15. `TimerBlock` identique Ã  l'Ã©cran repos
16. `ResultInput` pour la derniÃ¨re sÃ©rie de l'exercice terminÃ©
17. `NextPreview` : Prochain exercice avec nom, nb sÃ©ries, objectif sÃ©rie 1, historique
18. `ExerciseOptionsBar` : **Uniquement ici** - Sauter / Reporter / Substituer

### Options exercice (uniquement sur Ã©cran transition)
19. **Sauter** : Marque l'exercice comme "skipped", passe au suivant
20. **Reporter** : Ouvre un Ã©cran de rÃ©ordonnancement avec drag & drop (@dnd-kit)
21. **Substituer** : Ouvre ExerciseSelector existant filtrÃ© par groupe musculaire
22. Substitution temporaire pour la session uniquement (ne modifie pas le workout)

### Supersets - Exercice en cours
23. `SupersetProgress` en haut : "SUPERSET Â· Tour X/Y" + liste exercices (âœ“ â— â—‹)
24. MÃªme structure que l'Ã©cran exercice standard (lecture seule)
25. "SÃ‰RIE TERMINÃ‰E" â†’ passe Ã  l'exercice suivant du superset **sans timer**

### Supersets - Repos entre tours
26. `TimerBlock` identique (mÃªme composant)
27. **Plusieurs `ResultInput`** : Un bloc par exercice du tour (3 exercices = 3 blocs)
28. `NextPreview` : AperÃ§u du prochain tour

### Supersets - Transition (fin du superset complet)
29. Titre "SUPERSET TERMINÃ‰ Â· X tours"
30. `TimerBlock` + **plusieurs `ResultInput`** (dernier tour)
31. `NextPreview` + `ExerciseOptionsBar` (mÃªme composants que transition standard)

### Flow Reporter (drag & drop)
32. Ã‰cran plein avec liste des exercices restants
33. PoignÃ©es drag & drop `â‰¡` sur chaque exercice (mÃªme UX que workout builder)
34. Utilise @dnd-kit (composant existant)
35. Bouton "Confirmer" pour valider le nouvel ordre

### Flow Substituer
36. RÃ©utilise `ExerciseSelector` existant du workout builder
37. Groupe musculaire de l'exercice original prÃ©-sÃ©lectionnÃ©
38. Au tap â†’ substitution immÃ©diate, retour Ã  l'Ã©cran transition

### Ã‰crans globaux
39. Page `/session/:id` en mode full-screen (navigation principale masquÃ©e)
40. Header minimal avec titre workout et bouton abandon `âœ•`
41. Bouton "Abandon" avec confirmation (dialog)
42. Wake Lock API pour empÃªcher la mise en veille
43. Session Summary Ã  la fin avec stats et possibilitÃ© d'ajouter des notes

## Tasks / Subtasks

### Composants RÃ©utilisables (PRIORITÃ‰ 1)
- [x] CrÃ©er `TimerBlock` (AC: 9, 15, 26)
  - [x] Props: duration, onComplete, onSkip, onAdjust(Â±30s)
  - [x] Timer countdown avec affichage MM:SS (font JetBrains Mono)
  - [x] Progress bar horizontale
  - [x] Boutons âˆ’30s / +30s proches du timer
  - [x] Bouton skip `[ âœ“ ]` Ã  droite de la progress bar
  - [x] Animation pulse quand < 5s (couleur orange puis rouge)
- [x] CrÃ©er `ResultInput` (AC: 10, 16, 27)
  - [x] Props: exerciseName, targetReps, targetWeight, defaultReps, defaultWeight, onChange
  - [x] Affiche l'objectif en lecture seule
  - [x] Steppers +/- pour reps (step=1) et kg (step=2.5)
  - [x] PrÃ©-rempli avec objectif (modifiable par l'utilisateur)
- [x] CrÃ©er `NextPreview` (AC: 11, 17, 28)
  - [x] Props: type ('set' | 'exercise'), data (sÃ©rie ou exercice suivant), lastSessionData
  - [x] Mode "sÃ©rie" : SÃ©rie X/Y, objectif, derniÃ¨re fois
  - [x] Mode "exercice" : Nom, groupes, nb sÃ©ries, sÃ©rie 1 objectif, historique
  - [x] IcÃ´ne tendance ğŸ“ˆğŸ“‰â¡ï¸
- [x] CrÃ©er `ExerciseOptionsBar` (AC: 18, 31)
  - [x] Props: onSkip, onPostpone, onSubstitute
  - [x] Barre horizontale avec 3 boutons icÃ´ne+texte
  - [x] Sauter â­ / Reporter ğŸ”„ / Changer ğŸ”€
- [x] CrÃ©er `SupersetProgress` (AC: 23)
  - [x] Props: currentRound, totalRounds, exercises[], currentExerciseIndex
  - [x] Affiche "SUPERSET Â· Tour X/Y"
  - [x] Liste des exercices avec Ã©tat (âœ“ fait, â— en cours, â—‹ Ã  faire)

### Ã‰cran Exercice en cours (AC: 3-8)
- [x] CrÃ©er composant `ExerciseActiveScreen`
  - [x] Nom exercice + badges groupes musculaires
  - [x] Progress dots pour les sÃ©ries
  - [x] Bloc comparatif Objectif vs DerniÃ¨re fois (lecture seule)
  - [x] Indication temps de repos Ã  venir
  - [x] Bouton "SÃ‰RIE TERMINÃ‰E" (60px+ hauteur)

### Ã‰cran Repos + Saisie (AC: 9-13)
- [x] CrÃ©er composant `RestScreen`
  - [x] Utilise `TimerBlock`
  - [x] Utilise `ResultInput`
  - [x] Utilise `NextPreview` mode "set"
  - [x] Gestion du countdown audio

### Ã‰cran Transition exercice (AC: 14-18)
- [x] CrÃ©er composant `TransitionScreen`
  - [x] Titre "EXERCICE TERMINÃ‰" + nom
  - [x] Utilise `TimerBlock`
  - [x] Utilise `ResultInput`
  - [x] Utilise `NextPreview` mode "exercise"
  - [x] Utilise `ExerciseOptionsBar`

### Supersets (AC: 23-31)
- [x] Adapter `ExerciseActiveScreen` pour supersets
  - [x] Ajoute `SupersetProgress` en haut
  - [x] GÃ¨re l'enchaÃ®nement sans timer
- [x] CrÃ©er composant `SupersetRestScreen`
  - [x] Utilise `TimerBlock`
  - [x] **Map** sur les exercices pour plusieurs `ResultInput`
  - [x] Utilise `NextPreview`
- [x] CrÃ©er composant `SupersetTransitionScreen`
  - [x] RÃ©utilise les mÃªmes composants que `TransitionScreen`
  - [x] Titre adaptÃ© "SUPERSET TERMINÃ‰ Â· X tours"
  - [x] Plusieurs `ResultInput` pour le dernier tour

### Flow Reporter (AC: 32-35)
- [x] CrÃ©er composant `ReorderExercisesScreen`
  - [x] RÃ©utilise le composant Sortable existant (@dnd-kit)
  - [x] Liste des exercices restants avec poignÃ©es drag
  - [x] Bouton "Confirmer"
  - [x] Appelle PUT /sessions/:id/exercises/reorder

### Flow Substituer (AC: 36-38)
- [x] Adapter `ExerciseSelector` existant
  - [x] Props: preSelectedMuscleGroup, onSelect
  - [x] Appelle POST /sessions/:id/exercises/:id/substitute

### Audio (AC: 12-13)
- [x] CrÃ©er hook `useTimerAudio`
  - [x] Initialise AudioContext au premier "SÃ‰RIE TERMINÃ‰E"
  - [x] Bip court (440Hz, 100ms) Ã  5, 4, 3, 2, 1s
  - [x] Double bip long (880Hz, 300ms Ã— 2) Ã  0s

### Session globale (AC: 39-43)
- [x] CrÃ©er page `app/(session)/session/[id]/page.tsx`
  - [x] Layout full-screen sans bottom nav
  - [x] Header minimal avec titre et bouton abandon
- [x] Wake Lock API
  - [x] Activer au dÃ©marrage
  - [x] RelÃ¢cher Ã  la fin ou abandon
- [x] Dialog abandon avec confirmation
- [x] Session Summary Ã  la fin
  - [x] Stats: durÃ©e, nb sets, volume total
  - [x] Input notes (textarea)
  - [x] Bouton "Terminer" â†’ PATCH status=completed

### State Management
- [x] CrÃ©er Zustand store `useSessionStore`
  - [x] session, currentExerciseIndex, currentSetNumber
  - [x] isResting, restTimeRemaining
  - [x] MÃ©thodes: startSession, completeSet, nextExercise, skipRest, etc.

## Dependencies
- Story 2.5: Workout Session Backend (API endpoints)
- Story 2.3: Workout Program Backend (donnÃ©es workout)
- Story 2.4: Workout Builder UI (ExerciseSelector, Sortable)
- Story 1.3: Shadcn UI & Dark Theme (layout, fonts JetBrains Mono)
- Story 1.5: User Profile Management (composant NumberInput)

## Wireframes & Maquettes

**Document de rÃ©fÃ©rence :** [2.6-wireframes.md](./2.6-wireframes.md)

Ce document contient toutes les maquettes ASCII validÃ©es pour :
- Flow global et flow supersets
- Ã‰cran exercice en cours
- Ã‰cran repos + saisie rÃ©sultat
- Ã‰cran transition exercice
- Flow Reporter (drag & drop)
- Flow Substituer
- Ã‰crans supersets (exercice, repos, transition)
- SpÃ©cifications dÃ©taillÃ©es des composants rÃ©utilisables

## Dev Notes

### IMPORTANT : Architecture Composants

**Objectif : ZÃ‰RO duplication de code entre exercices standards et supersets.**

Tous les Ã©crans doivent Ãªtre composÃ©s Ã  partir des mÃªmes blocs :

```tsx
// Ã‰cran Repos (exercice standard)
<RestScreen>
  <TimerBlock duration={90} onComplete={...} />
  <ResultInput exercise={current} />
  <NextPreview type="set" data={nextSet} />
</RestScreen>

// Ã‰cran Repos (superset - seule diffÃ©rence : plusieurs ResultInput)
<SupersetRestScreen>
  <TimerBlock duration={90} onComplete={...} />
  {supersetExercises.map(ex => (
    <ResultInput key={ex.id} exercise={ex} />
  ))}
  <NextPreview type="set" data={nextRound} />
</SupersetRestScreen>

// Ã‰cran Transition (exercice standard)
<TransitionScreen>
  <TimerBlock duration={120} onComplete={...} />
  <ResultInput exercise={lastSet} />
  <NextPreview type="exercise" data={nextExercise} />
  <ExerciseOptionsBar onSkip={...} onPostpone={...} onSubstitute={...} />
</TransitionScreen>

// Ã‰cran Transition (superset - MÃŠME structure, juste titre et ResultInput multiples)
<SupersetTransitionScreen>
  <TimerBlock duration={120} onComplete={...} />
  {lastRoundExercises.map(ex => (
    <ResultInput key={ex.id} exercise={ex} />
  ))}
  <NextPreview type="exercise" data={nextExercise} />
  <ExerciseOptionsBar onSkip={...} onPostpone={...} onSubstitute={...} />
</SupersetTransitionScreen>
```

### Composants Ã  rÃ©utiliser (existants)

- **NumberInput** (Story 1.5) - Base pour les steppers dans ResultInput
- **ExerciseSelector** (Story 2.4) - Pour la substitution
- **Sortable** (@dnd-kit, Story 2.4) - Pour le rÃ©ordonnancement
- **JetBrains Mono** (Story 1.3) - Pour le timer
- **Dialog, Sheet** - Pour confirmations et flows

### TimerBlock Component

```tsx
interface TimerBlockProps {
  duration: number; // seconds
  onComplete: () => void;
  onSkip: () => void;
  onAdjust: (delta: number) => void; // +30 or -30
  autoStart?: boolean;
}

// Maquette
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚       [ âˆ’30s ]  1:23  [ +30s ]      â”‚
// â”‚                                     â”‚
// â”‚      â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘   [ âœ“ ]    â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ResultInput Component

```tsx
interface ResultInputProps {
  exerciseName: string;
  targetReps: number;
  targetWeight: number | null;
  value: { reps: number; weight: number };
  onChange: (value: { reps: number; weight: number }) => void;
  showObjective?: boolean; // true par dÃ©faut
}

// Maquette
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  SÃ‰RIE 2 TERMINÃ‰E - RÃ‰SULTAT        â”‚
// â”‚  Objectif : 10 reps @ 60kg          â”‚
// â”‚                                     â”‚
// â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”      â”‚
// â”‚   âˆ’  â”‚  10   â”‚  +   â”‚  60   â”‚  +   â”‚
// â”‚      â”‚ reps  â”‚      â”‚  kg   â”‚      â”‚
// â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### NextPreview Component

```tsx
interface NextPreviewProps {
  type: 'set' | 'exercise';
  // Pour type='set'
  setData?: {
    setNumber: number;
    totalSets: number;
    targetReps: number;
    targetWeight: number | null;
    lastReps?: number;
    lastWeight?: number;
  };
  // Pour type='exercise'
  exerciseData?: {
    name: string;
    muscleGroups: string[];
    totalSets: number;
    firstSetTarget: { reps: number; weight: number | null };
    lastFirstSet?: { reps: number; weight: number | null };
  };
}

// Maquette (type='exercise')
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  PROCHAIN EXERCICE                  â”‚
// â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
// â”‚  â”‚  ğŸ‹ï¸ Incline Dumbbell Press      â”‚â”‚
// â”‚  â”‚     pectoraux Â· Ã©paules         â”‚â”‚
// â”‚  â”‚                                 â”‚â”‚
// â”‚  â”‚  3 sÃ©ries Â· SÃ©rie 1: 12 @ 22kg  â”‚â”‚
// â”‚  â”‚  DerniÃ¨re fois: 12 @ 20kg  ğŸ“ˆ   â”‚â”‚
// â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ExerciseOptionsBar Component

```tsx
interface ExerciseOptionsBarProps {
  onSkip: () => void;
  onPostpone: () => void;
  onSubstitute: () => void;
}

// Maquette
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ â­ Sauter â”‚ ğŸ”„ Reporter â”‚ ğŸ”€ Changer â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SupersetProgress Component

```tsx
interface SupersetProgressProps {
  currentRound: number;
  totalRounds: number;
  exercises: Array<{
    id: string;
    name: string;
    status: 'done' | 'current' | 'pending';
  }>;
}

// Maquette
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  ğŸ”„ SUPERSET Â· Tour 2/3             â”‚
// â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
// â”‚  âœ“ Incline Press                    â”‚
// â”‚  â— Lateral Raise   â† en cours       â”‚
// â”‚  â—‹ Face Pull                        â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Web Audio API

```typescript
// CrÃ©er l'AudioContext aprÃ¨s premiÃ¨re interaction utilisateur
let audioContext: AudioContext | null = null;

const initAudio = () => {
  if (!audioContext) {
    audioContext = new AudioContext();
  }
};

const playBeep = (frequency: number, duration: number) => {
  if (!audioContext) return;
  const oscillator = audioContext.createOscillator();
  oscillator.type = 'sine';
  oscillator.frequency.value = frequency;
  oscillator.connect(audioContext.destination);
  oscillator.start();
  oscillator.stop(audioContext.currentTime + duration / 1000);
};

// Countdown
const playCountdownBeep = (secondsRemaining: number) => {
  if (secondsRemaining > 0 && secondsRemaining <= 5) {
    playBeep(440, 100); // Bip court
  } else if (secondsRemaining === 0) {
    playBeep(880, 300); // Bip long
    setTimeout(() => playBeep(880, 300), 350); // Double bip
  }
};

// Appeler initAudio() au clic sur "SÃ‰RIE TERMINÃ‰E" la premiÃ¨re fois
```

### Flow des Ã©crans

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EXERCICE EN     â”‚
â”‚  COURS           â”‚â”€â”€â”€â”€â”€â”€â”
â”‚  (lecture seule) â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
         â”‚                â”‚
         â”‚ Clic "SÃ‰RIE    â”‚
         â”‚ TERMINÃ‰E"      â”‚
         â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  REPOS +         â”‚      â”‚
â”‚  SAISIE RÃ‰SULTAT â”‚      â”‚
â”‚  (TimerBlock +   â”‚      â”‚
â”‚   ResultInput +  â”‚      â”‚
â”‚   NextPreview)   â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
         â”‚                â”‚
         â”‚ Timer=0 ou     â”‚
         â”‚ Skip           â”‚
         â–¼                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
    â”‚ DerniÃ¨re   â”‚        â”‚
    â”‚ sÃ©rie ?    â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
          â”‚               â”‚
    Non   â”‚   Oui         â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”         â”‚
    â”‚           â”‚         â”‚
    â”‚           â–¼         â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚ TRANSITION   â”‚  â”‚
    â”‚   â”‚ EXERCICE     â”‚  â”‚
    â”‚   â”‚ (+ Options)  â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚          â”‚          â”‚
    â”‚          â–¼          â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚ Dernier      â”‚  â”‚
    â”‚   â”‚ exercice ?   â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚          â”‚          â”‚
    â”‚    Non   â”‚   Oui    â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”     â”‚
    â”‚    â”‚          â”‚     â”‚
    â”‚    â”‚          â–¼     â”‚
    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚    â”‚  â”‚ SESSION   â”‚ â”‚
    â”‚    â”‚  â”‚ SUMMARY   â”‚ â”‚
    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚    â”‚                â”‚
    â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     Retour Ã  EXERCICE EN COURS
```

### Zustand Session Store

```typescript
interface SessionState {
  // Ã‰tat
  session: WorkoutSession | null;
  lastSession: WorkoutSession | null; // Pour comparaison historique
  currentExerciseIndex: number;
  currentSetIndex: number;
  isResting: boolean;
  restTimeRemaining: number;

  // Pour supersets
  isInSuperset: boolean;
  supersetRound: number;
  supersetExerciseIndex: number;

  // RÃ©sultats en cours de saisie
  pendingResults: Map<string, { reps: number; weight: number }>;

  // Actions
  startSession: (session: WorkoutSession, lastSession?: WorkoutSession) => void;
  completeSet: (exerciseId: string, setNumber: number, result: { reps: number; weight: number }) => void;
  completeExercise: () => void;
  skipExercise: () => void;
  postponeExercise: () => void;
  substituteExercise: (newExerciseId: string) => void;
  reorderExercises: (exerciseIds: string[]) => void;
  skipRest: () => void;
  adjustRestTime: (delta: number) => void;
  abandonSession: () => void;
  completeSession: (notes?: string) => void;

  // Helpers
  getCurrentExercise: () => SessionExercise | null;
  getNextExercise: () => SessionExercise | null;
  getCurrentSet: () => SessionSet | null;
  getLastSessionSet: (exerciseId: string, setNumber: number) => SessionSet | null;
}
```

### Touch Targets (Mobile)

| Ã‰lÃ©ment | Taille minimale |
|---------|-----------------|
| Bouton "SÃ‰RIE TERMINÃ‰E" | 60px hauteur |
| Steppers +/- | 48Ã—48px |
| Boutons Â±30s | 48Ã—44px |
| Bouton skip [ âœ“ ] | 48Ã—48px |
| Options bar (Sauter/Reporter/Changer) | 56px hauteur |
| Items dans liste drag & drop | 60px hauteur |

## Testing

### Composants rÃ©utilisables
- Tester `TimerBlock` : countdown, Â±30s, skip, animation < 5s
- Tester `ResultInput` : steppers, prÃ©-remplissage, onChange
- Tester `NextPreview` : mode set et mode exercise
- Tester `ExerciseOptionsBar` : callbacks des 3 boutons
- Tester `SupersetProgress` : affichage progression

### Flow exercice standard
- Tester flow complet : Exercice â†’ Repos â†’ Exercice â†’ ... â†’ Transition â†’ Prochain
- Tester saisie rÃ©sultat pendant repos
- Tester skip timer (bouton âœ“)
- Tester Â±30s ajustement

### Flow superset
- Tester enchaÃ®nement A1 â†’ B1 â†’ C1 sans timer
- Tester repos entre tours avec saisie multiple
- Tester transition fin de superset

### Options exercice
- Tester Sauter â†’ exercice marquÃ© skipped
- Tester Reporter â†’ drag & drop â†’ nouvel ordre
- Tester Substituer â†’ ExerciseSelector â†’ nouvel exercice

### Audio
- Tester countdown audio (5, 4, 3, 2, 1, 0)
- Tester que AudioContext nÃ©cessite premiÃ¨re interaction

### Mobile
- Tester Wake Lock
- Tester touch targets (â‰¥48px)
- Tester abandon avec confirmation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
| 2026-01-21 | 0.2 | Refonte complÃ¨te : architecture composants rÃ©utilisables, maquettes validÃ©es, flow supersets, options exercice | PM John & UX Sally |
| 2026-01-21 | 1.0 | Implementation complete | Dev James |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### File List
| File | Action | Description |
|------|--------|-------------|
| `apps/web/src/components/session/timer-block.tsx` | Created | Timer component with Â±30s adjustment, progress bar, skip button |
| `apps/web/src/components/session/result-input.tsx` | Created | Stepper inputs for reps and weight with objective display |
| `apps/web/src/components/session/next-preview.tsx` | Created | Preview component for next set or exercise with trends |
| `apps/web/src/components/session/exercise-options-bar.tsx` | Created | Three-button bar: Sauter, Reporter, Changer |
| `apps/web/src/components/session/superset-progress.tsx` | Created | Superset round progress with exercise status |
| `apps/web/src/components/session/index.ts` | Created | Component exports |
| `apps/web/src/components/session/screens/exercise-active-screen.tsx` | Created | Main exercise display with comparison block |
| `apps/web/src/components/session/screens/rest-screen.tsx` | Created | Timer + result input + next set preview |
| `apps/web/src/components/session/screens/transition-screen.tsx` | Created | Between exercises with options bar |
| `apps/web/src/components/session/screens/superset-rest-screen.tsx` | Created | Rest between superset rounds |
| `apps/web/src/components/session/screens/superset-transition-screen.tsx` | Created | End of superset with multiple result inputs |
| `apps/web/src/components/session/screens/session-summary.tsx` | Created | End of session with stats and notes |
| `apps/web/src/components/session/screens/reorder-exercises-screen.tsx` | Created | Drag & drop exercise reordering |
| `apps/web/src/components/session/screens/index.ts` | Created | Screen exports |
| `apps/web/src/hooks/use-timer-audio.ts` | Created | Web Audio API hook for countdown beeps |
| `apps/web/src/hooks/use-wake-lock.ts` | Created | Wake Lock API hook |
| `apps/web/src/stores/session.ts` | Created | Zustand store for session state management |
| `apps/web/src/lib/api/sessions.ts` | Created | API client for session operations |
| `apps/web/src/app/(session)/layout.tsx` | Created | Full-screen layout without navigation |
| `apps/web/src/app/(session)/session/[id]/page.tsx` | Created | Main session page orchestrating all screens |
| `apps/web/src/components/workouts/exercise-selector.tsx` | Modified | Added initialMuscleGroups and footerMessage props |

### Completion Notes
- All 43 acceptance criteria implemented
- Reusable component architecture with zero duplication between standard and superset flows
- All screens composed from the same building blocks: TimerBlock, ResultInput, NextPreview, etc.
- Session page uses a separate route group `(session)` for full-screen experience
- Wake Lock API prevents screen sleep during active sessions
- Web Audio API plays countdown beeps at 5, 4, 3, 2, 1, 0 seconds
- ExerciseSelector adapted for substitution flow with pre-selected muscle groups
- Store handles complex superset logic and exercise navigation

### Debug Log References
None - implementation completed without major issues
