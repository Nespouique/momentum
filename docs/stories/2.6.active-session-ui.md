# Story 2.6: Active Workout Session - UI

## Status: Draft

## Story
**As a** user,
**I want** an optimized interface during my workout,
**so that** I can log my sets quickly without interrupting my training flow.

## Acceptance Criteria
1. Page `/session/:id` en mode full-screen (navigation principale masquée)
2. Écran Pre-Session avec confirmation avant démarrage
3. Affichage de l'exercice en cours avec nom, groupes musculaires, et objectifs (sets × reps @ poids)
4. Progress dots indiquant la série en cours (○ ● ○ ○)
5. Composant SetInput avec steppers +/- (pas de clavier) pour reps et poids, pré-remplis avec target ou dernière valeur
6. Bouton large "SET DONE" (≥60px) pour valider rapidement
7. Composant SessionTimer : timer de repos plein écran démarrant automatiquement après validation
8. Boutons d'ajustement timer (+30s, -30s) et "Skip"
9. Notification audio (Web Audio API) à la fin du temps de repos
10. Timer inter-exercice si configuré (restAfterExercise)
11. Interface optimisée mobile : gros boutons touch-friendly, ≤3 taps pour logger
12. Wake Lock API pour empêcher la mise en veille de l'écran
13. Bouton "Abandon" avec confirmation (session marquée abandoned)
14. Session Summary à la fin avec stats et possibilité d'ajouter des notes

## Tasks / Subtasks
- [ ] Créer page session (AC: 1)
  - [ ] `app/(app)/session/[id]/page.tsx`
  - [ ] Layout full-screen sans bottom nav
  - [ ] Header minimal avec titre workout et bouton abandon
- [ ] Écran Pre-Session (AC: 2)
  - [ ] Afficher résumé du workout
  - [ ] Liste des exercices prévus
  - [ ] Bouton "Start Session" pour confirmer
  - [ ] POST /sessions au clic
- [ ] Affichage exercice courant (AC: 3, 4)
  - [ ] Nom de l'exercice en grand
  - [ ] Badges groupes musculaires
  - [ ] Target: "4×10 @ 60kg"
  - [ ] Composant ProgressDots pour visualiser les séries
- [ ] Composant SetInput (AC: 5)
  - [ ] Stepper pour reps (boutons - / +)
  - [ ] Stepper pour poids (boutons - / +, step 2.5kg)
  - [ ] Pré-remplir avec target ou dernière valeur connue
  - [ ] Pas de clavier, touch-only
- [ ] Bouton SET DONE (AC: 6)
  - [ ] Bouton primaire très large (min 60px height)
  - [ ] POST /sessions/:id/sets au clic
  - [ ] Feedback visuel (loading, success)
- [ ] Composant SessionTimer (AC: 7, 8, 9)
  - [ ] Timer countdown plein écran
  - [ ] Affichage en gros (font JetBrains Mono, 48-72px)
  - [ ] Progress bar circulaire ou linéaire
  - [ ] Boutons +30s, -30s, Skip
  - [ ] Notification audio via Web Audio API à 0:00
  - [ ] Animation pulse quand < 10s
- [ ] Timer inter-exercice (AC: 10)
  - [ ] Si restAfterExercise > 0, afficher timer entre exercices
  - [ ] Message "Next: {exercice suivant}"
- [ ] Optimisation mobile (AC: 11)
  - [ ] Touch targets ≥ 48px
  - [ ] Zones de tap généreuses
  - [ ] Vérifier ≤3 taps pour logger une série
- [ ] Wake Lock (AC: 12)
  - [ ] Implémenter Wake Lock API
  - [ ] Activer au démarrage de session
  - [ ] Relâcher à la fin ou abandon
  - [ ] Fallback si API non supportée
- [ ] Abandon (AC: 13)
  - [ ] Bouton "✕" ou "Abandon" dans header
  - [ ] Dialog de confirmation
  - [ ] PATCH session status=abandoned
  - [ ] Redirect vers /workouts
- [ ] Session Summary (AC: 14)
  - [ ] Écran final après dernier exercice
  - [ ] Stats: durée, nb sets, volume total
  - [ ] Input notes (textarea optionnel)
  - [ ] Bouton "Finish" → PATCH status=completed
  - [ ] Redirect vers /workouts

## Dev Notes

### Session State Machine
```
Pre-Session → Active (exercice) → Rest Timer → Active (next) → ... → Summary → Done
                    ↓
                 Abandoned
```

### SetInput Component
```tsx
interface SetInputProps {
  targetReps: number;
  targetWeight: number;
  lastReps?: number;
  lastWeight?: number;
  onSubmit: (reps: number, weight: number) => void;
}

// Stepper avec increments
// Reps: ±1
// Weight: ±2.5 (ou ±5 pour gros boutons)
```

### SessionTimer Component
```tsx
interface SessionTimerProps {
  duration: number; // seconds
  onComplete: () => void;
  onSkip: () => void;
  onAdjust: (delta: number) => void;
  autoStart?: boolean;
}
```

### Web Audio API pour notification
```typescript
const playBeep = () => {
  const audioContext = new AudioContext();
  const oscillator = audioContext.createOscillator();
  oscillator.type = 'sine';
  oscillator.frequency.value = 880; // A5
  oscillator.connect(audioContext.destination);
  oscillator.start();
  oscillator.stop(audioContext.currentTime + 0.3);
};
```

### Wake Lock API
```typescript
let wakeLock: WakeLockSentinel | null = null;

const requestWakeLock = async () => {
  try {
    wakeLock = await navigator.wakeLock.request('screen');
  } catch (err) {
    console.log('Wake Lock not supported');
  }
};

const releaseWakeLock = () => {
  wakeLock?.release();
  wakeLock = null;
};
```

### Zustand Session Store
```typescript
interface SessionStore {
  session: WorkoutSession | null;
  currentExerciseIndex: number;
  currentSetNumber: number;
  isResting: boolean;
  restTimeRemaining: number;

  startSession: (session: WorkoutSession) => void;
  completeSet: (set: Set) => void;
  nextExercise: () => void;
  startRest: (duration: number) => void;
  skipRest: () => void;
  abandonSession: () => void;
  completeSession: () => void;
}
```

### UI Layout - Set Input State
```
┌─────────────────────────────────┐
│  ✕ Abandon        Push Day      │
├─────────────────────────────────┤
│                                 │
│      BENCH PRESS                │
│      pecs · triceps · épaules  │
│                                 │
│  ┌───────────────────────────┐ │
│  │   Target: 4×10 @ 60kg     │ │
│  └───────────────────────────┘ │
│                                 │
│   Set 2 of 4                    │
│   ○ ● ○ ○                       │
│                                 │
├─────────────────────────────────┤
│                                 │
│      ┌─────┐    ┌─────┐        │
│   -  │ 10  │ +  │ 60  │  +     │
│      │reps │    │ kg  │        │
│      └─────┘    └─────┘        │
│   -             -               │
│                                 │
├─────────────────────────────────┤
│  ┌─────────────────────────┐   │
│  │                         │   │
│  │    ✓ SET DONE           │   │
│  │                         │   │
│  └─────────────────────────┘   │
│                                 │
└─────────────────────────────────┘
```

### UI Layout - Rest Timer State
```
┌─────────────────────────────────┐
│  ✕ Abandon        Push Day      │
├─────────────────────────────────┤
│                                 │
│           REST                  │
│                                 │
│         ┌───────┐              │
│         │ 1:23  │              │
│         └───────┘              │
│                                 │
│     ▓▓▓▓▓▓▓▓▓▓░░░░░            │
│                                 │
│      Next: INCLINE PRESS        │
│                                 │
├─────────────────────────────────┤
│  ┌─────────────────────────┐   │
│  │    SKIP → NEXT SET      │   │
│  └─────────────────────────┘   │
│                                 │
│     [ +30s ]    [ -30s ]       │
└─────────────────────────────────┘
```

## Testing
- Tester flow complet: Pre-Session → Sets → Rest → Summary
- Tester que le timer démarre automatiquement après SET DONE
- Tester notification audio (nécessite interaction utilisateur d'abord)
- Tester Skip timer
- Tester +30s/-30s
- Tester abandon avec confirmation
- Tester Wake Lock (vérifier dans DevTools)
- Tester sur mobile réel pour touch targets
- Vérifier ≤3 taps pour logger

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
