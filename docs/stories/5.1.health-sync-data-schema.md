# Story 5.1: Schema de donnees Health Sync

## Status: Ready for Review

## Story
**As a** backend developer,
**I want** to add the data models for health sync to the Prisma schema,
**so that** the API can store synced health data.

## Acceptance Criteria
1. Model `TrackableItem` created with fields: id, userId, name, icon, color, trackingType (boolean/number/duration), unit (nullable), isSystem, isActive, createdAt, updatedAt
2. Model `TrackableGoal` created with fields: id, trackableItemId, targetValue, frequency ("daily"|"weekly"), startDate, endDate (nullable), createdAt, updatedAt
3. Model `DailyEntry` created with fields: id, trackableId, date, value, notes (nullable), source ("manual"|"health_connect" with default "manual"), createdAt, updatedAt - with unique constraint on (trackableId, date)
4. Model `HealthActivity` created with ALL fields from PRD section 5.1: id, userId, date, startTime, endTime, activityType, title (nullable), durationMinutes, calories (nullable), distance (nullable), heartRateAvg (nullable), sourceApp (nullable), hcRecordId (nullable), createdAt, updatedAt
5. Model `SyncDevice` created with ALL fields from PRD section 5.1: id, userId, deviceName, lastSyncAt, createdAt
6. User model relations updated with: healthActivities, syncDevices, trackableItems
7. Migration runs without errors
8. Index on `health_activities(user_id, date)` and unique constraint on `(user_id, hc_record_id)`

## Tasks / Subtasks
- [x] Create TrackableItem model (AC: 1)
  - [x] Add TrackingType enum: boolean, number, duration
  - [x] Add fields: id (UUID PK), userId, name, icon, color, trackingType, unit, isSystem, isActive, createdAt, updatedAt
  - [x] Add relation to User
  - [x] Add relations to TrackableGoal and DailyEntry
  - [x] Map to `trackable_items` table
- [x] Create TrackableGoal model (AC: 2)
  - [x] Add GoalFrequency enum: daily, weekly, monthly
  - [x] Add fields: id, trackableId, targetValue, frequency, startDate, endDate, createdAt, updatedAt
  - [x] Add relation to TrackableItem (onDelete: Cascade)
  - [x] Map to `trackable_goals` table
- [x] Create DailyEntry model (AC: 3)
  - [x] Add fields: id, trackableId, date, value, notes, source (default "manual"), createdAt, updatedAt
  - [x] Add unique constraint on (trackableId, date)
  - [x] Add relation to TrackableItem (onDelete: Cascade)
  - [x] Map to `daily_entries` table
- [x] Create HealthActivity model (AC: 4, 8)
  - [x] Add all fields from PRD section 5.1
  - [x] Add unique constraint on (userId, hcRecordId)
  - [x] Add index on (userId, date)
  - [x] Add relation to User
  - [x] Map to `health_activities` table
- [x] Create SyncDevice model (AC: 5)
  - [x] Add fields: id, userId, deviceName, lastSyncAt, createdAt
  - [x] Add index on (userId)
  - [x] Add relation to User
  - [x] Map to `sync_devices` table
- [x] Update User model (AC: 6)
  - [x] Add healthActivities relation
  - [x] Add syncDevices relation
  - [x] Add trackableItems relation
- [x] Run migration (AC: 7)
  - [x] Execute `npx prisma migrate dev --name health-sync-schema`
  - [x] Verify migration SQL is correct
  - [x] Verify Prisma Client regenerated

## Dependencies
- Story 1.2: Database & Prisma Setup (Prisma 7 configuration must exist)

## Dev Notes

### Prisma 7 Configuration (ref Story 1.2)
- Config datasource is in `prisma.config.ts` (not in schema.prisma for Prisma 7)
- Client is generated to `src/generated/prisma/`
- Use `moduleFormat = "cjs"` in the generator
- Import Prisma: `import { prisma } from '../lib/prisma'`

### TrackableItem Model

This model is planned for Epic 3 (Story 3.1) but since Epic 3 is not yet implemented, this story creates it. The model supports both manual trackables (Epic 3) and health-sync trackables (this epic) via the `isSystem` flag.

```prisma
enum TrackingType {
  boolean
  number
  duration
}

model TrackableItem {
  id           String       @id @default(uuid())
  userId       String       @map("user_id")
  user         User         @relation(fields: [userId], references: [id])
  name         String
  icon         String       // Lucide icon name (e.g., "footprints", "flame")
  color        String       // Hex color (e.g., "#22C55E")
  trackingType TrackingType @map("tracking_type")
  unit         String?      // e.g., "pas", "kcal", "min", "score"
  isSystem     Boolean      @default(false) @map("is_system")
  isActive     Boolean      @default(true) @map("is_active")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  goals   TrackableGoal[]
  entries DailyEntry[]

  @@index([userId])
  @@map("trackable_items")
}
// Note: Story 3.1 will later add a `streaks Streak[]` relation to TrackableItem
```

### TrackableGoal Model

```prisma
enum GoalFrequency {
  daily
  weekly
  monthly
}

model TrackableGoal {
  id          String        @id @default(uuid())
  trackableId String        @map("trackable_id")
  trackable   TrackableItem @relation(fields: [trackableId], references: [id], onDelete: Cascade)
  targetValue Float         @map("target_value")
  frequency   GoalFrequency
  startDate   DateTime      @default(now()) @map("start_date")
  endDate     DateTime?     @map("end_date")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@map("trackable_goals")
}
```

### DailyEntry Model with Source Field

The `source` field distinguishes manual entries from health-connect-synced entries. This is critical for the sync logic in Story 5.2 which uses `source = "health_connect"`.

```prisma
model DailyEntry {
  id          String        @id @default(uuid())
  trackableId String        @map("trackable_id")
  trackable   TrackableItem @relation(fields: [trackableId], references: [id], onDelete: Cascade)
  date        DateTime      @db.Date
  value       Float
  notes       String?
  source      String        @default("manual") // "manual" | "health_connect"
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@unique([trackableId, date])
  @@map("daily_entries")
}
```

### HealthActivity Model (PRD section 5.1)

```prisma
model HealthActivity {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id])
  date            DateTime @db.Date
  startTime       DateTime @map("start_time")
  endTime         DateTime @map("end_time")
  activityType    String   @map("activity_type")    // Health Connect exercise type string
  title           String?                             // Custom name if available
  durationMinutes Float    @map("duration_minutes")
  calories        Float?                              // kcal if available
  distance        Float?                              // metres if available
  heartRateAvg    Int?     @map("heart_rate_avg")    // bpm if available
  sourceApp       String?  @map("source_app")        // package name of source app
  hcRecordId      String?  @map("hc_record_id")     // Health Connect record UUID for dedup
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([userId, hcRecordId])
  @@index([userId, date])
  @@map("health_activities")
}
```

### SyncDevice Model (PRD section 5.1)

```prisma
model SyncDevice {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id])
  deviceName    String   @map("device_name")
  lastSyncAt    DateTime @map("last_sync_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("sync_devices")
}
```

### User Model Additions

Add the following relations to the existing User model in `apps/api/prisma/schema.prisma`:

```prisma
model User {
  // ... existing fields and relations ...

  // New relations for Health Sync (Epic 1)
  healthActivities HealthActivity[]
  syncDevices      SyncDevice[]
  trackableItems   TrackableItem[]
}
```

### Migration Command

```bash
npx prisma migrate dev --name health-sync-schema
```

This will:
1. Generate the SQL migration for all new models
2. Apply the migration to the database
3. Regenerate the Prisma Client with the new types

### Convention Checklist
- UUID primary keys: `@id @default(uuid())`
- Snake case column mapping: `@map("snake_case")`
- Table name mapping: `@@map("table_name")`
- Timestamps: `createdAt @default(now()) @map("created_at")` and `updatedAt @updatedAt @map("updated_at")`
- Date-only fields: `@db.Date`
- Relations with `onDelete: Cascade` where appropriate (DailyEntry, TrackableGoal)

### Testing

This is a schema-only story (no business logic). Validation is manual:

**Test Standards:**
- File naming: `*.test.ts` for unit, `*.integration.test.ts` for integration
- No automated tests required for this story (Prisma schema changes only)
- All verification is done via migration execution and Prisma Client generation

**Manual Verification Steps:**
- Verify migration runs without errors on a clean database
- Verify migration runs without errors on an existing database with data
- Verify Prisma Client types are generated correctly for all new models
- Verify unique constraint on `(trackableId, date)` in DailyEntry works (insert duplicate should fail)
- Verify unique constraint on `(userId, hcRecordId)` in HealthActivity works
- Verify index on `(userId, date)` in HealthActivity exists via `EXPLAIN ANALYZE`
- Verify User model relations load correctly with `include: { healthActivities: true, syncDevices: true, trackableItems: true }`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial creation | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
None - migration ran cleanly on first attempt.

### Completion Notes List
- All 5 new models created in single migration
- GoalFrequency enum includes `monthly` (forward-compat with Story 3.1)
- Added `@@index([userId])` on TrackableItem for query performance
- TypeScript compilation verified (`npx tsc --noEmit` passes)

### File List
- `apps/api/prisma/schema.prisma` (modified - added 5 models, 2 enums, 3 User relations)
- `apps/api/prisma/migrations/20260205220218_health_sync_schema/migration.sql` (new)
- `apps/api/src/generated/prisma/` (regenerated)

## QA Results
[Pending]
