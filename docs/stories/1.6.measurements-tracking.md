# Story 1.6: Measurements Tracking

## Status: Ready for Review

## Story
**As a** user,
**I want** to record and view my body measurements over time,
**so that** I can track my physical progress.

## Acceptance Criteria
1. Modèle `Measurement` créé avec champs bilatéraux complets :
   - `userId, date, notes`
   - `weight` (kg)
   - Mesures en cm : `neck, shoulders, chest, bicepsLeft, bicepsRight, forearmLeft, forearmRight, wristLeft, wristRight, waist, hips, thighLeft, thighRight, calfLeft, calfRight, ankleLeft, ankleRight`
2. Endpoints API : `GET /measurements`, `GET /measurements/:id`, `POST /measurements`, `PUT /measurements/:id`, `DELETE /measurements/:id`, `GET /measurements/latest`, `GET /measurements/progress`
3. Page `/profile/measurements` listant l'historique des mensurations (plus récentes en premier)
4. Formulaire d'ajout de mensuration avec date picker et champs optionnels groupés par zone corporelle
5. Possibilité de modifier et supprimer une entrée
6. Affichage des unités (kg, cm)
7. Navigation vers mensurations depuis le profil hub

## Tasks / Subtasks
- [x] Créer modèle Measurement (AC: 1)
  - [x] Créer migration Prisma avec tous les champs
  - [x] Relation avec User (userId)
  - [x] Tous les champs mesure sont optionnels (Float?)
  - [x] Contrainte unique sur (userId, date)
- [x] Créer endpoints CRUD (AC: 2)
  - [x] GET /measurements - liste paginée, triée par date desc
  - [x] GET /measurements/:id - détail d'une mesure
  - [x] POST /measurements - créer nouvelle mesure
  - [x] PUT /measurements/:id - modifier une mesure
  - [x] DELETE /measurements/:id - supprimer une mesure
  - [x] GET /measurements/latest - dernière mesure
  - [x] GET /measurements/progress?field=weight&period=3months
- [x] Créer page liste mensurations (AC: 3)
  - [x] Créer `app/(app)/profile/measurements/page.tsx`
  - [x] Liste avec cards: date, poids, preview des mesures clés
  - [x] Bouton "Ajouter" en haut
  - [x] Tri par date décroissante
- [x] Créer formulaire d'ajout (AC: 4)
  - [x] Page ou modal pour création/édition
  - [x] Date picker pour la date
  - [x] Grouper les champs par zone:
    - Poids
    - Haut du corps (cou, épaules, poitrine)
    - Bras (biceps L/R, avant-bras L/R, poignet L/R)
    - Tronc (taille, hanches)
    - Jambes (cuisse L/R, mollet L/R, cheville L/R)
  - [x] Notes optionnelles
- [x] Actions modifier/supprimer (AC: 5)
  - [x] Bouton edit sur chaque card → formulaire pré-rempli
  - [x] Bouton delete avec confirmation Dialog
  - [x] Optimistic update pour UX fluide
- [x] Affichage unités (AC: 6)
  - [x] Afficher "kg" pour poids, "cm" pour mesures
  - [x] Formater les nombres (1 décimale)
- [x] Navigation (AC: 7)
  - [x] Lien depuis Profile Hub → Measurements
  - [x] Bouton retour vers profil

## Dev Notes

### Prisma Schema
```prisma
model Measurement {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id])
  date          DateTime @db.Date

  // Weight in kg
  weight        Float?

  // Upper body (cm)
  neck          Float?
  shoulders     Float?
  chest         Float?

  // Arms (cm) - bilateral
  bicepsLeft    Float?   @map("biceps_left")
  bicepsRight   Float?   @map("biceps_right")
  forearmLeft   Float?   @map("forearm_left")
  forearmRight  Float?   @map("forearm_right")
  wristLeft     Float?   @map("wrist_left")
  wristRight    Float?   @map("wrist_right")

  // Core (cm)
  waist         Float?
  hips          Float?

  // Legs (cm) - bilateral
  thighLeft     Float?   @map("thigh_left")
  thighRight    Float?   @map("thigh_right")
  calfLeft      Float?   @map("calf_left")
  calfRight     Float?   @map("calf_right")
  ankleLeft     Float?   @map("ankle_left")
  ankleRight    Float?   @map("ankle_right")

  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([userId, date])
  @@map("measurements")
}
```

### API Response Format
```typescript
// GET /measurements/progress?field=weight&period=3months
{
  field: "weight",
  period: "3months",
  data: [
    { date: "2024-01-01", value: 77 },
    { date: "2024-01-08", value: 76.5 },
    { date: "2024-01-15", value: 75.5 }
  ],
  change: -1.5,
  changePercent: -1.95
}
```

### Form Groups UI
```
┌─────────────────────────────┐
│ Date: [    Date Picker    ] │
├─────────────────────────────┤
│ POIDS                       │
│ [  75.5  ] kg               │
├─────────────────────────────┤
│ HAUT DU CORPS               │
│ Cou:      [  38  ] cm       │
│ Épaules:  [ 115  ] cm       │
│ Poitrine: [ 100  ] cm       │
├─────────────────────────────┤
│ BRAS                        │
│ Biceps:   L[ 35 ] R[ 35 ]cm │
│ Avant-bras: L[28] R[28] cm  │
│ Poignet:  L[ 17 ] R[ 17 ]cm │
├─────────────────────────────┤
│ TRONC                       │
│ Taille:   [  82  ] cm       │
│ Hanches:  [  95  ] cm       │
├─────────────────────────────┤
│ JAMBES                      │
│ Cuisse:   L[ 58 ] R[ 58 ]cm │
│ Mollet:   L[ 38 ] R[ 38 ]cm │
│ Cheville: L[ 23 ] R[ 23 ]cm │
├─────────────────────────────┤
│ Notes: [                  ] │
├─────────────────────────────┤
│     [ Sauvegarder ]         │
└─────────────────────────────┘
```

### Calculs dérivés (affichés sur la page Mensurations)

#### IMC (Indice de Masse Corporelle)
L'IMC est calculé à partir du poids (dernière mesure) et de la taille (profil utilisateur).

```typescript
// Formule : IMC = poids (kg) / taille² (m)
function calculateBMI(weight: number | null, heightCm: number | null): number | null {
  if (!weight || !heightCm) return null;
  const heightM = heightCm / 100;  // Conversion cm → mètres
  return weight / (heightM * heightM);
}
```

**Catégories IMC (OMS) :**
| IMC | Catégorie |
|-----|-----------|
| < 18.5 | Insuffisance pondérale |
| 18.5 - 24.9 | Poids normal |
| 25.0 - 29.9 | Surpoids |
| ≥ 30.0 | Obésité |

#### Âge
L'âge est calculé à partir de la date de naissance stockée dans le profil utilisateur.

```typescript
function calculateAge(birthDate: string | null): number | null {
  if (!birthDate) return null;
  const birth = new Date(birthDate);
  const today = new Date();
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
}
```

### Components Shadcn & Custom
- Calendar / DatePicker
- Card
- NumberInput (composant custom avec +/- buttons, créé en 1.5)
- MenuSection (composant custom pour grouper les champs par zone corporelle, créé en 1.5)
- Dialog (pour confirmation delete)
- Collapsible (optionnel, pour grouper les champs)

## Testing
- Tester création d'une mesure avec tous les champs
- Tester création avec seulement le poids
- Tester qu'on ne peut pas créer 2 mesures à la même date
- Tester modification d'une mesure existante
- Tester suppression avec confirmation
- Tester GET /measurements/latest retourne la plus récente
- Tester GET /measurements/progress calcule correctement le changement

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
| 2026-01-18 | 1.0 | Implementation completed | Dev James |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Debug Log References
- None

### Completion Notes
- Created Measurement model with all bilateral body measurement fields
- Prisma migration `add_measurements` applied with unique constraint on (userId, date)
- Full CRUD API endpoints with Zod validation and pagination
- Progress endpoint for tracking changes over time
- Measurements list page with cards showing weight and key measurements
- Add/Edit form page with collapsible sections for body zones (upper body, arms, core, legs)
- Delete confirmation dialog
- Units display (kg for weight, cm for measurements)
- Weight trend indicator showing change from previous measurement
- Shadcn components: Calendar, Popover, Dialog, Collapsible

### File List
| File | Status |
|------|--------|
| apps/api/prisma/schema.prisma | Modified |
| apps/api/prisma/migrations/20260118165537_add_measurements/migration.sql | Created |
| apps/api/src/schemas/measurement.schema.ts | Created |
| apps/api/src/routes/measurement.routes.ts | Created |
| apps/api/src/index.ts | Modified |
| apps/web/src/lib/api/measurements.ts | Created |
| apps/web/src/lib/validations/measurement.ts | Created |
| apps/web/src/app/(app)/profile/measurements/page.tsx | Created |
| apps/web/src/app/(app)/profile/measurements/[id]/page.tsx | Created |
| apps/web/src/components/ui/calendar.tsx | Created |
| apps/web/src/components/ui/popover.tsx | Created |
| apps/web/src/components/ui/dialog.tsx | Created |
| apps/web/src/components/ui/collapsible.tsx | Created |
| apps/web/package.json | Modified |
