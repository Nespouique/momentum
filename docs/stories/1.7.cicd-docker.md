# Story 1.7: CI/CD Pipeline & Production Docker

## Status: Ready for Review

## Story
**As a** developer,
**I want** automated build, test, and deployment pipeline,
**so that** I can deploy reliably to my Proxmox server.

## Acceptance Criteria
1. Dockerfile multi-stage pour frontend (Next.js standalone)
2. Dockerfile pour backend (Express + Prisma)
3. Docker Compose production avec services web, api, postgres
4. GitHub Actions workflow : lint, build, push images to DockerHub
5. Images taguées avec version (git sha ou semver)
6. Variables d'environnement production documentées
7. Health check endpoints (`/health`) sur frontend et backend avec vérification DB
8. README avec instructions de déploiement

## Tasks / Subtasks
- [x] Améliorer health endpoint backend (AC: 7)
  - [x] Ajouter vérification connexion Prisma/DB
  - [x] Retourner status 503 si DB indisponible
- [x] Configurer CORS pour production (AC: 6)
  - [x] Rendre FRONTEND_URL configurable via env
  - [x] Supporter origines multiples (dev + prod)
- [x] Créer Dockerfile frontend (AC: 1)
  - [x] Multi-stage build: deps → builder → runner
  - [x] Utiliser Next.js standalone output (déjà configuré)
  - [x] Gérer le package @momentum/shared du monorepo
  - [x] Optimiser pour taille d'image minimale
  - [x] Exposer port 3000
- [x] Créer Dockerfile backend (AC: 2)
  - [x] Multi-stage build
  - [x] Compiler TypeScript → JavaScript
  - [x] Exécuter prisma generate pour le client
  - [x] Copier schéma Prisma pour runtime
  - [x] Gérer bcrypt (bindings natifs alpine)
  - [x] Exposer port 3001
- [x] Créer Docker Compose production (AC: 3)
  - [x] Service web (frontend) avec healthcheck
  - [x] Service api (backend) avec healthcheck
  - [x] Service postgres avec volume persistant
  - [x] Network interne pour communication
  - [x] Variables d'environnement via .env (incluant FRONTEND_URL)
- [x] Créer GitHub Actions workflow (AC: 4, 5)
  - [x] Trigger: push sur main, pull requests
  - [x] Job: lint (ESLint)
  - [x] Job: build & test
  - [x] Job: build & push Docker images (main only)
  - [x] Utiliser secrets pour DockerHub credentials
  - [x] Tag images avec sha et latest
- [x] Créer health endpoint frontend (AC: 7)
  - [x] Route API /api/health sur Next.js
  - [x] Vérifier que le frontend est opérationnel
- [x] Documentation (AC: 6, 8)
  - [x] Créer `.env.production.example` unifié
  - [x] Documenter toutes les variables requises
  - [x] README section déploiement:
    - Pull images
    - Configuration
    - docker-compose up
    - Nginx Proxy Manager setup

## Dev Notes

### Dockerfile Frontend (Multi-stage - Monorepo)
```dockerfile
# Stage 1: Dependencies
FROM node:20-alpine AS deps
WORKDIR /app
COPY package*.json ./
COPY apps/web/package*.json ./apps/web/
COPY packages/shared/package*.json ./packages/shared/
RUN npm ci

# Stage 2: Builder
FROM node:20-alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
ENV NEXT_TELEMETRY_DISABLED=1
RUN npm run build --workspace=@momentum/web

# Stage 3: Runner
FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
COPY --from=builder /app/apps/web/.next/standalone ./
COPY --from=builder /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=builder /app/apps/web/public ./apps/web/public
USER nextjs
EXPOSE 3000
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"
CMD ["node", "apps/web/server.js"]
```

### Dockerfile Backend (avec Prisma)
```dockerfile
# Stage 1: Builder
FROM node:20-alpine AS builder
WORKDIR /app

# Install OpenSSL for Prisma
RUN apk add --no-cache openssl

COPY package*.json ./
COPY apps/api/package*.json ./apps/api/
COPY packages/shared/package*.json ./packages/shared/
RUN npm ci

COPY . .
RUN npm run build --workspace=@momentum/api

# Stage 2: Runner
FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

# Install OpenSSL for Prisma runtime
RUN apk add --no-cache openssl

# Copy built files
COPY --from=builder /app/apps/api/dist ./dist
COPY --from=builder /app/apps/api/package.json ./
COPY --from=builder /app/apps/api/prisma ./prisma
COPY --from=builder /app/node_modules ./node_modules

EXPOSE 3001
CMD ["node", "dist/index.js"]
```

### Docker Compose Production
```yaml
services:
  web:
    image: ${DOCKERHUB_USERNAME}/momentum-web:latest
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=${API_URL}
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  api:
    image: ${DOCKERHUB_USERNAME}/momentum-api:latest
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=postgresql://momentum:${DB_PASSWORD}@postgres:5432/momentum
      - JWT_SECRET=${JWT_SECRET}
      - FRONTEND_URL=${FRONTEND_URL}
      - NODE_ENV=production
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=momentum
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=momentum
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U momentum"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  postgres_data:
```

### GitHub Actions Workflow
```yaml
name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build

  docker:
    needs: [lint, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push web
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.web
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/momentum-web:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/momentum-web:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push api
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.api
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/momentum-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/momentum-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

### Variables d'environnement production
```bash
# .env.production.example

# Docker Hub
DOCKERHUB_USERNAME=yourusername

# Database
DB_PASSWORD=your-secure-database-password

# API
JWT_SECRET=your-super-secret-jwt-key-min-32-chars

# URLs (adjust to your domain)
FRONTEND_URL=https://momentum.yourdomain.com
API_URL=https://api.momentum.yourdomain.com
```

### Health Check Endpoints
```typescript
// Backend - apps/api/src/index.ts
app.get('/health', async (_req, res) => {
  try {
    await prisma.$queryRaw`SELECT 1`;
    res.json({
      status: 'ok',
      timestamp: new Date().toISOString(),
      database: 'connected'
    });
  } catch (error) {
    res.status(503).json({
      status: 'error',
      timestamp: new Date().toISOString(),
      database: 'disconnected'
    });
  }
});

// Frontend - apps/web/src/app/api/health/route.ts
export async function GET() {
  return Response.json({
    status: 'ok',
    timestamp: new Date().toISOString()
  });
}
```

### CORS Configuration (Production-ready)
```typescript
// apps/api/src/index.ts
const allowedOrigins = process.env.FRONTEND_URL
  ? [process.env.FRONTEND_URL, 'http://localhost:3000']
  : ['http://localhost:3000'];

app.use(cors({
  origin: (origin, callback) => {
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
}));
```

## Testing
- Tester build Docker local des deux images
- Tester docker-compose up démarre les 3 services
- Tester que /health répond 200 sur les deux services
- Tester health endpoint retourne 503 si DB down
- Tester que le workflow GitHub Actions passe sur une PR
- Vérifier que les images sont poussées sur DockerHub après merge

## Dependencies
- Story 1.4: Authentication (pour JWT_SECRET)
- Story 1.6: Measurements (pour les routes API)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
| 2026-01-18 | 0.2 | Updated with monorepo structure, Prisma support, CORS config | Dev |
| 2026-01-18 | 1.0 | Implementation completed | Dev |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Debug Log References
- None

### Completion Notes
- Enhanced backend health endpoint with Prisma DB connection check (returns 503 if DB unavailable)
- Updated CORS config to support FRONTEND_URL environment variable for production
- Created multi-stage Dockerfile for frontend (Next.js standalone)
- Created multi-stage Dockerfile for backend (Express + Prisma with OpenSSL)
- Created production docker-compose with healthchecks and network isolation
- Created GitHub Actions CI/CD workflow with lint, build, and Docker push jobs
- Created frontend health endpoint at /api/health
- Created .env.production.example with all required variables
- Updated README with comprehensive deployment instructions

### File List
| File | Status |
|------|--------|
| apps/api/src/index.ts | Modified (health endpoint + CORS) |
| packages/shared/src/types/index.ts | Modified (HealthCheckResponse type) |
| docker/Dockerfile.web | Created |
| docker/Dockerfile.api | Created |
| docker/docker-compose.prod.yml | Created |
| .github/workflows/ci-cd.yml | Created |
| apps/web/src/app/api/health/route.ts | Created |
| .env.production.example | Created |
| README.md | Modified (deployment section) |
| docs/stories/1.7.cicd-docker.md | Modified |
