# Story 2.7: Session History & Details

## Status: Draft

## Story
**As a** user,
**I want** to view my past workout sessions,
**so that** I can track my training consistency and review my performance.

## Acceptance Criteria
1. Page `/sessions` listant l'historique des sessions (plus récentes en premier)
2. Chaque entrée affiche : date, nom du workout, durée, statut (complété/abandonné)
3. Filtrage par workout type ou date range
4. Page `/sessions/:id` affichant le détail d'une session
5. Détail : liste des exercices avec sets réalisés (reps × poids pour chaque série)
6. Affichage des notes de session si présentes
7. Comparaison visuelle avec les objectifs (target vs réalisé)
8. Possibilité d'ajouter/modifier les notes d'une session passée

## Tasks / Subtasks
- [ ] Mettre à jour la page liste des workouts (`/workouts`)
  - [ ] Afficher la date de dernière exécution au lieu de "Jamais"
  - [ ] Requête API pour récupérer la dernière session par workout
- [ ] Créer page liste sessions (AC: 1, 2)
  - [ ] `app/(app)/sessions/page.tsx`
  - [ ] Fetch avec React Query et pagination
  - [ ] Card pour chaque session: date, workout name, durée, status badge
  - [ ] Infinite scroll ou pagination classique
- [ ] Implémenter filtres (AC: 3)
  - [ ] Dropdown/Select pour filtrer par workout
  - [ ] Date range picker (from/to)
  - [ ] Synchroniser avec query params URL
  - [ ] Appeler API avec filtres
- [ ] Créer page détail session (AC: 4, 5)
  - [ ] `app/(app)/sessions/[id]/page.tsx`
  - [ ] Header avec date, workout name, durée
  - [ ] Liste des exercices réalisés
  - [ ] Pour chaque exercice: liste des sets (set#, reps, poids, RPE si présent)
- [ ] Afficher notes (AC: 6)
  - [ ] Section notes en bas de page si présentes
  - [ ] Style discret mais lisible
- [ ] Comparaison target vs réalisé (AC: 7)
  - [ ] Afficher target à côté des sets réalisés
  - [ ] Indicateur visuel: vert si atteint/dépassé, rouge si en dessous
  - [ ] Calcul: comparer avg reps/weight avec target
- [ ] Édition notes (AC: 8)
  - [ ] Bouton "Edit notes" ou icône crayon
  - [ ] Modal ou inline edit
  - [ ] PATCH /sessions/:id avec nouvelles notes
  - [ ] Toast confirmation

## Dependencies
- Story 2.5: Workout Session Backend (API endpoints historique)
- Story 2.3: Workout Program Backend (nom des workouts)
- Story 1.3: Shadcn UI & Dark Theme (composants de base)
- Story 1.6: Measurements Tracking (patterns pagination, date formatting)

## Dev Notes

### Composants réutilisables de l'Epic 1
- **Card, Button, Dialog, Textarea** - Stories 1.4/1.6
- **Calendar, Popover** - Story 1.6 (pour date range picker)
- **Select** - Story 1.8 (pour filtre workout)
- **Sonner (toasts)** - Story 1.5 (feedback édition notes)

### API Client (ref Story 1.7)
```typescript
// Les appels passent par /backend/
// GET /backend/sessions?status=completed&from=2024-01-01&to=2024-01-31
```

### Date Formatting
Utiliser `date-fns` (déjà installé pour Calendar en Story 1.6):
```typescript
import { format, formatDistanceToNow } from 'date-fns';
import { fr } from 'date-fns/locale';

// "Aujourd'hui, 10:30"
// "Hier, 09:15"
// "15 jan., 11:00"
```

### Sessions List Layout
```
┌─────────────────────────────────┐
│  Session History                │
├─────────────────────────────────┤
│  Workout: [All         ▼]       │
│  From: [01/01/24] To: [31/01]   │
├─────────────────────────────────┤
│  ┌─────────────────────────┐   │
│  │ Today, 10:30            │   │
│  │ Push Day                │   │
│  │ 45 min    ✓ Completed   │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │ Yesterday, 09:15        │   │
│  │ Pull Day                │   │
│  │ 52 min    ✓ Completed   │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │ Jan 15, 11:00           │   │
│  │ Leg Day                 │   │
│  │ 30 min    ✗ Abandoned   │   │
│  └─────────────────────────┘   │
│                                 │
│       [Load more]               │
└─────────────────────────────────┘
```

### Session Detail Layout
```
┌─────────────────────────────────┐
│  ← Back                         │
├─────────────────────────────────┤
│  Push Day                       │
│  Jan 17, 2024 · 45 min          │
│  ✓ Completed                    │
├─────────────────────────────────┤
│  BENCH PRESS                    │
│  Target: 4×10 @ 60kg            │
│  ┌───────────────────────────┐ │
│  │ Set 1: 10 × 60kg    ✓     │ │
│  │ Set 2: 10 × 60kg    ✓     │ │
│  │ Set 3: 9 × 60kg     ↓     │ │
│  │ Set 4: 8 × 60kg     ↓     │ │
│  └───────────────────────────┘ │
├─────────────────────────────────┤
│  INCLINE PRESS                  │
│  Target: 3×12 @ 40kg            │
│  ┌───────────────────────────┐ │
│  │ Set 1: 12 × 40kg   ✓      │ │
│  │ Set 2: 12 × 42.5kg ↑      │ │
│  │ Set 3: 10 × 42.5kg ↓      │ │
│  └───────────────────────────┘ │
├─────────────────────────────────┤
│  NOTES                     ✎   │
│  "Great session, felt strong"   │
└─────────────────────────────────┘
```

### Status Badges
```tsx
const statusStyles = {
  completed: 'bg-green-500/20 text-green-400',
  abandoned: 'bg-red-500/20 text-red-400',
  in_progress: 'bg-yellow-500/20 text-yellow-400',
};
```

### Target Comparison
```tsx
// Compare set with target
const getSetStatus = (set: Set, target: WorkoutExercise) => {
  if (set.reps >= target.targetReps && set.weight >= (target.targetWeight || 0)) {
    return 'achieved'; // ✓ vert
  }
  if (set.reps < target.targetReps || set.weight < (target.targetWeight || 0)) {
    return 'below'; // ↓ rouge
  }
  return 'above'; // ↑ vert foncé
};
```

### React Query
```typescript
// hooks/useSessions.ts
export function useSessions(filters?: SessionFilters) {
  return useInfiniteQuery({
    queryKey: ['sessions', filters],
    queryFn: ({ pageParam = 0 }) =>
      api.get('/sessions', { params: { ...filters, offset: pageParam } }),
    getNextPageParam: (lastPage) =>
      lastPage.data.length < lastPage.limit ? undefined : lastPage.offset + lastPage.limit,
  });
}

export function useSession(id: string) {
  return useQuery({
    queryKey: ['session', id],
    queryFn: () => api.get(`/sessions/${id}`),
  });
}
```

### Duration Formatting
```typescript
const formatDuration = (minutes: number) => {
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return h > 0 ? `${h}h ${m}min` : `${m} min`;
};
```

### Components Shadcn
**Déjà installés:** Card, Button, Dialog, Textarea, Calendar, Popover, Select
**À installer:**
```bash
npx shadcn@latest add badge  # Si pas déjà installé en 2.2
```

## Testing
- Tester liste avec pagination/infinite scroll
- Tester filtrage par workout
- Tester filtrage par date range
- Tester navigation vers détail
- Tester affichage des sets avec comparaison
- Tester édition des notes
- Vérifier les sessions abandonnées s'affichent différemment

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
