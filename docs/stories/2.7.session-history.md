# Story 2.7: Session History & Details

## Status: Ready for Review

## Story
**As a** user,
**I want** to view my past workout sessions,
**so that** I can track my training consistency and review my performance.

## Acceptance Criteria

### Point d'entrÃ©e historique
1. IcÃ´ne `History` en haut de l'Ã©cran `/workouts` (dans PageHeader actions, comme pour les mensurations)
2. Au clic sur l'icÃ´ne, une Sheet s'ouvre avec la liste des sÃ©ances passÃ©es (status=completed)

### Liste des sessions (Sheet)
3. RÃ©utilisation du composant `WorkoutCard` avec `variant="history"` :
   - Nom du workout
   - Date de la session (format relatif : Aujourd'hui, Hier, Il y a X jours)
   - Nombre d'exercices **rÃ©alisÃ©s** (pas prÃ©vus) - comptage des SessionExercise avec au moins 1 set complÃ©tÃ©
   - Groupes musculaires (badges)
   - âŒ Pas de boutons Play et Copy
   - âœ… Bouton Delete pour supprimer une session passÃ©e
4. Tri par date dÃ©croissante (plus rÃ©centes en premier)
5. Scroll dans la Sheet

### DÃ©tail session (au clic sur une carte)
6. Navigation vers Ã©cran de rÃ©cap de la session
7. RÃ©utilisation du composant `SessionSummary` adaptÃ© pour le mode consultation/Ã©dition
8. Header avec : nom du workout, date (non modifiable), durÃ©e
9. Liste des exercices rÃ©alisÃ©s avec leurs sets
10. PossibilitÃ© de **modifier les valeurs** (reps, poids) via `ResultInput`
11. Bouton "Enregistrer les modifications" â†’ `PUT` pour sauvegarder
12. **Ne jamais modifier la date de la session**

## Tasks / Subtasks

### Extraction et adaptation de WorkoutCard
- [x] Extraire `WorkoutCard` dans son propre fichier composant rÃ©utilisable
  - [x] `apps/web/src/components/workouts/workout-card.tsx`
  - [x] Ajouter prop `variant?: 'default' | 'history'`
  - [x] Ajouter prop `completedExerciseCount?: number` pour le mode history
  - [x] Masquer les boutons Play et Copy si `variant='history'`
  - [x] Conserver le bouton Delete dans les deux variantes
  - [x] Utiliser `completedExerciseCount` au lieu du calcul des exercices prÃ©vus si fourni

### Point d'entrÃ©e historique (AC: 1, 2)
- [x] Ajouter icÃ´ne `History` dans PageHeader de `/workouts`
  - [x] Reprendre le pattern de la page mensurations (Story 1.6)
  - [x] State `showHistory` pour toggle la Sheet
- [x] CrÃ©er composant `SessionHistorySheet`
  - [x] Utiliser Sheet de shadcn (`side="bottom"`, `max-h-[85vh]`)
  - [x] Fetch `GET /sessions?status=completed&limit=50`
  - [x] Afficher les cartes avec `WorkoutCard variant="history"`

### Liste des sessions (AC: 3, 4, 5)
- [x] Mapper les donnÃ©es de session vers les props de WorkoutCard
  - [x] Calculer `completedExerciseCount` : count des exercices avec au moins 1 set oÃ¹ `actualReps !== null`
  - [x] Passer la date de session au lieu de `lastCompletedAt`
- [x] ImplÃ©menter la suppression de session
  - [x] Dialog de confirmation
  - [x] Appel `DELETE /sessions/:id`
  - [x] Refresh de la liste aprÃ¨s suppression

### Ã‰cran dÃ©tail/Ã©dition session (AC: 6-12)
- [x] CrÃ©er page `app/(app)/sessions/[id]/page.tsx`
  - [x] Fetch `GET /sessions/:id` avec exercices et sets
  - [x] RÃ©utiliser/adapter `SessionSummary` pour mode consultation
- [x] ImplÃ©menter l'Ã©dition des sets
  - [x] Utiliser `ResultInput` existant
  - [x] Tracker les modifications localement
  - [x] Bouton "Enregistrer" â†’ bulk update des sets modifiÃ©s
  - [x] `PUT /sessions/:id/sets/:setId` pour chaque set modifiÃ©
- [x] Header avec date en lecture seule
  - [x] Afficher la date formatÃ©e mais non Ã©ditable
  - [x] Afficher la durÃ©e de la session

## Dependencies
- Story 2.5: Workout Session Backend (API endpoints historique, DELETE session)
- Story 2.6: Active Session UI (composants `SessionSummary`, `ResultInput`)
- Story 2.4: Workout Builder UI (composant `WorkoutCard` Ã  extraire)
- Story 1.6: Measurements Tracking (pattern icÃ´ne History + Sheet)
- Story 1.3: Shadcn UI & Dark Theme (Sheet, Dialog)

## Dev Notes

### Composants Ã  rÃ©utiliser

#### Pattern History + Sheet (ref Story 1.6 - Mensurations)
```tsx
// RÃ©fÃ©rence : apps/web/src/app/(app)/profile/measurements/page.tsx
// Lignes 370-394 pour l'icÃ´ne History dans PageHeader
// Lignes 531-575 pour la Sheet

// Dans PageHeader actions :
<Button
  variant="ghost"
  size="icon"
  onClick={() => setShowHistory(true)}
>
  <History className="h-4 w-4" />
</Button>

// Sheet :
<Sheet open={showHistory} onOpenChange={setShowHistory}>
  <SheetContent side="bottom" className="max-h-[85vh] flex flex-col">
    <SheetHeader>
      <SheetTitle>Historique des sÃ©ances</SheetTitle>
    </SheetHeader>
    {/* Liste des sessions */}
  </SheetContent>
</Sheet>
```

#### WorkoutCard avec variante (Ã  extraire)
```tsx
// Actuellement dans : apps/web/src/app/(app)/workouts/page.tsx
// Ã€ extraire vers : apps/web/src/components/workouts/workout-card.tsx

interface WorkoutCardProps {
  workout: Workout;
  onEdit: () => void;
  onDelete: () => void;
  onDuplicate?: () => void;   // optionnel (pas utilisÃ© en history)
  onStart?: () => void;       // optionnel (pas utilisÃ© en history)
  startDisabled?: boolean;
  // Props pour variante history
  variant?: 'default' | 'history';
  completedExerciseCount?: number;  // Remplace le calcul des exercices prÃ©vus
  sessionDate?: string;             // Date de la session (au lieu de lastCompletedAt)
}

// Adaptation dans le composant :
{variant !== 'history' && (
  <>
    <Button onClick={onStart}>Play</Button>
    <Button onClick={onDuplicate}>Copy</Button>
  </>
)}
// Le bouton Delete reste visible dans les deux variantes

// Compteur d'exercices :
const displayedExerciseCount = completedExerciseCount ?? exerciseCount;
```

#### SessionSummary (ref Story 2.6)
```tsx
// RÃ©fÃ©rence : apps/web/src/components/session/screens/session-summary.tsx
// RÃ©utiliser pour l'Ã©cran de dÃ©tail/Ã©dition de session passÃ©e

// Le composant gÃ¨re dÃ©jÃ  :
// - Affichage des exercices avec leurs sets
// - ResultInput pour Ã©dition des reps/poids
// - Tracking des modifications locales
// - Callback onComplete avec les modifications
```

### API Endpoints utilisÃ©s

```typescript
// Liste des sessions complÃ©tÃ©es
GET /sessions?status=completed&limit=50

// DÃ©tail d'une session
GET /sessions/:id

// Suppression d'une session
DELETE /sessions/:id

// Modification d'un set (pour l'Ã©dition a posteriori)
PUT /sessions/:id/sets/:setId
Body: { actualReps: number, actualWeight: number }
```

### Calcul du nombre d'exercices rÃ©alisÃ©s

```typescript
// Un exercice est "rÃ©alisÃ©" s'il a au moins 1 set avec actualReps !== null
const completedExerciseCount = session.exercises.filter(ex =>
  ex.sets.some(set => set.actualReps !== null)
).length;
```

### Date Formatting (dÃ©jÃ  existant dans workouts/page.tsx)
```typescript
// RÃ©utiliser formatLastExecutionDate de la page workouts
const formatSessionDate = (dateStr: string): string => {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return "Aujourd'hui";
  if (diffDays === 1) return "Hier";
  if (diffDays < 7) return `Il y a ${diffDays} jours`;
  if (diffDays < 30) {
    const weeks = Math.floor(diffDays / 7);
    return `Il y a ${weeks} semaine${weeks > 1 ? "s" : ""}`;
  }
  return date.toLocaleDateString("fr-FR", { day: "numeric", month: "short" });
};
```

### Maquette Session History Sheet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Historique des sÃ©ances        Ã—    â”‚
â”‚  X sÃ©ances enregistrÃ©es             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Push Day                    ğŸ—‘ï¸ â”‚â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚  â”‚ ğŸ’ª 4 exercices Â· ğŸ“… Aujourd'huiâ”‚â”‚
â”‚  â”‚ [Pectoraux] [Triceps] [Ã‰paules]â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Pull Day                    ğŸ—‘ï¸ â”‚â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚  â”‚ ğŸ’ª 5 exercices Â· ğŸ“… Hier       â”‚â”‚
â”‚  â”‚ [Dos] [Biceps] [Ã‰paules]       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Jambes                      ğŸ—‘ï¸ â”‚â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚  â”‚ ğŸ’ª 3 exercices Â· ğŸ“… Il y a 3j  â”‚â”‚
â”‚  â”‚ [Quadriceps] [Fessiers] [Ischios]â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Composants Shadcn
**DÃ©jÃ  installÃ©s:** Sheet, Button, Dialog
**Rien Ã  installer**

## Testing

### Point d'entrÃ©e
- Tester que l'icÃ´ne History apparaÃ®t dans le header de `/workouts`
- Tester ouverture/fermeture de la Sheet

### Liste des sessions
- Tester affichage des sessions complÃ©tÃ©es (pas les abandonnÃ©es ni en cours)
- Tester le tri par date dÃ©croissante
- Tester le compteur d'exercices rÃ©alisÃ©s (pas prÃ©vus)
- Tester le bouton Delete avec dialog de confirmation
- Tester le refresh de la liste aprÃ¨s suppression

### WorkoutCard variant="history"
- Tester que les boutons Play et Copy sont masquÃ©s
- Tester que le bouton Delete est visible
- Tester l'affichage correct du nombre d'exercices rÃ©alisÃ©s
- Tester l'affichage de la date de session (pas lastCompletedAt)

### DÃ©tail/Ã©dition session
- Tester navigation au clic sur une carte
- Tester affichage des exercices et sets
- Tester modification des reps/poids via ResultInput
- Tester sauvegarde avec PUT
- Tester que la date reste non modifiable

## File List

### Created
- `apps/web/src/components/workouts/workout-card.tsx` - Composant WorkoutCard extrait avec variant history
- `apps/web/src/components/workouts/session-history-sheet.tsx` - Sheet d'historique des sessions
- `apps/web/src/app/(app)/sessions/[id]/page.tsx` - Page de dÃ©tail/Ã©dition de session

### Modified
- `apps/web/src/components/workouts/index.ts` - Ajout exports WorkoutCard et SessionHistorySheet
- `apps/web/src/app/(app)/workouts/page.tsx` - Import WorkoutCard extrait, ajout icÃ´ne History et SessionHistorySheet

## Dev Agent Record

### Agent Model Used
claude-opus-4-5-20251101

### Debug Log References
N/A

### Completion Notes
- TypeScript compilation: âœ… Pass
- ESLint: âœ… Pass
- All acceptance criteria implemented
- WorkoutCard successfully extracted with variant support
- Session history accessible via History icon in workouts page header
- Session detail page allows editing sets with PUT API

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
| 2026-01-24 | 0.2 | Refonte complÃ¨te : point d'entrÃ©e via icÃ´ne History + Sheet, rÃ©utilisation WorkoutCard avec variante, rÃ©utilisation SessionSummary pour Ã©dition | PM John |
| 2026-01-24 | 0.3 | Implementation complete | Dev James |
