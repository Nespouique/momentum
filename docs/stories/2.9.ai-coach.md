# Story 2.9: AI Coach - Conseils personnalisÃ©s

## Status: Ready for Review

## Story
**As a** user experiencing stagnation in my training,
**I want** to receive personalized AI coaching advice to break through plateaus,
**so that** I get intelligent recommendations to adjust my workout targets.

## Context

La story 2.8 implÃ©mente des suggestions automatiques basÃ©es sur des rÃ¨gles simples (+5kg aprÃ¨s 3 sessions rÃ©ussies) et **dÃ©tecte Ã©galement les situations de stagnation** (stabilitÃ© des performances sur plusieurs sÃ©ances consÃ©cutives).

Cette story 2.9 **rÃ©utilise la dÃ©tection de stagnation de la story 2.8** pour proposer une couche d'intelligence artificielle capable de dÃ©bloquer ces plateaux avec des conseils personnalisÃ©s.

**DÃ©clencheur** : Le Coach IA n'est proposÃ© que lorsque la mÃ©canique de stagnation de la story 2.8 dÃ©tecte au moins un exercice en plateau.

## Acceptance Criteria

### DÃ©tection et affichage du bouton (AC: 1-3)
1. Sur la page Session Summary, dÃ©tecter si au moins un exercice est en stagnation
2. Si stagnation dÃ©tectÃ©e, afficher un bouton icÃ´ne "Brain" en haut de la page
3. Le bouton n'apparaÃ®t que si `OPENAI_API_KEY` est configurÃ©e cÃ´tÃ© serveur

### Navigation vers la page Coach IA (AC: 4-5)
4. Au clic sur le bouton, naviguer vers une page dÃ©diÃ©e `/session/[id]/ai-coach`
5. Afficher un Ã©tat de chargement "Analyse des X derniÃ¨res sÃ©ances en cours..."

### Analyse IA (AC: 6-8)
6. Envoyer Ã  l'IA les 10 derniÃ¨res sessions du mÃªme workout (ex: "Jambes")
7. Inclure pour chaque session : exercices, targets, performances rÃ©elles, dates
8. L'IA analyse les tendances et propose des ajustements pour les exercices en stagnation

### Format des propositions (AC: 9-11)
9. Pour chaque exercice en stagnation, afficher :
   - Nom de l'exercice
   - Analyse courte de la situation
   - Proposition d'Ã©volution (nouveau target reps/poids)
   - Justification de la recommandation
10. L'utilisateur peut **ajuster** chaque proposition avant de valider (modifier les valeurs suggÃ©rÃ©es)
11. Ton du coach : motivant, rÃ©aliste, basÃ© sur des principes d'entraÃ®nement

### Actions utilisateur (AC: 12-14)
12. Bouton "Appliquer et terminer" : applique les propositions (ajustÃ©es ou non) au workout template
13. Bouton "Ignorer et terminer" : ferme sans appliquer, retour au dashboard
14. Les modifications sont persistÃ©es dans le workout pour les prochaines sÃ©ances

### Technique (AC: 15-17)
15. Utiliser l'API OpenAI (GPT-4o-mini recommandÃ©)
16. GÃ©rer les erreurs API gracieusement (timeout, quota OpenAI, etc.)
17. Pas de rate limiting applicatif (projet personnel, plafond de dÃ©pense configurÃ© sur OpenAI)

## Tasks / Subtasks

### Configuration (AC: 3, 15)
- [x] Ajouter variable d'environnement `OPENAI_API_KEY` dans `.env` et documentation
- [x] Installer SDK OpenAI (`openai`) dans `apps/api`
- [x] CrÃ©er endpoint health-check pour vÃ©rifier si l'API key est configurÃ©e

### DÃ©tection de stagnation (AC: 1-2)
- [x] **RÃ©utiliser la mÃ©canique de dÃ©tection de stagnation implÃ©mentÃ©e dans la story 2.8**
  - [x] Identifier oÃ¹ cette logique est exposÃ©e (endpoint ou calcul frontend)
  - [x] S'assurer que la liste des exercices en stagnation est accessible pour cette story
- [x] Si nÃ©cessaire, exposer un flag `hasStagnation: boolean` + `stagnatingExerciseIds: string[]` dans la rÃ©ponse session

### Service Backend - AI Coaching (AC: 6-8)
- [x] CrÃ©er service `ai-coaching.service.ts`
  - [x] Fonction `buildWorkoutContext(sessionId)` â†’ rÃ©cupÃ¨re les 10 derniÃ¨res sessions du mÃªme workout
  - [x] Fonction `generateCoachingAdvice(context)` â†’ appelle OpenAI et parse la rÃ©ponse
  - [x] Filtrer uniquement les exercices en stagnation pour l'analyse

### Prompt Engineering (AC: 9, 11)
- [x] CrÃ©er le prompt systÃ¨me (rÃ´le de coach expert musculation)
- [x] DÃ©finir le format de rÃ©ponse JSON structurÃ©
- [x] Inclure dans le prompt : analyse des tendances, propositions concrÃ¨tes (reps/poids)
- [x] Tester et ajuster le ton (motivant, rÃ©aliste)

### Endpoint API (AC: 6, 15, 16)
- [x] `POST /sessions/:id/ai-coaching` - GÃ©nÃ©rer les conseils IA
  - [x] VÃ©rifier que la session appartient Ã  l'utilisateur
  - [x] VÃ©rifier que `OPENAI_API_KEY` est configurÃ©e (sinon 503)
  - [x] Construire le contexte et appeler le service
  - [x] Retourner les propositions structurÃ©es
  - [x] GÃ©rer les erreurs (timeout, quota OpenAI, parsing)

### Endpoint API - Application des suggestions (AC: 12, 14)
- [x] `POST /sessions/:id/apply-coaching` - Appliquer les suggestions au workout
  - [x] Recevoir les propositions (Ã©ventuellement ajustÃ©es par l'utilisateur)
  - [x] Mettre Ã  jour les targets dans le workout template associÃ©
  - [x] Retourner confirmation

### Page AI Coach (AC: 4-5, 9-10)
- [x] CrÃ©er page `/session/[id]/ai-coach/page.tsx`
  - [x] Ã‰tat loading avec message "Analyse des X derniÃ¨res sÃ©ances..."
  - [x] Appel API au montage pour gÃ©nÃ©rer les conseils
  - [x] Affichage des propositions par exercice

### Composant ProposalCard (AC: 9-10)
- [x] CrÃ©er composant pour afficher une proposition d'exercice
  - [x] Nom de l'exercice + badge "stagnation"
  - [x] Analyse courte (texte IA)
  - [x] Champs Ã©ditables pour target reps et target poids
  - [x] Justification de la recommandation

### Actions et navigation (AC: 12-14)
- [x] Bouton "Appliquer et terminer"
  - [x] Appel `POST /sessions/:id/apply-coaching` avec les valeurs (ajustÃ©es ou non)
  - [x] Toast de confirmation
  - [x] Redirection vers dashboard
- [x] Bouton "Ignorer et terminer"
  - [x] Redirection vers dashboard sans action

### IntÃ©gration Session Summary (AC: 1-2)
- [x] Ajouter bouton icÃ´ne "Brain" conditionnel dans `SessionSummary`
- [x] Visible uniquement si stagnation dÃ©tectÃ©e ET API key configurÃ©e
- [x] Navigation vers `/session/[id]/ai-coach` au clic

## UX Specifications

### Principe clÃ© : RÃ©utilisation maximale

La page Coach IA **rÃ©utilise les mÃªmes composants** que la page Session Summary (`ResultInput`, cards exercices, layout) avec une variante pour afficher les propositions IA.

---

### 1. Lien Coach IA dans Session Summary

**Emplacement** : Entre le header ("Jambes â€¢ 0 min") et le premier exercice card

**Type** : Lien texte simple (pas de banner complexe)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”‚              ğŸ†                                     â”‚
â”‚                                                     â”‚
â”‚         SÃ©ance terminÃ©e !                           â”‚
â”‚         Jambes â€¢ 45 min                             â”‚
â”‚                                                     â”‚
â”‚         ğŸ§  Faire appel au coach IA                  â”‚  â† LIEN (visible si stagnation)
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Leg press                                      â”‚â”‚
â”‚  â”‚  3 sÃ©ries complÃ©tÃ©es                            â”‚â”‚
â”‚  â”‚  ...                                            â”‚â”‚
```

**SpÃ©cifications** :
- Style: `text-violet-400 hover:text-violet-300 text-sm font-medium`
- IcÃ´ne: `Brain` (h-4 w-4) Ã  gauche du texte
- Texte: "Faire appel au coach IA"
- Au clic: Navigation vers `/session/[id]/ai-coach`
- **Visible uniquement si** : stagnation dÃ©tectÃ©e ET API key configurÃ©e

---

### 2. Page Coach IA - Ã‰tat Loading

**Route** : `/session/[id]/ai-coach`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Retour                                           â”‚
â”‚                                                     â”‚
â”‚                                                     â”‚
â”‚                                                     â”‚
â”‚              ğŸ§                                      â”‚
â”‚              â—  â—  â—                                   â”‚
â”‚                                                     â”‚
â”‚         Analyse des 10 derniÃ¨res                    â”‚
â”‚         sÃ©ances "Jambes"...                         â”‚
â”‚                                                     â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**SpÃ©cifications** :
- CentrÃ© verticalement
- IcÃ´ne `Brain` avec `animate-pulse`
- Message: "Analyse des X derniÃ¨res sÃ©ances "{workoutName}"..."

---

### 3. Page Coach IA - Ã‰tat SuccÃ¨s

**Design identique Ã  Session Summary** avec :
1. Un texte d'introduction du coach IA
2. Les mÃªmes `ExerciseRecap` cards avec `ResultInput`
3. Les valeurs prÃ©-remplies avec les suggestions IA (au lieu des rÃ©sultats actuels)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Retour                                           â”‚
â”‚                                                     â”‚
â”‚              ğŸ§                                      â”‚
â”‚                                                     â”‚
â”‚         Propositions du Coach                       â”‚
â”‚         Jambes                                      â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ’¡ J'ai analysÃ© tes 10 derniÃ¨res sÃ©ances.       â”‚â”‚
â”‚  â”‚ Voici mes recommandations pour dÃ©bloquer        â”‚â”‚
â”‚  â”‚ ta progression. Tu peux ajuster les valeurs     â”‚â”‚
â”‚  â”‚ avant de valider.                               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Leg press                                      â”‚â”‚
â”‚  â”‚  Nouvel objectif proposÃ©                        â”‚â”‚
â”‚  â”‚                                                 â”‚â”‚
â”‚  â”‚  â‘  â”Œâ”€ REPS â”€â”€â”  â”Œâ”€ KG â”€â”€â”€â”                     â”‚â”‚
â”‚  â”‚     â”‚[-] 8 [+]â”‚  â”‚[-] 85[+]â”‚                    â”‚â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚â”‚
â”‚  â”‚                                                 â”‚â”‚
â”‚  â”‚  â‘¡ â”Œâ”€ REPS â”€â”€â”  â”Œâ”€ KG â”€â”€â”€â”                     â”‚â”‚
â”‚  â”‚     â”‚[-] 8 [+]â”‚  â”‚[-] 85[+]â”‚                    â”‚â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚â”‚
â”‚  â”‚                                                 â”‚â”‚
â”‚  â”‚  â‘¢ â”Œâ”€ REPS â”€â”€â”  â”Œâ”€ KG â”€â”€â”€â”                     â”‚â”‚
â”‚  â”‚     â”‚[-] 8 [+]â”‚  â”‚[-] 85[+]â”‚                    â”‚â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚â”‚
â”‚  â”‚                                                 â”‚â”‚
â”‚  â”‚  ğŸ’¬ "Augmente le poids de 5kg et rÃ©duis Ã  8    â”‚â”‚
â”‚  â”‚  reps pour relancer ta progression."            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Fentes (autre exercice en stagnation)          â”‚â”‚
â”‚  â”‚  ...                                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚        âœ“ Appliquer et terminer                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚         Ignorer et terminer                         â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. Composants rÃ©utilisÃ©s

| Composant existant | Utilisation sur page Coach IA |
|-------------------|-------------------------------|
| `ResultInput` | Affiche les objectifs suggÃ©rÃ©s (prÃ©-remplis par l'IA) |
| `ExerciseRecap` | Card exercice avec ses sÃ©ries |
| Layout Session Summary | MÃªme structure de page |
| `Button` | Actions "Appliquer" / "Ignorer" |

**Variante pour le coach IA** :
- Le sous-titre de l'exercice devient "Nouvel objectif proposÃ©" au lieu de "X sÃ©ries complÃ©tÃ©es"
- Ajouter un bloc de justification IA en bas de chaque card (texte en `text-sm text-zinc-400` avec icÃ´ne ğŸ’¬)

---

### 5. Card Introduction Coach IA

PlacÃ©e en haut, avant les exercices :

```tsx
<div className="rounded-xl bg-violet-950/30 border border-violet-500/20 p-4 mb-4">
  <div className="flex gap-3">
    <Lightbulb className="h-5 w-5 text-violet-400 shrink-0 mt-0.5" />
    <p className="text-sm text-zinc-300">
      J'ai analysÃ© tes 10 derniÃ¨res sÃ©ances. Voici mes recommandations
      pour dÃ©bloquer ta progression. Tu peux ajuster les valeurs avant de valider.
    </p>
  </div>
</div>
```

---

### 6. Justification par exercice

En bas de chaque card exercice, ajouter le conseil personnalisÃ© de l'IA :

```tsx
<div className="px-4 py-3 border-t border-zinc-800/50">
  <div className="flex gap-2">
    <MessageSquare className="h-4 w-4 text-violet-400 shrink-0 mt-0.5" />
    <p className="text-sm text-zinc-400 italic">
      "{justification}"
    </p>
  </div>
</div>
```

---

### 7. Zone d'actions (sticky bottom)

Identique au pattern Session Summary :

```tsx
<div className="sticky bottom-0 pt-4 bg-gradient-to-t from-zinc-950 via-zinc-950/95 to-transparent -mx-4 px-4 pb-2">
  <Button onClick={handleApply} size="xl" className="w-full">
    {isSubmitting ? "Application..." : "âœ“ Appliquer et terminer"}
  </Button>

  <button
    onClick={handleIgnore}
    className="w-full text-center text-sm text-zinc-500 hover:text-zinc-300 py-3 mt-2"
  >
    Ignorer et terminer
  </button>
</div>
```

**Comportements** :
- "Appliquer et terminer" â†’ `POST /sessions/:id/apply-coaching` â†’ Toast succÃ¨s â†’ Dashboard
- "Ignorer et terminer" â†’ Dashboard direct (pas de confirmation)

---

### 8. Ã‰tat Erreur

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Retour                                           â”‚
â”‚                                                     â”‚
â”‚              âš ï¸                                     â”‚
â”‚                                                     â”‚
â”‚         Oups, une erreur est survenue               â”‚
â”‚                                                     â”‚
â”‚         Le coach IA n'a pas pu analyser             â”‚
â”‚         ta sÃ©ance.                                  â”‚
â”‚                                                     â”‚
â”‚         [ RÃ©essayer ]                               â”‚
â”‚                                                     â”‚
â”‚         Retour                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 9. RÃ©sumÃ© des modifications Ã  faire

| Fichier | Modification |
|---------|-------------|
| `SessionSummary` | Ajouter lien "Faire appel au coach IA" conditionnel |
| Nouveau: `AICoachPage` | Page `/session/[id]/ai-coach` avec loading + contenu |
| RÃ©utiliser: `ResultInput` | Tel quel, avec valeurs IA |
| Nouveau: `AIIntroCard` | Card d'introduction violet |
| Adapter: `ExerciseRecap` | Variante avec justification IA en footer |

## Technical Notes

### ModÃ¨le recommandÃ©

- **GPT-4o-mini** : Bon rapport qualitÃ©/prix (~$0.01-0.02/requÃªte) - recommandÃ©
- **GPT-4o** : Meilleure qualitÃ©, plus cher (~$0.05-0.10/requÃªte)

### Endpoints API

| MÃ©thode | Endpoint | Description |
|---------|----------|-------------|
| `GET` | `/config/ai-status` | VÃ©rifie si l'API key est configurÃ©e |
| `POST` | `/sessions/:id/ai-coaching` | GÃ©nÃ¨re les conseils IA (appelle OpenAI) |
| `POST` | `/sessions/:id/apply-coaching` | Applique les suggestions au workout |

### Structure de la requÃªte POST /ai-coaching

```typescript
// Pas de body requis, tout est dÃ©duit du sessionId
// Response:
interface AICoachingResponse {
  sessionId: string;
  workoutName: string;
  analyzedSessionsCount: number;
  proposals: Array<{
    exerciseId: string;
    exerciseName: string;
    analysis: string;           // Texte court d'analyse
    currentTarget: {
      reps: number;
      weight: number | null;
    };
    suggestedTarget: {
      reps: number;
      weight: number | null;
    };
    justification: string;      // Pourquoi cette suggestion
  }>;
}
```

### Structure de la requÃªte POST /apply-coaching

```typescript
interface ApplyCoachingRequest {
  proposals: Array<{
    exerciseId: string;
    targetReps: number;
    targetWeight: number | null;
  }>;
}
```

### Prompt systÃ¨me (draft)

```
Tu es un coach sportif expert en musculation, spÃ©cialisÃ© dans la progression et le dÃ©passement des plateaux.

CONTEXTE:
L'utilisateur a terminÃ© une sÃ©ance et certains exercices montrent une stagnation (performances stables sur plusieurs sÃ©ances).

TON RÃ”LE:
Analyser les donnÃ©es d'entraÃ®nement et proposer des ajustements concrets pour relancer la progression.

TON STYLE:
- Direct et concis (2-3 phrases max par analyse)
- Motivant mais rÃ©aliste
- BasÃ© sur des principes d'entraÃ®nement Ã©prouvÃ©s
- Propositions concrÃ¨tes (valeurs numÃ©riques)

RÃˆGLES:
- Ne propose des changements que pour les exercices en stagnation
- PrivilÃ©gie soit l'augmentation du poids (avec rÃ©duction des reps), soit l'augmentation des reps
- Reste dans des progressions raisonnables (+5-10% max)

Tu dois rÃ©pondre UNIQUEMENT en JSON valide avec le format spÃ©cifiÃ©.
```

## Dependencies

- **Story 2.8 (Progressive Overload)** - rÃ©utilise la mÃ©canique de dÃ©tection de stagnation (stabilitÃ© des performances sur N sessions)
- Package `openai` npm
- Variable d'environnement `OPENAI_API_KEY`

## Risks & Mitigations

| Risque | Mitigation |
|--------|------------|
| CoÃ»t API | Plafond de dÃ©pense configurÃ© sur dashboard OpenAI |
| Temps de rÃ©ponse (5-15s) | Page dÃ©diÃ©e avec Ã©tat de chargement explicite |
| Conseils inadaptÃ©s | Utilisateur peut ajuster les valeurs avant d'appliquer |
| ClÃ© API exposÃ©e | Variable d'environnement cÃ´tÃ© serveur uniquement |
| Erreur parsing JSON | Valider la rÃ©ponse, retry ou message d'erreur |

## Future Enhancements

- Historique des conseils IA consultables
- Choix du "style" de coach (strict, encourageant, technique)
- Suggestions pour exercices alternatifs (variation)
- Analyse de la frÃ©quence d'entraÃ®nement optimale

## Out of Scope

- Rate limiting (projet personnel)
- MonÃ©tisation / abonnement premium
- Persistance des conseils pour consultation ultÃ©rieure
- Choix entre plusieurs modÃ¨les IA

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 0.1 | Initial draft | Dev |
| 2026-02-01 | 0.2 | Refonte specs : trigger sur stagnation, page dÃ©diÃ©e, actions Apply/Ignore, champs ajustables | PM |
| 2026-02-01 | 0.2.1 | Clarification : rÃ©utilisation explicite de la mÃ©canique de stagnation de la story 2.8 | PM |
| 2026-02-01 | 0.3 | UX specs simplifiÃ©es : rÃ©utilisation composants SessionSummary, lien texte simple, ResultInput prÃ©-remplis | UX |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### File List
| File | Action |
|------|--------|
| `apps/api/.env` | Modified - Added OPENAI_API_KEY |
| `apps/api/.env.example` | Modified - Added OPENAI_API_KEY documentation |
| `apps/api/package.json` | Modified - Added openai dependency |
| `apps/api/src/routes/config.routes.ts` | Created - AI status health-check endpoint |
| `apps/api/src/routes/ai-coaching.routes.ts` | Created - AI coaching endpoints |
| `apps/api/src/schemas/ai-coaching.schema.ts` | Created - Zod schemas for AI coaching |
| `apps/api/src/services/ai-coaching.service.ts` | Created - AI coaching service with OpenAI integration |
| `apps/api/src/services/progression.service.ts` | Modified - Added detectStagnatingExercises function |
| `apps/api/src/routes/progression.routes.ts` | Modified - Added stagnation detection endpoint |
| `apps/api/src/index.ts` | Modified - Registered config and AI coaching routes |
| `apps/web/src/lib/api/sessions.ts` | Modified - Added stagnation and AI coaching API functions |
| `apps/web/src/app/(session)/session/[id]/ai-coach/page.tsx` | Created - AI Coach page with proposals |
| `apps/web/src/components/session/screens/session-summary.tsx` | Modified - Added Brain icon link for AI coach |
| `apps/web/src/app/(session)/session/[id]/page.tsx` | Modified - Fetch stagnation info and pass to SessionSummary |

### Debug Log References
N/A

### Completion Notes
- All AI coaching functionality implemented as specified
- Stagnation detection reuses logic from Story 2.8 (countSuccessfulSessions)
- Uses GPT-4o-mini model for cost efficiency with JSON response format
- TypeScript compilation passes for both API and Web
- ESLint passes with no errors
- All acceptance criteria (AC 1-17) implemented
- Error states handled gracefully (API failures, empty proposals, network issues)
- Ready for manual testing by user
