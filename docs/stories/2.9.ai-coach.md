# Story 2.9: AI Coach - Conseils personnalisÃ©s

## Status: Draft

## Story
**As a** user,
**I want** to receive personalized coaching advice from an AI after my workout,
**so that** I get intelligent recommendations beyond simple rule-based suggestions.

## Context

La story 2.8 implÃ©mente des suggestions automatiques basÃ©es sur des rÃ¨gles simples (+5kg aprÃ¨s 3 sessions rÃ©ussies). Cette story ajoute une couche d'intelligence artificielle pour des conseils plus nuancÃ©s et contextuels.

## Acceptance Criteria

### Bouton d'accÃ¨s au Coach IA
1. Sur la page de rÃ©sumÃ© de sÃ©ance (Session Summary), afficher un bouton "Conseils du Coach IA"
2. Le bouton est visible uniquement si la fonctionnalitÃ© est activÃ©e (clÃ© API configurÃ©e)
3. Indiquer visuellement que c'est une fonctionnalitÃ© "premium" ou "beta"

### Analyse IA
4. L'IA analyse l'ensemble de la sÃ©ance (tous les exercices)
5. L'IA a accÃ¨s Ã  :
   - Historique des 10 derniÃ¨res sessions pour ce workout
   - Targets actuels et performances rÃ©elles
   - Progressions acceptÃ©es/refusÃ©es
   - Profil utilisateur (frÃ©quence, objectif, expÃ©rience)
6. L'IA dÃ©tecte :
   - Tendances de progression (rapide, lente, plateau)
   - DÃ©sÃ©quilibres entre groupes musculaires
   - Signes de fatigue ou surmenage
   - Exercices qui stagnent

### Format des conseils
7. Pour chaque exercice pertinent, l'IA fournit :
   - Analyse de la performance rÃ©cente
   - Recommandation (nouveau target ou conseil)
   - Justification de la recommandation
   - Astuce pratique (tempo, technique, variation)
8. RÃ©sumÃ© global de la sÃ©ance avec conseils gÃ©nÃ©raux
9. Ton motivant mais rÃ©aliste (coach sportif expert)

### Affichage des conseils
10. Afficher les conseils dans un drawer/modal dÃ©diÃ©
11. Format lisible avec sections par exercice
12. PossibilitÃ© de fermer et revenir plus tard
13. Ã‰tat de chargement pendant l'analyse (5-15 secondes)

### Technique
14. Utiliser l'API OpenAI (GPT-4o-mini par dÃ©faut)
15. Stocker les conseils gÃ©nÃ©rÃ©s pour consultation ultÃ©rieure (optionnel)
16. GÃ©rer les erreurs API gracieusement
17. Limiter Ã  X appels par jour/mois (anti-abus)

## Tasks / Subtasks

### Configuration (AC: 2, 14)
- [ ] Ajouter variable d'environnement `OPENAI_API_KEY`
- [ ] Installer SDK OpenAI (`openai`)
- [ ] CrÃ©er config pour activer/dÃ©sactiver la fonctionnalitÃ©

### Service Backend (AC: 4, 5, 6)
- [ ] CrÃ©er service `ai-coaching.service.ts`
  - [ ] Fonction `buildSessionContext(sessionId)` â†’ construit le JSON de contexte
  - [ ] Fonction `getAICoachingAdvice(sessionId)` â†’ appelle OpenAI et retourne les conseils
  - [ ] RÃ©cupÃ©rer historique des 10 derniÃ¨res sessions du workout
  - [ ] RÃ©cupÃ©rer les suggestions acceptÃ©es/refusÃ©es rÃ©centes
  - [ ] Formater les donnÃ©es pour le prompt

### Prompt Engineering (AC: 7, 8, 9)
- [ ] CrÃ©er le prompt systÃ¨me (rÃ´le de coach expert)
- [ ] DÃ©finir le format de rÃ©ponse attendu (JSON structurÃ©)
- [ ] Tester et itÃ©rer sur la qualitÃ© des rÃ©ponses
- [ ] Ajouter des exemples few-shot si nÃ©cessaire

### Endpoint API (AC: 4, 14, 16)
- [ ] GET `/sessions/:id/ai-coaching` - Obtenir les conseils IA
  - [ ] VÃ©rifier que la session appartient Ã  l'utilisateur
  - [ ] VÃ©rifier que la clÃ© API est configurÃ©e
  - [ ] Appeler le service et retourner les conseils
  - [ ] GÃ©rer les erreurs (timeout, quota, etc.)

### Composant UI (AC: 1, 3, 10, 11, 12, 13)
- [ ] CrÃ©er composant `AICoachButton`
  - [ ] Bouton avec icÃ´ne (Sparkles ou Brain)
  - [ ] Badge "Beta" ou "IA"
  - [ ] Ã‰tat disabled si fonctionnalitÃ© non disponible
- [ ] CrÃ©er composant `AICoachingDrawer` ou `AICoachingModal`
  - [ ] Header avec titre et bouton fermer
  - [ ] Ã‰tat de chargement avec message d'attente
  - [ ] Affichage structurÃ© des conseils par exercice
  - [ ] Section rÃ©sumÃ© global
  - [ ] Style cohÃ©rent avec le reste de l'app

### IntÃ©gration Session Summary (AC: 1, 2)
- [ ] Ajouter `AICoachButton` dans `SessionSummary`
- [ ] GÃ©rer l'ouverture du drawer/modal
- [ ] Passer le sessionId au composant

### Rate Limiting (AC: 17)
- [ ] ImplÃ©menter limitation cÃ´tÃ© backend
  - [ ] Max X appels par utilisateur par jour
  - [ ] Retourner erreur explicite si quota atteint
- [ ] Afficher message cÃ´tÃ© frontend si quota atteint

## UX Specifications

### Wireframe - Bouton Coach IA dans Session Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Retour                                           â”‚
â”‚                                                     â”‚
â”‚  ğŸ‹ï¸ Jambes                                          â”‚
â”‚  DurÃ©e: 45 min                                      â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  âœ¨ Conseils du Coach IA              Beta  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Leg press                                   â”‚   â”‚
â”‚  â”‚  3 sÃ©ries complÃ©tÃ©es                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ“ˆ Progression disponible              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  10kg â†’ 15kg                            â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  [Ignorer]  [Appliquer]                 â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  [       Terminer la sÃ©ance       ]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Wireframe - Drawer Conseils IA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     â”‚
â”‚                                                     â”‚
â”‚  âœ¨ Conseils du Coach IA                       âœ•   â”‚
â”‚                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                     â”‚
â”‚  ğŸ‹ï¸ LEG PRESS                                       â”‚
â”‚                                                     â”‚
â”‚  **Analyse**: Tu as progressÃ© de 7kg Ã  12kg        â”‚
â”‚  rÃ©cemment, excellente progression !                â”‚
â”‚                                                     â”‚
â”‚  **Recommandation**: Maintenir 12kg encore         â”‚
â”‚  2-3 sÃ©ances avant d'augmenter.                    â”‚
â”‚                                                     â”‚
â”‚  **Conseil**: Concentre-toi sur le tempo           â”‚
â”‚  (3s descente) pour maximiser la tension.          â”‚
â”‚                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                     â”‚
â”‚  ğŸ¦µ FENTES                                          â”‚
â”‚                                                     â”‚
â”‚  **Analyse**: Progression rapide de 10 Ã  14 reps.  â”‚
â”‚  Attention Ã  ne pas brÃ»ler les Ã©tapes.             â”‚
â”‚                                                     â”‚
â”‚  **Recommandation**: Rester Ã  14 reps et ajouter   â”‚
â”‚  du poids (haltÃ¨res 2-4kg) si tu veux progresser.  â”‚
â”‚                                                     â”‚
â”‚  **Conseil**: Assure-toi que le genou arriÃ¨re      â”‚
â”‚  touche presque le sol Ã  chaque rep.               â”‚
â”‚                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                     â”‚
â”‚  ğŸ“Š RÃ‰SUMÃ‰ GLOBAL                                   â”‚
â”‚                                                     â”‚
â”‚  Excellente sÃ©ance ! Tu montres une bonne          â”‚
â”‚  progression sur les quadriceps. Pense Ã            â”‚
â”‚  Ã©quilibrer avec plus de travail sur les           â”‚
â”‚  ischios la prochaine fois.                        â”‚
â”‚                                                     â”‚
â”‚  Prochaine sÃ©ance: Focus sur le tempo et la        â”‚
â”‚  connexion muscle-esprit.                          â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ã‰tats du bouton

| Ã‰tat | Apparence |
|------|-----------|
| Disponible | Bouton actif avec icÃ´ne âœ¨ et badge "Beta" |
| Chargement | Bouton dÃ©sactivÃ© avec spinner |
| Non configurÃ© | Bouton grisÃ© ou masquÃ© |
| Quota atteint | Bouton grisÃ© avec tooltip "Limite atteinte" |

### Ã‰tats du drawer

| Ã‰tat | Contenu |
|------|---------|
| Chargement | "Le coach analyse ta sÃ©ance..." avec animation |
| SuccÃ¨s | Conseils structurÃ©s par exercice |
| Erreur | Message d'erreur avec bouton "RÃ©essayer" |

## Technical Notes

### ModÃ¨le recommandÃ©

- **GPT-4o-mini** : Bon rapport qualitÃ©/prix (~$0.01-0.02/requÃªte)
- **GPT-4o** : Meilleure qualitÃ©, plus cher (~$0.05-0.10/requÃªte)

### Structure de la rÃ©ponse IA (JSON)

```typescript
interface AICoachingResponse {
  exercises: Array<{
    name: string;
    analysis: string;
    recommendation: string;
    tip: string;
    suggestedTarget?: {
      reps?: number;
      weight?: number;
    };
  }>;
  globalSummary: string;
  nextSessionFocus: string;
}
```

### Prompt systÃ¨me (draft)

```
Tu es un coach sportif expert en musculation et en programmation d'entraÃ®nement.
Ton rÃ´le est d'analyser les performances de l'utilisateur et de fournir des conseils personnalisÃ©s.

Ton style:
- Motivant mais rÃ©aliste
- BasÃ© sur des principes scientifiques
- AdaptÃ© au niveau de l'utilisateur
- Concis et actionnable

Tu dois rÃ©pondre en JSON avec le format suivant: ...
```

## Dependencies

- Story 2.8 (Progressive Overload) - pour les donnÃ©es de base
- Package `openai` npm

## Risks & Mitigations

| Risque | Mitigation |
|--------|------------|
| CoÃ»t API Ã©levÃ© | Rate limiting + modÃ¨le Ã©conomique (4o-mini) |
| Temps de rÃ©ponse lent | Ã‰tat de chargement + cache des rÃ©ponses |
| Conseils incorrects | Disclaimer "conseils IA, consultez un professionnel" |
| ClÃ© API exposÃ©e | Variable d'environnement cÃ´tÃ© serveur uniquement |

## Future Enhancements

- Historique des conseils IA consultables
- Choix du "style" de coach (strict, encourageant, technique)
- IntÃ©gration avec d'autres donnÃ©es (sommeil, nutrition si disponibles)
- GÃ©nÃ©ration de programmes personnalisÃ©s

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 0.1 | Initial draft | Dev |
