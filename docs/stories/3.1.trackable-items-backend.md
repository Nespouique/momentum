# Story 3.1: Trackable Items - Data Model & Backend

## Status: Draft

## Story
**As a** developer,
**I want** a flexible system for user-defined trackable items,
**so that** users can configure what habits they want to track with their goals.

## Acceptance Criteria
1. Modèle `TrackableItem` créé (id, userId, name, icon, color, trackingType: boolean/number/duration, unit nullable, isActive, createdAt)
2. Modèle `TrackableGoal` créé (id, trackableId, targetValue, frequency: daily/weekly/monthly, startDate, endDate nullable)
3. Types : `boolean` (checkbox), `number` (valeur numérique), `duration` (minutes)
4. Endpoints : `GET /trackables`, `GET /trackables/:id`, `POST /trackables`, `PUT /trackables/:id`, `DELETE /trackables/:id`
5. Endpoints goals : `POST /trackables/:id/goals`, `PUT /trackables/:id/goals/:goalId`
6. Seed avec items par défaut désactivés (suggestions : yoga, steps, méditation, lecture, side-project)
7. Un trackable spécial "workout" créé automatiquement et lié aux sessions de l'Epic 2 (non supprimable)

## Tasks / Subtasks
- [ ] Créer modèle TrackableItem (AC: 1)
  - [ ] Migration Prisma
  - [ ] Enum trackingType: boolean, number, duration
  - [ ] Champ color pour personnalisation
  - [ ] Champ icon (nom d'icône Lucide)
  - [ ] Relation avec User
- [ ] Créer modèle TrackableGoal (AC: 2)
  - [ ] Migration Prisma
  - [ ] Enum frequency: daily, weekly, monthly
  - [ ] Relation avec TrackableItem
  - [ ] Dates de validité (startDate, endDate nullable)
- [ ] Créer endpoints CRUD trackables (AC: 4)
  - [ ] GET /trackables - liste des trackables de l'utilisateur
  - [ ] GET /trackables/:id - détail avec goal actif
  - [ ] POST /trackables - créer nouveau trackable
  - [ ] PUT /trackables/:id - modifier trackable
  - [ ] DELETE /trackables/:id - supprimer (sauf workout)
- [ ] Créer endpoints goals (AC: 5)
  - [ ] POST /trackables/:id/goals - définir nouvel objectif
  - [ ] PUT /trackables/:id/goals/:goalId - modifier objectif
  - [ ] Logique: un seul goal actif par trackable (endDate null)
- [ ] Créer seed data (AC: 6)
  - [ ] Créer trackables par défaut pour nouveaux users
  - [ ] Yoga (boolean), Steps (number, unit: pas), Méditation (duration)
  - [ ] Lecture (duration), Side-project (boolean)
  - [ ] Tous isActive: false par défaut
- [ ] Trackable workout spécial (AC: 7)
  - [ ] Créer automatiquement à la création de l'utilisateur
  - [ ] Type: number (compte les sessions)
  - [ ] Non supprimable (validation dans DELETE)
  - [ ] Calculé depuis les WorkoutSessions

## Dev Notes

### Prisma Schema
```prisma
enum TrackingType {
  boolean
  number
  duration
}

enum GoalFrequency {
  daily
  weekly
  monthly
}

model TrackableItem {
  id           String       @id @default(uuid())
  userId       String       @map("user_id")
  user         User         @relation(fields: [userId], references: [id])
  name         String
  icon         String       // Lucide icon name
  color        String       // Hex color
  trackingType TrackingType @map("tracking_type")
  unit         String?      // e.g., "pas", "minutes"
  isActive     Boolean      @default(true) @map("is_active")
  isSystem     Boolean      @default(false) @map("is_system") // Pour workout
  createdAt    DateTime     @default(now()) @map("created_at")

  goals   TrackableGoal[]
  entries DailyEntry[]
  streaks Streak[]

  @@map("trackable_items")
}

model TrackableGoal {
  id          String        @id @default(uuid())
  trackableId String        @map("trackable_id")
  trackable   TrackableItem @relation(fields: [trackableId], references: [id], onDelete: Cascade)
  targetValue Float         @map("target_value")
  frequency   GoalFrequency
  startDate   DateTime      @map("start_date")
  endDate     DateTime?     @map("end_date")

  @@map("trackable_goals")
}
```

### API Endpoints

```typescript
// GET /trackables
Response: {
  data: [
    {
      id: string;
      name: string;
      icon: string;
      color: string;
      trackingType: 'boolean' | 'number' | 'duration';
      unit: string | null;
      isActive: boolean;
      isSystem: boolean;
      activeGoal: TrackableGoal | null;
    }
  ]
}

// POST /trackables
Request: {
  name: string;
  icon: string;
  color: string;
  trackingType: 'boolean' | 'number' | 'duration';
  unit?: string;
}

// POST /trackables/:id/goals
Request: {
  targetValue: number;
  frequency: 'daily' | 'weekly' | 'monthly';
}
// Note: startDate = now, termine le goal précédent (set endDate)
```

### Default Trackables (Seed)
```typescript
const defaultTrackables = [
  { name: 'Yoga', icon: 'heart', color: '#8B5CF6', trackingType: 'boolean' },
  { name: 'Pas', icon: 'footprints', color: '#22C55E', trackingType: 'number', unit: 'pas' },
  { name: 'Méditation', icon: 'brain', color: '#3B82F6', trackingType: 'duration', unit: 'min' },
  { name: 'Lecture', icon: 'book', color: '#F59E0B', trackingType: 'duration', unit: 'min' },
  { name: 'Side-project', icon: 'code', color: '#EC4899', trackingType: 'boolean' },
];

// Workout (système, toujours créé)
const workoutTrackable = {
  name: 'Workout',
  icon: 'dumbbell',
  color: '#EF4444',
  trackingType: 'number',
  unit: 'sessions',
  isSystem: true,
  isActive: true,
};
```

### Validation Rules
- Ne pas supprimer trackable si isSystem = true
- Un seul goal actif par trackable (endDate null)
- Lors de création nouveau goal, fermer le précédent
- trackingType ne peut pas être modifié après création

### Goal Logic
```typescript
async createGoal(trackableId: string, data: CreateGoalInput) {
  // Fermer le goal actif actuel
  await prisma.trackableGoal.updateMany({
    where: { trackableId, endDate: null },
    data: { endDate: new Date() },
  });

  // Créer le nouveau goal
  return prisma.trackableGoal.create({
    data: {
      trackableId,
      targetValue: data.targetValue,
      frequency: data.frequency,
      startDate: new Date(),
    },
  });
}
```

## Testing
- Tester création trackable avec tous les types
- Tester que workout est créé automatiquement pour nouveau user
- Tester DELETE sur trackable système → erreur
- Tester création goal ferme le précédent
- Tester GET inclut activeGoal
- Tester modification trackable (sauf trackingType)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
