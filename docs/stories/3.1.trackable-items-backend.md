# Story 3.1: Trackable Items - Data Model & Backend

## Status: Done

## Story
**As a** developer,
**I want** a flexible system for user-defined trackable items,
**so that** users can configure what habits they want to track with their goals.

## Acceptance Criteria
1. Modèle `TrackableItem` créé (id, userId, name, icon, color, trackingType: boolean/number/duration, unit nullable, isActive, createdAt)
2. Modèle `TrackableGoal` créé (id, trackableId, targetValue, frequency: daily/weekly/monthly, startDate, endDate nullable)
3. Types : `boolean` (checkbox), `number` (valeur numérique), `duration` (minutes)
4. Endpoints : `GET /trackables`, `GET /trackables/:id`, `POST /trackables`, `PUT /trackables/:id`, `DELETE /trackables/:id`
5. Endpoints goals : `POST /trackables/:id/goals`, `PUT /trackables/:id/goals/:goalId`
6. Seed avec items par défaut désactivés (suggestions : yoga, steps, méditation, lecture, side-project)
7. Un trackable spécial "workout" créé automatiquement et lié aux sessions de l'Epic 2 (non supprimable)

## Tasks / Subtasks
- [x] Créer modèle TrackableItem (AC: 1)
  - [x] Migration Prisma (20260213230015_add_trackable_sort_order)
  - [x] Enum trackingType: boolean, number, duration
  - [x] Champ color pour personnalisation
  - [x] Champ icon (nom d'icône Lucide)
  - [x] Relation avec User
  - [x] Champ sortOrder ajouté pour réordonnancement
- [x] Créer modèle TrackableGoal (AC: 2)
  - [x] Migration Prisma
  - [x] Enum frequency: daily, weekly, monthly
  - [x] Relation avec TrackableItem
  - [x] Dates de validité (startDate, endDate nullable)
- [x] Créer endpoints CRUD trackables (AC: 4)
  - [x] GET /trackables - liste des trackables de l'utilisateur
  - [x] POST /trackables - créer nouveau trackable
  - [x] PATCH /trackables/:id - modifier trackable
  - [x] DELETE /trackables/:id - supprimer (sauf system)
  - [x] PUT /trackables/reorder - réordonnancement bulk
  - [x] POST /trackables/suggest-icons - suggestions IA d'icônes (gpt-4o-mini)
- [x] Créer endpoints goals (AC: 5)
  - [x] POST /trackables/:id/goals - définir nouvel objectif
  - [x] PATCH /trackables/:id/goals/:goalId - modifier objectif
  - [x] Logique: un seul goal actif par trackable (endDate null)
- [ ] Créer seed data (AC: 6) — Non implémenté (trackables créés manuellement)
- [x] Trackable système protégé (AC: 7)
  - [x] isSystem = true pour trackables Health Connect (sommeil, pas, etc.)
  - [x] Non supprimable (validation dans DELETE)
  - [x] Goal par défaut pour sommeil (ensureSleepGoal)

## Dev Notes

### Prisma Schema
```prisma
enum TrackingType {
  boolean
  number
  duration
}

enum GoalFrequency {
  daily
  weekly
  monthly
}

model TrackableItem {
  id           String       @id @default(uuid())
  userId       String       @map("user_id")
  user         User         @relation(fields: [userId], references: [id])
  name         String
  icon         String       // Lucide icon name
  color        String       // Hex color
  trackingType TrackingType @map("tracking_type")
  unit         String?      // e.g., "pas", "minutes"
  isActive     Boolean      @default(true) @map("is_active")
  isSystem     Boolean      @default(false) @map("is_system") // Pour workout
  createdAt    DateTime     @default(now()) @map("created_at")

  goals   TrackableGoal[]
  entries DailyEntry[]
  streaks Streak[]

  @@map("trackable_items")
}

model TrackableGoal {
  id          String        @id @default(uuid())
  trackableId String        @map("trackable_id")
  trackable   TrackableItem @relation(fields: [trackableId], references: [id], onDelete: Cascade)
  targetValue Float         @map("target_value")
  frequency   GoalFrequency
  startDate   DateTime      @map("start_date")
  endDate     DateTime?     @map("end_date")

  @@map("trackable_goals")
}
```

### API Endpoints

```typescript
// GET /trackables
Response: {
  data: [
    {
      id: string;
      name: string;
      icon: string;
      color: string;
      trackingType: 'boolean' | 'number' | 'duration';
      unit: string | null;
      isActive: boolean;
      isSystem: boolean;
      activeGoal: TrackableGoal | null;
    }
  ]
}

// POST /trackables
Request: {
  name: string;
  icon: string;
  color: string;
  trackingType: 'boolean' | 'number' | 'duration';
  unit?: string;
}

// POST /trackables/:id/goals
Request: {
  targetValue: number;
  frequency: 'daily' | 'weekly' | 'monthly';
}
// Note: startDate = now, termine le goal précédent (set endDate)
```

### Default Trackables (Seed)
```typescript
const defaultTrackables = [
  { name: 'Yoga', icon: 'heart', color: '#8B5CF6', trackingType: 'boolean' },
  { name: 'Pas', icon: 'footprints', color: '#22C55E', trackingType: 'number', unit: 'pas' },
  { name: 'Méditation', icon: 'brain', color: '#3B82F6', trackingType: 'duration', unit: 'min' },
  { name: 'Lecture', icon: 'book', color: '#F59E0B', trackingType: 'duration', unit: 'min' },
  { name: 'Side-project', icon: 'code', color: '#EC4899', trackingType: 'boolean' },
];

// Workout (système, toujours créé)
const workoutTrackable = {
  name: 'Workout',
  icon: 'dumbbell',
  color: '#EF4444',
  trackingType: 'number',
  unit: 'sessions',
  isSystem: true,
  isActive: true,
};
```

### Validation Rules
- Ne pas supprimer trackable si isSystem = true
- Un seul goal actif par trackable (endDate null)
- Lors de création nouveau goal, fermer le précédent
- trackingType ne peut pas être modifié après création

### Goal Logic
```typescript
async createGoal(trackableId: string, data: CreateGoalInput) {
  // Fermer le goal actif actuel
  await prisma.trackableGoal.updateMany({
    where: { trackableId, endDate: null },
    data: { endDate: new Date() },
  });

  // Créer le nouveau goal
  return prisma.trackableGoal.create({
    data: {
      trackableId,
      targetValue: data.targetValue,
      frequency: data.frequency,
      startDate: new Date(),
    },
  });
}
```

## Testing
- Tester création trackable avec tous les types
- Tester que workout est créé automatiquement pour nouveau user
- Tester DELETE sur trackable système → erreur
- Tester création goal ferme le précédent
- Tester GET inclut activeGoal
- Tester modification trackable (sauf trackingType)

## Completion Notes
- Endpoints use PATCH (not PUT) for partial updates, matching rest of API
- Added `sortOrder` field for drag & drop reordering
- Added `POST /trackables/suggest-icons` endpoint using OpenAI gpt-4o-mini with server-side validation against installed lucide-react + @lucide/lab icon names
- Icon validation: `scripts/generate-icon-list.mjs` generates a Set of 2434 valid icon names at build time (postinstall hook)
- Goal is mandatory when creating a trackable (min targetValue: 1)
- No seed data implemented; trackables are user-created or system-generated via Health Connect sync

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
| 2026-02-14 | 1.0 | Implementation complete | Dev |
