# Story 4.3: Import de l'historique des séances Hercules

## User Story

**As a** user migrating from Hercules,
**I want** my workout history imported into Momentum,
**So that** I can continue tracking my progress with my historical data.

## Background

Cette story fait partie de l'Epic 4: Migration Hercules → Momentum.
Dépend de : Story 4.1 (exercices) + Story 4.2 (workouts)

## Scope

- **520 performances** Hercules → WorkoutSession + SessionExercise + SessionSet
- Liées aux **6 workouts** créés en Story 4.2
- Période : 28/02/2024 → présent

## Acceptance Criteria

1. Script CLI exécutable via `npx ts-node scripts/hercules-import-history.ts`
2. Utilise les mappings générés par 4.1 (exercices) et 4.2 (workouts)
3. Création des WorkoutSession avec status `completed`
4. Création des SessionExercise pour chaque exercice de la séance
5. Création des SessionSet avec targetReps, targetWeight, actualReps, actualWeight
6. Parsing correct des strings Hercules "20-20-20" → sets individuels
7. Conversion des timestamps Hercules (ms) → DateTime
8. Import des notes de session (sessions_notes)
9. Séances avec notes d'écart important → ignorées
10. Log détaillé des imports
11. Script idempotent (vérification si session existe déjà par date + workout)

## Data Transformation

### Hercules `performances` → Momentum

```
performances (1 ligne = 1 exercice dans une séance)
├── date (timestamp ms) ──────────► WorkoutSession.startedAt
├── session_duration (sec) ───────► WorkoutSession.completedAt (startedAt + duration)
├── id_session ───────────────────► WorkoutSession.workoutId (via mapping 4.2)
├── id_exercise ──────────────────► SessionExercise.exerciseId (via mapping 4.1)
├── position ─────────────────────► SessionExercise.position
├── reps_goal "20-20-20" ─────────► SessionSet[].targetReps
├── reps_done "20-18-15" ─────────► SessionSet[].actualReps
├── loads_goal "30-30-30" ────────► SessionSet[].targetWeight
└── loads_done "30-30-25" ────────► SessionSet[].actualWeight

sessions_notes
├── date ─────────────────────────► Match avec WorkoutSession par date
└── note ─────────────────────────► WorkoutSession.notes
```

### Regroupement des performances

Les performances Hercules sont stockées avec une ligne par exercice.
Il faut les regrouper par `(date, id_session)` pour créer une `WorkoutSession`.

```typescript
// Pseudo-code
const sessionGroups = groupBy(performances, p => `${p.date}-${p.id_session}`);

for (const [key, exercises] of sessionGroups) {
  // Récupérer le workout via mapping
  const workoutId = workoutMapping[exercises[0].id_session];

  const session = await createWorkoutSession({
    userId,
    workoutId,
    startedAt: new Date(exercises[0].date),
    completedAt: new Date(exercises[0].date + exercises[0].session_duration * 1000),
    status: 'completed',
    notes: getSessionNotes(exercises[0].date),
  });

  for (const ex of exercises) {
    // Skip si exercice ignoré (étirements)
    if (isIgnoredExercise(ex.id_exercise)) continue;

    const sessionExercise = await createSessionExercise({
      sessionId: session.id,
      exerciseId: exerciseMapping[ex.id_exercise],
      position: ex.position,
      status: 'completed',
    });

    const repsGoal = parseHerculesArray(ex.reps_goal);
    const repsDone = parseHerculesArray(ex.reps_done);
    const loadsGoal = parseHerculesArray(ex.loads_goal);
    const loadsDone = parseHerculesArray(ex.loads_done);

    for (let i = 0; i < Math.max(repsGoal.length, repsDone.length); i++) {
      await createSessionSet({
        sessionExerciseId: sessionExercise.id,
        setNumber: i + 1,
        targetReps: repsGoal[i] || repsDone[i],
        targetWeight: loadsGoal[i] || loadsDone[i] || null,
        actualReps: repsDone[i] || null,
        actualWeight: loadsDone[i] || null,
        completedAt: new Date(ex.date),
      });
    }
  }
}
```

## Séances à ignorer

Basé sur les notes de sessions avec écart important :

| Date | Note | Action |
|------|------|--------|
| 23/04/2024 | "incliné au lieu de couché" | IGNORER la perf de développé couché |
| 07/05/2024 | "incliné au lieu de couché" | IGNORER la perf de développé couché |
| 28/10/2025 | "Haltères" (poids très différents) | IGNORER la perf de développé couché |
| 25/08/2024 | "presse horizontale au lieu de Split" | IGNORER la perf de split squat |

## Technical Notes

### Parsing des valeurs Hercules

```typescript
function parseHerculesArray(str: string | null): number[] {
  if (!str) return [];
  return str.split('-').map(v => parseFloat(v)).filter(v => !isNaN(v));
}
```

### Fichiers de mapping requis

- `scripts/hercules-exercise-mapping.json` (généré par 4.1)
- `scripts/hercules-workout-mapping.json` (généré par 4.2)

### Exercices à ignorer

```typescript
const IGNORED_EXERCISES = [
  'Étirements pecs',
  'Étirement table épaules',
];
```

## Definition of Done

- [x] Script créé et testé
- [x] Sessions importées avec exercices et sets
- [x] Notes de session importées
- [x] Performances avec écarts ignorées
- [x] Log de l'import généré
- [x] Validation manuelle de quelques séances

## Dependencies

- Story 4.1 (mapping exercices)
- Story 4.2 (workouts créés)

## Story Points

5 (Medium)

---

## Dev Agent Record

### Status: Completed

### Agent Model Used
Claude Opus 4.5

### File List
| File | Action |
|------|--------|
| `scripts/hercules-import-history.ts` | Created |
| `scripts/cleanup-sessions.ts` | Created |
| `scripts/check-hercules-performances.js` | Created (debug) |
| `scripts/check-notes-dates.js` | Created (debug) |

### Completion Notes
- Script testé sur BDD dev (localhost:5432) avec succès
- Script exécuté sur BDD prod (192.168.1.197:5432) avec succès
- 125 WorkoutSessions créées (127 - 2 ignorées "Épaules rééducation")
- 508 SessionExercises créés
- 2121 SessionSets créés
- 4 performances avec écarts ignorées:
  - 23/04/2024: Développé couché (incliné au lieu de couché)
  - 07/05/2024: Développé couché (incliné au lieu de couché)
  - 25/08/2024: Split squat (presse horizontale au lieu de Split)
  - 28/10/2025: Développé couché (Haltères - poids différents)
- Notes de session importées (20 notes au total)
- Période couverte: 28/02/2024 → 04/01/2026
- Idempotence vérifiée: 0 doublons au relancement
- Nettoyage préalable de prod: 18 sessions supprimées, 1 conservée (Pecs 02/02/2026)

### Production Results
```
Sessions créées:   125
Exercices créés:   508
Sets créés:        2121
Performances ignorées (écarts): 4
Sessions ignorées (Épaules rééducation): 2
```

### Change Log
| Date | Change |
|------|--------|
| 2026-02-04 | Script créé et testé sur dev |
| 2026-02-04 | Exécuté sur prod: 125 sessions, 508 exercices, 2121 sets |
