# Story 2.8: Progressive Overload System

## Status: Ready for Review

## Story
**As a** user,
**I want** the app to analyze my completed workout and suggest weight or rep increases,
**so that** I continuously progress without having to manually track patterns.

## Acceptance Criteria

### Affichage sur la page de fin de sÃ©ance
1. Sur la page de rÃ©sumÃ© de sÃ©ance (Session Summary), sous chaque carte d'exercice, afficher une zone de suggestion de progression si applicable
2. La suggestion s'affiche uniquement si l'algorithme dÃ©tecte qu'une progression est recommandÃ©e
3. L'utilisateur peut Accepter ou Ignorer chaque suggestion individuellement

### Algorithme d'Ã©valuation de progression
4. Analyser la performance de la sÃ©ance actuelle pour chaque exercice :
   - Comparer reps rÃ©elles vs reps cibles
   - Comparer poids rÃ©els vs poids cibles
5. Analyser l'historique des 3-4 derniÃ¨res sessions pour dÃ©tecter une stabilisation (mÃªmes valeurs Â±5%)
6. CritÃ¨res de dÃ©clenchement d'une suggestion :
   - **Target atteint ou dÃ©passÃ©** : Si l'utilisateur a atteint ou dÃ©passÃ© les reps cibles sur toutes les sÃ©ries â†’ suggÃ©rer +poids
   - **Stabilisation** : Si performance stable sur 3+ sessions â†’ suggÃ©rer progression
   - **Sous-performance** : Si l'utilisateur n'atteint pas les cibles â†’ ne pas suggÃ©rer (ou suggÃ©rer de maintenir)

### Logique de suggestion
7. RÃ¨gles de progression :
   - **Augmentation poids** : +2.5kg (isolation/petit muscle) ou +5kg (compound/grand muscle)
   - **Augmentation reps** : +1-2 reps si le poids ne peut pas augmenter facilement
8. GÃ©nÃ©rer un message explicatif lisible ("Vous avez dÃ©passÃ© vos cibles sur toutes les sÃ©ries. PrÃªt pour 62.5kg ?")

### Application des suggestions
9. Si acceptÃ© : Mettre Ã  jour les `targetWeight` et/ou `targetReps` dans le **workout template** (`WorkoutSet`)
10. Les futures sÃ©ances utiliseront automatiquement les nouvelles cibles

### Cooldown et limitations
11. Ne pas re-suggÃ©rer le mÃªme type de progression si ignorÃ© rÃ©cemment (cooldown de 2-3 sessions)
12. Stocker l'historique des suggestions dans un nouveau modÃ¨le `ProgressionSuggestion`

### Historique des suggestions (optionnel)
13. Pouvoir consulter l'historique des suggestions acceptÃ©es/ignorÃ©es dans les stats de l'exercice

## Tasks / Subtasks

### ModÃ¨le Prisma (AC: 12)
- [x] CrÃ©er modÃ¨le `ProgressionSuggestion`
  - [x] Migration Prisma
  - [x] Enum status: pending, accepted, dismissed
  - [x] Relations avec Exercise, User, Session
  - [x] Champs: suggestionType, currentValue, suggestedValue, reason, sessionId

### Service d'Ã©valuation (AC: 4, 5, 6)
- [x] CrÃ©er service `progression.service.ts`
  - [x] Fonction `evaluateSession(sessionId)` â†’ analyse tous les exercices
  - [x] Fonction `evaluateExercise(userId, exerciseId, currentSessionData)` â†’ analyse un exercice
  - [x] RÃ©cupÃ©rer les N derniÃ¨res sessions pour chaque exercice
  - [x] Calculer les moyennes et dÃ©tecter stabilisation
  - [x] DÃ©terminer si target atteint/dÃ©passÃ©
  - [x] Retourner liste de suggestions potentielles

### Logique de suggestion (AC: 7, 8)
- [x] ImplÃ©menter rÃ¨gles de progression
  - [x] DÃ©tecter type d'exercice (isolation vs compound) via muscleGroups
  - [x] Calculer incrÃ©ment appropriÃ© (+2.5kg vs +5kg)
  - [x] GÃ©nÃ©rer message explicatif en franÃ§ais

### Endpoints API (AC: 9, 12)
- [x] GET `/sessions/:id/progression-suggestions` - RÃ©cupÃ©rer suggestions pour une session
- [x] PATCH `/progression-suggestions/:id` - Accepter ou ignorer une suggestion
  - [x] Si accepted: Mettre Ã  jour `WorkoutSet.targetWeight` / `targetReps`
  - [x] Enregistrer le statut dans `ProgressionSuggestion`

### Composant UI (AC: 1, 2, 3)
- [x] CrÃ©er composant `ProgressionSuggestionCard`
  - [x] Props: suggestion (type, current, suggested, reason), onAccept, onDismiss
  - [x] Affichage: icÃ´ne trend, valeur actuelle â†’ valeur suggÃ©rÃ©e
  - [x] Message explicatif
  - [x] Boutons: Accepter âœ“ / Ignorer âœ•

### IntÃ©gration Session Summary (AC: 1, 2)
- [x] Modifier `SessionSummary` et page `/sessions/[id]`
  - [x] Appeler `GET /sessions/:id/progression-suggestions` au chargement
  - [x] Sous chaque `ExerciseCard`, afficher `ProgressionSuggestionCard` si suggestion existe
  - [x] GÃ©rer les actions accept/dismiss

### Cooldown (AC: 11)
- [x] ImplÃ©menter logique de cooldown
  - [x] VÃ©rifier si suggestion rÃ©cemment ignorÃ©e pour cet exercice
  - [x] Ne pas re-gÃ©nÃ©rer pendant 2-3 sessions

## UX Specifications

### Wireframe - ProgressionSuggestionCard intÃ©grÃ© dans ExerciseRecap

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dips                                               â”‚
â”‚  3 sÃ©ries complÃ©tÃ©es                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â‘  [  -  |  10  |  +  ]  REPS    [  -  |  0  |  +  ]  KG  â”‚
â”‚  â‘¡ [  -  |  10  |  +  ]  REPS    [  -  |  0  |  +  ]  KG  â”‚
â”‚  â‘¢ [  -  |  10  |  +  ]  REPS    [  -  |  0  |  +  ]  KG  â”‚
â”œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“ˆ  PrÃªt Ã  progresser ?                      â”‚  â”‚
â”‚  â”‚                                               â”‚  â”‚
â”‚  â”‚  Objectifs atteints ! Passer de              â”‚  â”‚
â”‚  â”‚  0kg â†’ 2.5kg pour la prochaine sÃ©ance ?      â”‚  â”‚
â”‚  â”‚                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Ignorer   â”‚    â”‚  âœ“ Appliquer +2.5kg â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Wireframe - Variante augmentation de reps

```
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“ˆ  PrÃªt Ã  progresser ?                      â”‚  â”‚
â”‚  â”‚                                               â”‚  â”‚
â”‚  â”‚  Performance stable depuis 3 sÃ©ances.        â”‚  â”‚
â”‚  â”‚  Passer de 10 â†’ 12 reps ?                    â”‚  â”‚
â”‚  â”‚                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Ignorer   â”‚    â”‚  âœ“ Appliquer +2 repsâ”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
```

### Composants Shadcn utilisÃ©s

| Composant | Usage |
|-----------|-------|
| `Button` | Boutons "Ignorer" (variant=ghost) et "Appliquer" (variant=default, custom bg) |
| `Collapsible` | Animation d'apparition/disparition de la suggestion |

### IcÃ´ne Lucide

- `TrendingUp` - IcÃ´ne de progression (remplace l'emoji ğŸ“ˆ)

### ProgressionSuggestionCard - SpÃ©cifications dÃ©taillÃ©es

#### Props Interface

```typescript
interface ProgressionSuggestionCardProps {
  suggestion: {
    id: string;
    suggestionType: 'increase_weight' | 'increase_reps';
    currentValue: number;
    suggestedValue: number;
    reason: string;
  };
  onAccept: () => Promise<void>;
  onDismiss: () => Promise<void>;
}
```

#### Ã‰tats du composant

| Ã‰tat | Description | Visuel |
|------|-------------|--------|
| `pending` | Ã‰tat initial | Carte visible, boutons actifs |
| `loading` | Action en cours | Bouton cliquÃ© avec spinner, tous boutons disabled |
| `accepted` | Suggestion acceptÃ©e | Message "âœ“ AppliquÃ© !" en vert, puis collapse aprÃ¨s 1.5s |
| `dismissed` | Suggestion ignorÃ©e | Collapse immÃ©diat (200ms) |

#### Styles Tailwind

```tsx
// Conteneur de la suggestion (Ã  l'intÃ©rieur de ExerciseRecap)
<div className="mx-4 mb-4 p-4 rounded-lg bg-zinc-800/50 border border-emerald-500/20">

// IcÃ´ne TrendingUp
<TrendingUp className="h-4 w-4 text-emerald-400" />

// Titre "PrÃªt Ã  progresser ?"
<span className="text-sm font-medium text-zinc-200">

// Message reason
<p className="text-xs text-zinc-400">

// Valeur transition (ex: "0kg â†’ 2.5kg")
<span className="font-mono">
  <span className="text-zinc-400">{currentValue}kg</span>
  <span className="text-zinc-500 mx-1">â†’</span>
  <span className="text-emerald-400 font-semibold">{suggestedValue}kg</span>
</span>

// Bouton Ignorer
<Button variant="ghost" className="text-zinc-400 hover:text-zinc-200">
  Ignorer
</Button>

// Bouton Appliquer (CTA principal)
<Button className="bg-emerald-600 hover:bg-emerald-500 text-white">
  <Check className="h-4 w-4 mr-1" />
  Appliquer +{increment}{unit}
</Button>

// Ã‰tat accepted (feedback inline)
<div className="flex items-center gap-2 text-emerald-400">
  <Check className="h-4 w-4" />
  <span className="text-sm font-medium">AppliquÃ© !</span>
</div>
```

#### Animation Collapsible

```tsx
// Utiliser Radix Collapsible pour l'animation
<Collapsible open={isVisible}>
  <CollapsibleContent className="overflow-hidden data-[state=open]:animate-collapsible-down data-[state=closed]:animate-collapsible-up">
    {/* Contenu de la carte */}
  </CollapsibleContent>
</Collapsible>

// CSS animations (ajouter dans globals.css si nÃ©cessaire)
@keyframes collapsible-down {
  from { height: 0; opacity: 0; }
  to { height: var(--radix-collapsible-content-height); opacity: 1; }
}
@keyframes collapsible-up {
  from { height: var(--radix-collapsible-content-height); opacity: 1; }
  to { height: 0; opacity: 0; }
}
```

### IntÃ©gration dans ExerciseRecap

```tsx
// session-summary.tsx - Modification de ExerciseRecap

interface ExerciseRecapProps {
  exercise: SummaryExercise;
  suggestion?: ProgressionSuggestion | null;  // NEW
  onAcceptSuggestion?: (id: string) => Promise<void>;  // NEW
  onDismissSuggestion?: (id: string) => Promise<void>;  // NEW
  getSetValue: (set: SummaryExercise["sets"][number]) => { reps: number; weight: number };
  onSetChange: (...) => void;
}

function ExerciseRecap({
  exercise,
  suggestion,
  onAcceptSuggestion,
  onDismissSuggestion,
  getSetValue,
  onSetChange
}: ExerciseRecapProps) {
  const completedSets = exercise.sets.filter((s) => s.actualReps !== null);

  if (completedSets.length === 0) return null;

  return (
    <div className="rounded-xl border border-zinc-800 bg-zinc-900/30 overflow-hidden">
      {/* Exercise header */}
      <div className="px-4 py-3 border-b border-zinc-800/50">
        <h3 className="font-semibold text-zinc-100">{exercise.name}</h3>
        <p className="text-xs text-zinc-500 mt-0.5">
          {completedSets.length} sÃ©rie{completedSets.length > 1 ? "s" : ""} complÃ©tÃ©e{completedSets.length > 1 ? "s" : ""}
        </p>
      </div>

      {/* Sets list */}
      <div className="divide-y divide-zinc-800/50">
        {completedSets.map((set) => (
          <SetRow key={set.id} ... />
        ))}
      </div>

      {/* Progression suggestion - NEW */}
      {suggestion && (
        <ProgressionSuggestionCard
          suggestion={suggestion}
          onAccept={() => onAcceptSuggestion?.(suggestion.id)}
          onDismiss={() => onDismissSuggestion?.(suggestion.id)}
        />
      )}
    </div>
  );
}
```

### Flow d'interaction dÃ©taillÃ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Session Summary charge                               â”‚
â”‚     â†’ GET /sessions/:id/progression-suggestions          â”‚
â”‚     â†’ Map suggestions par exerciseId                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Pour chaque exercice avec suggestion                 â”‚
â”‚     â†’ Afficher ProgressionSuggestionCard                 â”‚
â”‚     â†’ Ã‰tat: pending                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3a. Clic "Ignorer" â”‚       â”‚  3b. Clic "Appliquer"â”‚
â”‚  â†’ Ã‰tat: loading    â”‚       â”‚  â†’ Ã‰tat: loading     â”‚
â”‚  â†’ PATCH dismissed  â”‚       â”‚  â†’ PATCH accepted    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4a. Collapse       â”‚       â”‚  4b. "âœ“ AppliquÃ© !" â”‚
â”‚  (200ms animation)  â”‚       â”‚  (1.5s visible)     â”‚
â”‚                     â”‚       â”‚  â†’ puis collapse    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Touch Targets (Mobile)

| Ã‰lÃ©ment | Taille minimale |
|---------|-----------------|
| Bouton "Ignorer" | 44px hauteur |
| Bouton "Appliquer" | 44px hauteur |

## Dependencies
- Story 1.2: Database & Prisma Setup (Prisma configuration)
- Story 2.5: Workout Session Backend (modÃ¨les Session, SessionSet)
- Story 2.6: Active Session UI (Session Summary component)
- Story 2.1: Exercise Library Backend (modÃ¨le Exercise)

## Dev Notes

### Prisma 7 Configuration (ref Story 1.2)
- La config datasource est dans `prisma.config.ts` (pas dans schema.prisma)
- Le client est gÃ©nÃ©rÃ© dans `src/generated/prisma/`
- Import Prisma: `import { prisma } from '../lib/prisma'`

### Prisma Schema
```prisma
enum SuggestionType {
  increase_weight
  increase_reps
  maintain  // optionnel: pour feedback positif sans changement
}

enum SuggestionStatus {
  pending
  accepted
  dismissed
}

model ProgressionSuggestion {
  id              String           @id @default(uuid())
  userId          String           @map("user_id")
  user            User             @relation(fields: [userId], references: [id])
  exerciseId      String           @map("exercise_id")
  exercise        Exercise         @relation(fields: [exerciseId], references: [id])
  sessionId       String           @map("session_id")
  session         WorkoutSession   @relation(fields: [sessionId], references: [id])

  suggestionType  SuggestionType   @map("suggestion_type")
  currentValue    Float            @map("current_value")
  suggestedValue  Float            @map("suggested_value")
  reason          String
  status          SuggestionStatus @default(pending)

  createdAt       DateTime         @default(now()) @map("created_at")
  respondedAt     DateTime?        @map("responded_at")

  @@unique([sessionId, exerciseId])  // Une seule suggestion par exercice par session
  @@map("progression_suggestions")
}
```

### Algorithme d'Ã©valuation (progression.service.ts)

```typescript
interface ProgressionAnalysis {
  shouldSuggest: boolean;
  suggestionType: 'increase_weight' | 'increase_reps' | null;
  currentValue: number;
  suggestedValue: number;
  reason: string;
}

async function evaluateExercise(
  userId: string,
  exerciseId: string,
  currentSessionSets: SessionSet[]
): Promise<ProgressionAnalysis> {

  // 1. Calculer performance de la session actuelle
  const avgActualReps = average(currentSessionSets.map(s => s.actualReps));
  const avgActualWeight = average(currentSessionSets.map(s => s.actualWeight));
  const avgTargetReps = average(currentSessionSets.map(s => s.targetReps));
  const avgTargetWeight = average(currentSessionSets.map(s => s.targetWeight));

  // 2. VÃ©rifier si cibles atteintes/dÃ©passÃ©es sur TOUTES les sÃ©ries
  const allSetsMetTarget = currentSessionSets.every(s =>
    s.actualReps >= s.targetReps &&
    (s.targetWeight === null || s.actualWeight >= s.targetWeight)
  );

  if (!allSetsMetTarget) {
    return { shouldSuggest: false, ... };
  }

  // 3. VÃ©rifier cooldown (pas de suggestion rÃ©cente ignorÃ©e)
  const recentDismissed = await checkRecentDismissed(userId, exerciseId, 3);
  if (recentDismissed) {
    return { shouldSuggest: false, ... };
  }

  // 4. RÃ©cupÃ©rer historique pour dÃ©tecter stabilisation
  const history = await getExerciseHistory(userId, exerciseId, 4);
  const isStable = checkStability(history, 0.05); // Â±5%

  // 5. DÃ©terminer type de suggestion
  const exercise = await prisma.exercise.findUnique({ where: { id: exerciseId }});
  const isCompound = isCompoundExercise(exercise.muscleGroups);
  const weightIncrement = isCompound ? 5 : 2.5;

  // 6. SuggÃ©rer augmentation de poids si target reps atteint
  if (avgActualReps >= avgTargetReps && avgTargetWeight) {
    return {
      shouldSuggest: true,
      suggestionType: 'increase_weight',
      currentValue: avgTargetWeight,
      suggestedValue: avgTargetWeight + weightIncrement,
      reason: `Objectifs atteints sur toutes les sÃ©ries. PrÃªt pour ${avgTargetWeight + weightIncrement}kg ?`
    };
  }

  // 7. SuggÃ©rer augmentation de reps si poids stable
  if (isStable && history.length >= 3) {
    return {
      shouldSuggest: true,
      suggestionType: 'increase_reps',
      currentValue: avgTargetReps,
      suggestedValue: avgTargetReps + 2,
      reason: `Performance stable depuis ${history.length} sÃ©ances. Essayez ${avgTargetReps + 2} reps !`
    };
  }

  return { shouldSuggest: false, ... };
}

// Identifier si exercice compound (plusieurs grands groupes musculaires)
function isCompoundExercise(muscleGroups: string[]): boolean {
  const majorGroups = ['pectoraux', 'dos', 'quadriceps', 'ischios', 'fessiers'];
  return muscleGroups.filter(g => majorGroups.includes(g)).length >= 1;
}
```

### API Endpoints

```typescript
// GET /sessions/:id/progression-suggestions
// GÃ©nÃ¨re et retourne les suggestions pour une session complÃ©tÃ©e
Response: {
  data: [
    {
      id: string;
      exerciseId: string;
      exerciseName: string;
      suggestionType: 'increase_weight';
      currentValue: 60;
      suggestedValue: 62.5;
      reason: "Objectifs atteints sur toutes les sÃ©ries. PrÃªt pour 62.5kg ?";
      status: 'pending';
    }
  ]
}

// PATCH /progression-suggestions/:id
Request: { status: 'accepted' | 'dismissed' }
// Si accepted: Met Ã  jour WorkoutSet.targetWeight ou targetReps
```

### Composant ProgressionSuggestionCard

```tsx
interface ProgressionSuggestionCardProps {
  suggestion: {
    id: string;
    exerciseName: string;
    suggestionType: 'increase_weight' | 'increase_reps';
    currentValue: number;
    suggestedValue: number;
    reason: string;
  };
  onAccept: () => void;
  onDismiss: () => void;
  isLoading?: boolean;
}

// Maquette
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  ğŸ“ˆ PROGRESSION SUGGÃ‰RÃ‰E                    â”‚
// â”‚                                             â”‚
// â”‚  60kg â†’ 62.5kg                              â”‚
// â”‚                                             â”‚
// â”‚  Objectifs atteints sur toutes les sÃ©ries. â”‚
// â”‚  PrÃªt pour 62.5kg ?                        â”‚
// â”‚                                             â”‚
// â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
// â”‚  â”‚  âœ• Ignorer  â”‚  â”‚ âœ“ Accepter  â”‚          â”‚
// â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### IntÃ©gration dans Session Summary

```tsx
// Dans ExerciseRecap ou ExerciseCard, aprÃ¨s la liste des sets :
{suggestion && (
  <ProgressionSuggestionCard
    suggestion={suggestion}
    onAccept={() => handleAcceptSuggestion(suggestion.id)}
    onDismiss={() => handleDismissSuggestion(suggestion.id)}
  />
)}
```

### Flow utilisateur

```
1. Utilisateur termine sa sÃ©ance
          â†“
2. Page Session Summary s'affiche
          â†“
3. API GET /sessions/:id/progression-suggestions
          â†“
4. Pour chaque exercice avec suggestion:
   - Afficher ProgressionSuggestionCard sous l'ExerciseCard
          â†“
5. Utilisateur clique "Accepter" ou "Ignorer"
          â†“
6. API PATCH /progression-suggestions/:id
          â†“
7. Si accepted:
   - Mise Ã  jour WorkoutSet (template)
   - Feedback toast "Objectif mis Ã  jour !"
          â†“
8. Prochaine sÃ©ance: nouvelles cibles automatiquement
```

## Testing

### Algorithme
- Tester qu'aucune suggestion si cibles non atteintes
- Tester suggestion weight aprÃ¨s toutes sÃ©ries rÃ©ussies
- Tester suggestion reps aprÃ¨s stabilisation 3+ sessions
- Tester cooldown aprÃ¨s dismiss
- Tester distinction compound vs isolation (+5kg vs +2.5kg)

### API
- Tester GET suggestions retourne les bonnes donnÃ©es
- Tester PATCH accepted met Ã  jour WorkoutSet
- Tester PATCH dismissed n'update pas les targets

### UI
- Tester affichage de la suggestion sous la carte exercice
- Tester boutons Accept/Dismiss
- Tester feedback toast aprÃ¨s action
- Tester que la suggestion disparaÃ®t aprÃ¨s action

### Edge cases
- Session sans historique (premiÃ¨re fois)
- Exercice substituÃ© pendant la session
- Exercice sans poids (bodyweight)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
| 2026-02-01 | 0.2 | Refonte complÃ¨te : trigger sur page fin de sÃ©ance, suggestions sous cartes exercices, mise Ã  jour template workout | PM John |
| 2026-02-01 | 0.3 | Ajout spÃ©cifications UX : wireframes, composants shadcn, Ã©tats, animations, intÃ©gration ExerciseRecap | UX Sally |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### File List
| File | Action |
|------|--------|
| `apps/api/prisma/schema.prisma` | Modified - Added ProgressionSuggestion model |
| `apps/api/prisma/migrations/20260131233803_add_progression_suggestions/` | Created - Migration for ProgressionSuggestion |
| `apps/api/src/services/progression.service.ts` | Created - Progression evaluation service |
| `apps/api/src/schemas/progression.schema.ts` | Created - Zod validation schemas |
| `apps/api/src/routes/progression.routes.ts` | Created - API endpoints for suggestions |
| `apps/api/src/index.ts` | Modified - Registered progression routes |
| `apps/web/src/lib/api/sessions.ts` | Modified - Added suggestion API functions |
| `apps/web/src/components/session/progression-suggestion-card.tsx` | Created - UI component for suggestions |
| `apps/web/src/components/session/index.ts` | Modified - Export ProgressionSuggestionCard |
| `apps/web/src/components/session/screens/session-summary.tsx` | Modified - Integrated suggestions display |
| `apps/web/src/app/(session)/session/[id]/page.tsx` | Modified - Fetch and handle suggestions |

### Completion Notes
- All progression suggestion functionality implemented
- TypeScript compilation passes
- ESLint passes
