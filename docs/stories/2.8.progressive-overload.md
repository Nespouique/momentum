# Story 2.8: Progressive Overload System

## Status: Draft

## Story
**As a** user,
**I want** the app to detect when I'm plateauing and suggest progression,
**so that** I continuously improve without having to manually track patterns.

## Acceptance Criteria
1. Algorithme de dÃ©tection de stabilisation : identifier quand un exercice a Ã©tÃ© fait avec mÃªmes reps/poids sur 3-4 sessions consÃ©cutives
2. Logique de suggestion : proposer +1-2 reps OU +2.5kg/5kg selon l'exercice et l'historique
3. ModÃ¨le `ProgressionSuggestion` (exerciseId, sessionId, currentReps, currentWeight, suggestedReps, suggestedWeight, status: pending/accepted/dismissed)
4. Affichage de la suggestion dans l'interface de session active (avant de commencer l'exercice concernÃ©)
5. UI de suggestion : afficher progression actuelle â†’ suggestion, avec boutons Accepter/Modifier/Ignorer
6. Si acceptÃ© : prÃ©-remplir les nouveaux objectifs pour cette sÃ©rie
7. Historique des suggestions accessibles (optionnel : dans les stats de l'exercice)
8. Ne pas re-suggÃ©rer si l'utilisateur a ignorÃ© rÃ©cemment (cooldown de 2-3 sessions)

## Tasks / Subtasks
- [ ] CrÃ©er modÃ¨le ProgressionSuggestion (AC: 3)
  - [ ] Migration Prisma
  - [ ] Enum status: pending, accepted, dismissed
  - [ ] Relations avec Exercise et User
  - [ ] Champs: suggestionType, currentValue, suggestedValue, reason
- [ ] ImplÃ©menter algorithme de dÃ©tection (AC: 1)
  - [ ] Service `progression.service.ts`
  - [ ] Analyser les N derniÃ¨res sessions pour chaque exercice
  - [ ] DÃ©tecter stabilisation (3-4 sessions avec mÃªmes valeurs Â±5%)
  - [ ] Trigger aprÃ¨s chaque session complÃ©tÃ©e
- [ ] ImplÃ©menter logique de suggestion (AC: 2)
  - [ ] RÃ¨gles de progression:
    - Si target reps atteint: +2.5kg (isolation) ou +5kg (compound)
    - Si poids plafonnÃ©: +1-2 reps
    - Si les deux plafonnÃ©s: +1 set (optionnel)
  - [ ] GÃ©nÃ©rer raison lisible ("Vous avez atteint 10 reps sur 4 sessions")
- [ ] CrÃ©er endpoints progression (AC: 3, 7)
  - [ ] GET /progression/suggestions - suggestions pending pour l'utilisateur
  - [ ] PATCH /progression/suggestions/:id - accepter ou dismiss
  - [ ] GET /progression/history/:exerciseId - historique des suggestions
  - [ ] Trigger automatique Ã  la complÃ©tion de session
- [ ] Afficher suggestion dans session (AC: 4)
  - [ ] VÃ©rifier suggestions pending au dÃ©but de chaque exercice
  - [ ] Afficher avant le premier set de l'exercice
  - [ ] Ne pas bloquer le flow si ignorÃ©
- [ ] UI de suggestion (AC: 5, 6)
  - [ ] Composant ProgressionSuggestionCard
  - [ ] Afficher: current â†’ suggested (ex: "60kg â†’ 62.5kg")
  - [ ] Afficher raison
  - [ ] Boutons: Accepter / Modifier / Ignorer
  - [ ] Si acceptÃ©: mettre Ã  jour targets locaux pour cette session
- [ ] ImplÃ©menter cooldown (AC: 8)
  - [ ] Tracker quand une suggestion a Ã©tÃ© dismissed
  - [ ] Ne pas re-suggÃ©rer pour mÃªme exercice pendant 2-3 sessions
  - [ ] Champ lastDismissedAt sur suggestion ou compteur

## Dependencies
- Story 1.2: Database & Prisma Setup (Prisma 7 configuration)
- Story 2.5: Workout Session Backend (modÃ¨le Set pour historique)
- Story 2.6: Active Session UI (intÃ©gration affichage suggestions)
- Story 2.1: Exercise Library Backend (modÃ¨le Exercise)

## Dev Notes

### Prisma 7 Configuration (ref Story 1.2)
- La config datasource est dans `prisma.config.ts` (pas dans schema.prisma)
- Le client est gÃ©nÃ©rÃ© dans `src/generated/prisma/`
- Utiliser `moduleFormat = "cjs"` dans le generator
- Import Prisma: `import { prisma } from '../lib/prisma'`

### Composants UI disponibles
Pour le `ProgressionSuggestionCard`:
- **Card, Button** - Story 1.4
- **Dialog** - Story 1.6 (si modal)
- **Sonner (toasts)** - Story 1.5 (feedback accept/dismiss)

### Prisma Schema
```prisma
enum SuggestionType {
  increase_weight
  increase_reps
  increase_sets
}

enum SuggestionStatus {
  pending
  accepted
  dismissed
}

model ProgressionSuggestion {
  id              String           @id @default(uuid())
  userId          String           @map("user_id")
  user            User             @relation(fields: [userId], references: [id])
  exerciseId      String           @map("exercise_id")
  exercise        Exercise         @relation(fields: [exerciseId], references: [id])
  suggestionType  SuggestionType   @map("suggestion_type")
  currentValue    Float            @map("current_value")
  suggestedValue  Float            @map("suggested_value")
  reason          String
  status          SuggestionStatus @default(pending)
  createdAt       DateTime         @default(now()) @map("created_at")
  respondedAt     DateTime?        @map("responded_at")

  @@map("progression_suggestions")
}
```

### Progression Detection Algorithm
```typescript
// progression.service.ts
async analyzeExercise(userId: string, exerciseId: string) {
  // RÃ©cupÃ©rer les 4 derniÃ¨res sessions avec cet exercice
  const recentSets = await prisma.set.findMany({
    where: {
      exerciseId,
      session: { userId, status: 'completed' },
    },
    orderBy: { completedAt: 'desc' },
    take: 16, // 4 sessions Ã— 4 sets max
    include: { session: true },
  });

  // Grouper par session
  const sessionSets = groupBySession(recentSets);

  if (sessionSets.length < 3) return null; // Pas assez de donnÃ©es

  // Calculer moyenne reps/weight par session
  const averages = sessionSets.map(sets => ({
    avgReps: average(sets.map(s => s.reps)),
    avgWeight: average(sets.map(s => s.weight)),
  }));

  // VÃ©rifier stabilisation (Â±5% sur 3+ sessions)
  const isStable = checkStability(averages, 0.05);

  if (!isStable) return null;

  // VÃ©rifier si target atteint
  const target = await getTargetForExercise(userId, exerciseId);
  const current = averages[0];

  if (current.avgReps >= target.reps) {
    // SuggÃ©rer augmentation de poids
    return createSuggestion('increase_weight', current.avgWeight, current.avgWeight + 2.5);
  } else {
    // SuggÃ©rer augmentation de reps
    return createSuggestion('increase_reps', current.avgReps, current.avgReps + 2);
  }
}
```

### API Endpoints
```typescript
// GET /progression/suggestions
Response: {
  data: [
    {
      id: string;
      exerciseId: string;
      exercise: { name: string };
      suggestionType: 'increase_weight';
      currentValue: 60;
      suggestedValue: 62.5;
      reason: "Vous avez atteint 10 reps sur 4 sessions consÃ©cutives";
      status: 'pending';
    }
  ]
}

// PATCH /progression/suggestions/:id
Request: { status: 'accepted' | 'dismissed' }
```

### Suggestion UI Component
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¡ PROGRESSION SUGGESTION      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BENCH PRESS                    â”‚
â”‚                                 â”‚
â”‚  You've hit 10 reps for 4       â”‚
â”‚  sessions in a row!             â”‚
â”‚                                 â”‚
â”‚  Current: 60kg                  â”‚
â”‚      â†“                          â”‚
â”‚  Suggested: 62.5kg              â”‚
â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Accept] [Modify] [Ignore]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cooldown Implementation
```typescript
// VÃ©rifier si suggestion rÃ©cemment dismissed
const recentDismiss = await prisma.progressionSuggestion.findFirst({
  where: {
    userId,
    exerciseId,
    status: 'dismissed',
    respondedAt: {
      gte: subSessions(new Date(), 3), // 3 derniÃ¨res sessions
    },
  },
});

if (recentDismiss) {
  return null; // Ne pas re-suggÃ©rer
}
```

### Integration avec Session Flow
1. Au dÃ©but de chaque exercice dans session active
2. VÃ©rifier GET /progression/suggestions?exerciseId=xxx
3. Si suggestion pending: afficher ProgressionSuggestionCard
4. Si acceptÃ©: mettre Ã  jour state local avec nouveau target
5. Si ignorÃ©: PATCH dismiss et continuer

## Testing
- Tester qu'aucune suggestion si < 3 sessions
- Tester dÃ©tection de stabilisation avec donnÃ©es identiques
- Tester gÃ©nÃ©ration de suggestion weight aprÃ¨s target reps atteint
- Tester gÃ©nÃ©ration de suggestion reps si weight plafonne
- Tester accept met Ã  jour les targets
- Tester dismiss et cooldown (pas de re-suggestion)
- Tester que la suggestion s'affiche au bon moment dans session

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
