# Story 1.4: Authentication System

## Status: Draft

## Story
**As a** user,
**I want** to register and login securely,
**so that** my data is protected and personal.

## Acceptance Criteria
1. Endpoints API : `POST /auth/register`, `POST /auth/login`, `POST /auth/logout`, `GET /auth/me`
2. Mots de passe hashés avec bcrypt
3. JWT tokens générés et validés
4. Middleware d'authentification protégeant les routes privées
5. Page `/login` avec formulaire (email, password)
6. Page `/register` avec formulaire (name, email, password, confirm password)
7. Redirection automatique vers login si non authentifié
8. Stockage sécurisé du token côté client (httpOnly cookie ou secure storage)
9. Validation des inputs côté serveur et messages d'erreur appropriés

## Tasks / Subtasks
- [ ] Créer endpoints auth backend (AC: 1, 2, 3)
  - [ ] Installer bcrypt, jsonwebtoken, et types
  - [ ] Créer `src/services/auth.service.ts`
  - [ ] Implémenter hashPassword et comparePassword
  - [ ] Implémenter generateToken et verifyToken
  - [ ] Créer `src/routes/auth.routes.ts`
  - [ ] POST /auth/register - créer utilisateur
  - [ ] POST /auth/login - authentifier et retourner token
  - [ ] POST /auth/logout - invalider session
  - [ ] GET /auth/me - retourner utilisateur courant
- [ ] Créer middleware d'auth (AC: 4)
  - [ ] Créer `src/middleware/auth.middleware.ts`
  - [ ] Extraire et valider JWT du header Authorization
  - [ ] Attacher user au request object
  - [ ] Retourner 401 si token invalide/absent
- [ ] Créer page login (AC: 5)
  - [ ] Créer `app/(auth)/login/page.tsx`
  - [ ] Formulaire avec React Hook Form + Zod
  - [ ] Champs: email, password
  - [ ] Gestion loading, erreurs
  - [ ] Redirection vers / après succès
- [ ] Créer page register (AC: 6)
  - [ ] Créer `app/(auth)/register/page.tsx`
  - [ ] Formulaire avec validation Zod
  - [ ] Champs: name, email, password, confirmPassword
  - [ ] Validation: passwords match, email format
  - [ ] Redirection vers login après succès
- [ ] Implémenter protection des routes (AC: 7)
  - [ ] Créer `middleware.ts` Next.js
  - [ ] Vérifier présence token pour routes protégées
  - [ ] Rediriger vers /login si non authentifié
- [ ] Gestion du token côté client (AC: 8)
  - [ ] Créer store Zustand pour auth
  - [ ] Stocker token en localStorage + state
  - [ ] Configurer API client avec Authorization header
- [ ] Validation et erreurs (AC: 9)
  - [ ] Créer schemas Zod pour validation backend
  - [ ] Retourner erreurs formatées (code, message, details)
  - [ ] Afficher erreurs côté client

## Dev Notes

### Auth Flow
```
1. Login Form → POST /auth/login
2. Backend vérifie credentials avec bcrypt
3. Génère JWT avec userId et expiration
4. Retourne { user, accessToken, expiresAt }
5. Client stocke token (Zustand + localStorage)
6. Requêtes suivantes incluent Authorization: Bearer <token>
```

### JWT Configuration
```typescript
const JWT_SECRET = process.env.JWT_SECRET;
const JWT_EXPIRES_IN = '7d';

// Payload
{
  userId: string;
  email: string;
  iat: number;
  exp: number;
}
```

### Password Hashing
```typescript
import bcrypt from 'bcrypt';
const SALT_ROUNDS = 12;

// Hash
const hash = await bcrypt.hash(password, SALT_ROUNDS);

// Compare
const isValid = await bcrypt.compare(password, hash);
```

### Zod Schemas
```typescript
// Register
const registerSchema = z.object({
  name: z.string().min(2),
  email: z.string().email(),
  password: z.string().min(8),
});

// Login
const loginSchema = z.object({
  email: z.string().email(),
  password: z.string().min(1),
});
```

### Error Codes
- `INVALID_CREDENTIALS` - email ou password incorrect
- `EMAIL_EXISTS` - email déjà utilisé
- `VALIDATION_ERROR` - données invalides

### Zustand Auth Store
```typescript
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  login: (email: string, password: string) => Promise<void>;
  logout: () => void;
  checkAuth: () => Promise<void>;
}
```

## Testing
- Tester register avec données valides → user créé
- Tester register avec email existant → erreur
- Tester login avec credentials valides → token retourné
- Tester login avec mauvais password → erreur 401
- Tester accès route protégée sans token → redirection login
- Tester accès route protégée avec token valide → accès autorisé

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
