# Story 1.2: Database & Prisma Setup

## Status: Ready for Review

## Story
**As a** developer,
**I want** PostgreSQL configured with Prisma ORM,
**so that** I can define and migrate the database schema with type safety.

## Acceptance Criteria
1. Docker Compose configuré avec service PostgreSQL pour dev local
2. Prisma initialisé dans le projet avec connexion PostgreSQL
3. Modèle `User` créé avec champs de base (id, email, password hash, name, createdAt, updatedAt)
4. Première migration générée et applicable
5. Prisma Client généré et accessible depuis le backend
6. Script de seed basique pour données de test
7. Variables d'environnement documentées (`.env.example`)

## Tasks / Subtasks
- [x] Setup Docker Compose pour PostgreSQL (AC: 1)
  - [x] Créer `docker/docker-compose.dev.yml`
  - [x] Configurer service postgres (port 5432, volume persistant)
  - [x] Ajouter script `npm run db:start` à la racine
  - [x] Tester connexion avec psql ou client DB
- [x] Initialiser Prisma (AC: 2)
  - [x] `npm install prisma @prisma/client` dans apps/api
  - [x] `npx prisma init`
  - [x] Configurer DATABASE_URL dans `.env`
  - [x] Créer `.env.example` avec template
- [x] Créer modèle User (AC: 3)
  - [x] Définir schema User dans `prisma/schema.prisma`
  - [x] Champs: id (uuid), email (unique), passwordHash, name, createdAt, updatedAt
- [x] Générer et appliquer migration (AC: 4)
  - [x] `npx prisma migrate dev --name init_user`
  - [x] Vérifier que la table est créée en DB
- [x] Configurer Prisma Client (AC: 5)
  - [x] Créer `apps/api/src/lib/prisma.ts` avec singleton pattern
  - [x] Exporter le client pour utilisation dans les services
  - [x] Ajouter script `prisma generate` au postinstall
- [x] Créer seed script (AC: 6)
  - [x] Créer `prisma/seed.ts`
  - [x] Ajouter utilisateur de test
  - [x] Configurer seed dans package.json
- [x] Documentation (AC: 7)
  - [x] Compléter `.env.example` avec toutes les variables
  - [x] Documenter les commandes Prisma dans README

## Dev Notes

### Docker Compose Dev
```yaml
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: momentum
      POSTGRES_PASSWORD: momentum_dev
      POSTGRES_DB: momentum
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
```

### Prisma Schema - User Model
```prisma
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("users")
}
```

### Prisma Client Singleton
```typescript
// apps/api/src/lib/prisma.ts
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as { prisma: PrismaClient };

export const prisma = globalForPrisma.prisma || new PrismaClient();

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
```

### Variables d'environnement
```
DATABASE_URL="postgresql://momentum:momentum_dev@localhost:5432/momentum"
```

### Versions
- PostgreSQL: 16.x
- Prisma: 7.x (dernière version stable)

## Testing
- Vérifier que Docker Compose démarre PostgreSQL sans erreur
- Vérifier que `npx prisma migrate dev` applique la migration
- Vérifier que `npx prisma studio` ouvre l'interface admin
- Vérifier que le seed crée l'utilisateur de test

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
| 2026-01-18 | 1.0 | Implementation completed | Dev James |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Debug Log References
- None

### Completion Notes
- Docker Compose configuré avec PostgreSQL 16 et healthcheck
- Prisma 7.2 initialisé avec configuration adaptée (prisma.config.ts)
- Prisma 7 nécessite l'adapter pg pour connexion directe à PostgreSQL
- Migration `init_user` créée et appliquée
- Seed script fonctionnel créant un utilisateur de test (test@momentum.dev / password123)
- Scripts ajoutés: db:start, db:stop, db:reset (racine), db:migrate, db:generate, db:studio, db:seed (api)
- README mis à jour avec documentation complète

### Notes Techniques Prisma 7
- La config URL est dans `prisma.config.ts`, pas dans `schema.prisma`
- Le client nécessite un adapter (`@prisma/adapter-pg`) pour connexion directe
- Le client est généré dans `src/generated/prisma/`

### File List
| File | Status |
|------|--------|
| docker/docker-compose.dev.yml | Created |
| package.json | Modified |
| apps/api/package.json | Modified |
| apps/api/.env | Created |
| apps/api/.env.example | Created |
| apps/api/prisma.config.ts | Modified |
| apps/api/prisma/schema.prisma | Modified |
| apps/api/prisma/seed.ts | Created |
| apps/api/prisma/migrations/20260118002824_init_user/migration.sql | Created |
| apps/api/src/lib/prisma.ts | Created |
| apps/api/src/generated/prisma/* | Generated |
| README.md | Modified |
