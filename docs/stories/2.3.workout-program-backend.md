# Story 2.3: Workout Program - Data Model & Backend

## Status: Draft

## Story
**As a** developer,
**I want** workout program and workout-exercise relationship models,
**so that** users can create structured training programs.

## Acceptance Criteria
1. Modèle `Workout` créé (id, userId, name, description nullable, createdAt, updatedAt)
2. Modèle `WorkoutExercise` créé (id, workoutId, exerciseId, order, targetSets, targetReps, targetWeight nullable, restBetweenSets en secondes, restAfterExercise en secondes)
3. Endpoints API : `GET /workouts`, `GET /workouts/:id` (avec exercises), `POST /workouts`, `PUT /workouts/:id`, `DELETE /workouts/:id`, `POST /workouts/:id/duplicate`
4. Création de workout avec exercises en une seule requête (nested create)
5. Cascade delete : supprimer un workout supprime ses WorkoutExercises
6. Validation : workout doit avoir au moins 1 exercice pour être valide

## Tasks / Subtasks
- [ ] Créer modèles Workout et WorkoutExercise (AC: 1, 2)
  - [ ] Migration Prisma pour Workout
  - [ ] Migration Prisma pour WorkoutExercise
  - [ ] Relation Workout → WorkoutExercise (1:N)
  - [ ] Relation WorkoutExercise → Exercise (N:1)
  - [ ] Index sur order pour tri
- [ ] Créer endpoints CRUD (AC: 3)
  - [ ] GET /workouts - liste des workouts de l'utilisateur
  - [ ] GET /workouts/:id - workout avec exercises inclus
  - [ ] POST /workouts - créer workout avec exercises
  - [ ] PUT /workouts/:id - modifier workout et exercises
  - [ ] DELETE /workouts/:id - supprimer workout
  - [ ] POST /workouts/:id/duplicate - dupliquer un workout
- [ ] Implémenter nested create (AC: 4)
  - [ ] Accepter exercises dans body du POST
  - [ ] Créer WorkoutExercises en transaction
  - [ ] Valider que tous les exerciseId existent
- [ ] Configurer cascade delete (AC: 5)
  - [ ] onDelete: Cascade sur relation WorkoutExercise
  - [ ] Tester suppression
- [ ] Validation (AC: 6)
  - [ ] Vérifier qu'au moins 1 exercice est fourni
  - [ ] Valider les champs numériques (sets > 0, reps > 0, rest >= 0)
  - [ ] Retourner 400 si invalide

## Dependencies
- Story 1.2: Database & Prisma Setup (Prisma 7 configuration)
- Story 2.1: Exercise Library Backend (modèle Exercise pour relations)

## Dev Notes

### Prisma 7 Configuration (ref Story 1.2)
- La config datasource est dans `prisma.config.ts` (pas dans schema.prisma)
- Le client est généré dans `src/generated/prisma/`
- Utiliser `moduleFormat = "cjs"` dans le generator
- Import Prisma: `import { prisma } from '../lib/prisma'`

### Prisma Schema
```prisma
model Workout {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  exercises WorkoutExercise[]
  sessions  WorkoutSession[]

  @@map("workouts")
}

model WorkoutExercise {
  id                String   @id @default(uuid())
  workoutId         String   @map("workout_id")
  workout           Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exerciseId        String   @map("exercise_id")
  exercise          Exercise @relation(fields: [exerciseId], references: [id])
  order             Int
  targetSets        Int      @map("target_sets")
  targetReps        Int      @map("target_reps")
  targetWeight      Float?   @map("target_weight")
  restBetweenSets   Int      @map("rest_between_sets")  // seconds
  restAfterExercise Int      @map("rest_after_exercise") // seconds

  @@map("workout_exercises")
}
```

### API Request/Response

```typescript
// POST /workouts
Request: {
  name: string;
  description?: string;
  exercises: [
    {
      exerciseId: string;
      order: number;
      targetSets: number;
      targetReps: number;
      targetWeight?: number;
      restBetweenSets: number;
      restAfterExercise: number;
    }
  ]
}

// GET /workouts/:id
Response: {
  id: string;
  name: string;
  description: string | null;
  exercises: [
    {
      id: string;
      exerciseId: string;
      exercise: { id, name, muscleGroups };
      order: number;
      targetSets: number;
      targetReps: number;
      targetWeight: number | null;
      restBetweenSets: number;
      restAfterExercise: number;
    }
  ];
  createdAt: string;
  updatedAt: string;
}

// POST /workouts/:id/duplicate
Response: {
  // New workout with same exercises, name = "Copy of {original name}"
}
```

### Service Implementation
```typescript
// workout.service.ts
async createWorkout(userId: string, data: CreateWorkoutInput) {
  return prisma.workout.create({
    data: {
      userId,
      name: data.name,
      description: data.description,
      exercises: {
        create: data.exercises.map((e, index) => ({
          exerciseId: e.exerciseId,
          order: e.order ?? index + 1,
          targetSets: e.targetSets,
          targetReps: e.targetReps,
          targetWeight: e.targetWeight,
          restBetweenSets: e.restBetweenSets,
          restAfterExercise: e.restAfterExercise,
        })),
      },
    },
    include: {
      exercises: {
        include: { exercise: true },
        orderBy: { order: 'asc' },
      },
    },
  });
}
```

### Zod Validation
```typescript
const workoutExerciseSchema = z.object({
  exerciseId: z.string().uuid(),
  order: z.number().int().positive().optional(),
  targetSets: z.number().int().min(1).max(20),
  targetReps: z.number().int().min(1).max(100),
  targetWeight: z.number().positive().optional(),
  restBetweenSets: z.number().int().min(0).max(600), // max 10 min
  restAfterExercise: z.number().int().min(0).max(600),
});

const createWorkoutSchema = z.object({
  name: z.string().min(2).max(100),
  description: z.string().max(500).optional(),
  exercises: z.array(workoutExerciseSchema).min(1, 'Au moins 1 exercice requis'),
});
```

## Testing
- Tester création workout avec exercises
- Tester GET workout/:id inclut exercises avec détails
- Tester PUT modifie le workout et ses exercises
- Tester DELETE supprime workout et exercises (cascade)
- Tester POST sans exercises → erreur 400
- Tester duplicate crée une copie

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
