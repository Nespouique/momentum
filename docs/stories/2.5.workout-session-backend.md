# Story 2.5: Workout Session - Data Model & Backend

## Status: Draft

## Story
**As a** developer,
**I want** session and set tracking models,
**so that** workout execution can be recorded in detail.

## Acceptance Criteria
1. Modèle `WorkoutSession` créé (id, userId, workoutId, status: in_progress/completed/abandoned, startedAt, completedAt nullable, notes nullable)
2. Modèle `Set` créé (id, sessionId, exerciseId, setNumber, reps, weight, rpe nullable 1-10, completedAt)
3. Endpoints : `POST /sessions` (démarrer), `GET /sessions/:id`, `PATCH /sessions/:id` (compléter/abandonner/notes), `DELETE /sessions/:id`, `GET /sessions` (historique), `GET /sessions/active`
4. Endpoints sets : `POST /sessions/:id/sets`, `PUT /sessions/:id/sets/:setId`, `DELETE /sessions/:id/sets/:setId`
5. Calcul automatique de duration à la complétion (completedAt - startedAt)
6. Filtrage historique par status, workoutId, date range (from/to), pagination (limit/offset)

## Tasks / Subtasks
- [ ] Créer modèle WorkoutSession (AC: 1)
  - [ ] Migration Prisma
  - [ ] Enum status: in_progress, completed, abandoned
  - [ ] Relations avec User et Workout
- [ ] Créer modèle Set (AC: 2)
  - [ ] Migration Prisma
  - [ ] Relation avec Session et Exercise
  - [ ] Champ rpe optionnel (1-10)
- [ ] Créer endpoints session (AC: 3)
  - [ ] POST /sessions - démarrer session (workoutId requis)
  - [ ] GET /sessions/:id - session avec sets et workout inclus
  - [ ] PATCH /sessions/:id - modifier status/notes
  - [ ] DELETE /sessions/:id - supprimer session
  - [ ] GET /sessions - historique paginé
  - [ ] GET /sessions/active - session en cours (status=in_progress)
- [ ] Créer endpoints sets (AC: 4)
  - [ ] POST /sessions/:id/sets - ajouter un set
  - [ ] PUT /sessions/:id/sets/:setId - modifier un set
  - [ ] DELETE /sessions/:id/sets/:setId - supprimer un set
  - [ ] Valider que la session est in_progress pour modifications
- [ ] Calculer duration (AC: 5)
  - [ ] Au PATCH status=completed, calculer completedAt - startedAt
  - [ ] Stocker comme champ calculé ou computed à la volée
- [ ] Implémenter filtrage/pagination (AC: 6)
  - [ ] Query params: status, workoutId, from, to, limit, offset
  - [ ] Tri par date décroissante par défaut
  - [ ] Retourner total count pour pagination

## Dependencies
- Story 1.2: Database & Prisma Setup (Prisma 7 configuration)
- Story 2.3: Workout Program Backend (modèle Workout pour relation)
- Story 2.1: Exercise Library Backend (modèle Exercise pour relation Set)

## Dev Notes

### Prisma 7 Configuration (ref Story 1.2)
- La config datasource est dans `prisma.config.ts` (pas dans schema.prisma)
- Le client est généré dans `src/generated/prisma/`
- Utiliser `moduleFormat = "cjs"` dans le generator
- Import Prisma: `import { prisma } from '../lib/prisma'`

### Contrainte Business Importante
**Une seule session active par utilisateur:**
```typescript
// Avant de créer une session, vérifier qu'il n'y en a pas déjà une active
const existingSession = await prisma.workoutSession.findFirst({
  where: { userId, status: 'in_progress' }
});
if (existingSession) {
  return res.status(409).json({ error: 'SESSION_ALREADY_ACTIVE' });
}
```

### Prisma Schema
```prisma
enum SessionStatus {
  in_progress
  completed
  abandoned
}

model WorkoutSession {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  user        User          @relation(fields: [userId], references: [id])
  workoutId   String        @map("workout_id")
  workout     Workout       @relation(fields: [workoutId], references: [id])
  status      SessionStatus @default(in_progress)
  startedAt   DateTime      @default(now()) @map("started_at")
  completedAt DateTime?     @map("completed_at")
  notes       String?

  sets Set[]

  @@map("workout_sessions")
}

model Set {
  id          String         @id @default(uuid())
  sessionId   String         @map("session_id")
  session     WorkoutSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exerciseId  String         @map("exercise_id")
  exercise    Exercise       @relation(fields: [exerciseId], references: [id])
  setNumber   Int            @map("set_number")
  reps        Int
  weight      Float
  rpe         Int?           // Rate of Perceived Exertion 1-10
  completedAt DateTime       @default(now()) @map("completed_at")

  @@map("sets")
}
```

### API Endpoints

```typescript
// POST /sessions
Request: { workoutId: string }
Response: WorkoutSession (with workout details)

// GET /sessions/active
Response: WorkoutSession | null

// GET /sessions?status=completed&workoutId=xxx&from=2024-01-01&to=2024-01-31&limit=20&offset=0
Response: {
  data: WorkoutSession[];
  total: number;
  limit: number;
  offset: number;
}

// PATCH /sessions/:id
Request: {
  status?: 'completed' | 'abandoned';
  notes?: string;
}

// POST /sessions/:id/sets
Request: {
  exerciseId: string;
  setNumber: number;
  reps: number;
  weight: number;
  rpe?: number;
}
```

### Duration Calculation
```typescript
// Dans le service, au moment de compléter
async completeSession(sessionId: string, notes?: string) {
  const session = await prisma.workoutSession.findUnique({
    where: { id: sessionId },
  });

  const completedAt = new Date();
  const durationMinutes = Math.round(
    (completedAt.getTime() - session.startedAt.getTime()) / 60000
  );

  return prisma.workoutSession.update({
    where: { id: sessionId },
    data: {
      status: 'completed',
      completedAt,
      notes,
    },
  });
}
```

### Validation Rules
- Seul le owner peut modifier sa session
- Sets ne peuvent être ajoutés que si session est in_progress
- RPE doit être entre 1 et 10 si fourni
- Une seule session in_progress par utilisateur à la fois

### Zod Schemas
```typescript
const createSetSchema = z.object({
  exerciseId: z.string().uuid(),
  setNumber: z.number().int().positive(),
  reps: z.number().int().positive().max(100),
  weight: z.number().min(0).max(1000),
  rpe: z.number().int().min(1).max(10).optional(),
});

const updateSessionSchema = z.object({
  status: z.enum(['completed', 'abandoned']).optional(),
  notes: z.string().max(1000).optional(),
});
```

## Testing
- Tester démarrage session → status in_progress
- Tester qu'on ne peut démarrer qu'une session à la fois
- Tester ajout de sets pendant session active
- Tester modification de set
- Tester suppression de set
- Tester complétion → completedAt défini
- Tester abandon → status abandoned
- Tester GET /sessions/active retourne session en cours
- Tester filtrage par date range
- Tester pagination

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
