# Story 2.1: Exercise Library - Data Model & Backend

## Status: Ready for Review

## Story
**As a** developer,
**I want** a complete exercise data model and API,
**so that** exercises can be managed and used in workout programs.

## Acceptance Criteria
1. Modèle `Exercise` créé (id, name, muscleGroups[], createdAt)
2. Constantes pour `muscleGroups` (array multi-sélection) : `abdos, biceps, dos, epaules, fessiers, ischios, lombaires, mollets, pecs, quadriceps, trapezes, triceps`
3. Endpoints API : `GET /exercises`, `GET /exercises/:id`, `POST /exercises`, `PUT /exercises/:id`, `DELETE /exercises/:id`, `GET /exercises/muscle-groups`
4. Filtrage par muscleGroup sur `GET /exercises?muscleGroup=pecs`
5. Bibliothèque unique partagée par tous les utilisateurs (pas de distinction custom/système)
6. Seed avec bibliothèque initiale d'exercices courants (15-20 exercices de base avec groupes musculaires multiples)
7. Validation : impossible de supprimer un exercice utilisé dans un programme

## Tasks / Subtasks
- [x] Créer modèle Exercise (AC: 1, 2)
  - [x] Définir enum/constantes pour MuscleGroup
  - [x] Créer migration Prisma
  - [x] muscleGroups stocké comme array de strings
- [x] Créer endpoints CRUD (AC: 3)
  - [x] GET /exercises - liste tous les exercices
  - [x] GET /exercises/:id - détail exercice
  - [x] POST /exercises - créer exercice (bibliothèque partagée)
  - [x] PUT /exercises/:id - modifier un exercice
  - [x] DELETE /exercises/:id - supprimer un exercice
  - [x] GET /exercises/muscle-groups - retourner liste des groupes
- [x] Implémenter filtrage (AC: 4)
  - [x] Query param muscleGroup → filter where muscleGroups contains
- [x] Bibliothèque partagée (AC: 5)
  - [x] Tous les exercices visibles par tous les utilisateurs
  - [x] Pas de colonnes isCustom/userId
- [x] Créer seed data (AC: 6)
  - [x] Intégrer dans `prisma/seed.ts`
  - [x] 31 exercices de base couvrant tous les groupes
  - [x] Exercices composés avec plusieurs groupes musculaires
- [x] Validation suppression (AC: 7)
  - [x] Code préparé pour vérifier WorkoutExercise (commenté, activé en Story 2.3)
  - [x] Retourner erreur 409 Conflict si utilisé

## Dependencies
- Story 1.2: Database & Prisma Setup (Prisma 7 configuration)

## Dev Notes

### Prisma 7 Configuration (ref Story 1.2)
- La config datasource est dans `prisma.config.ts` (pas dans schema.prisma)
- Le client est généré dans `src/generated/prisma/`
- Utiliser `moduleFormat = "cjs"` dans le generator
- Import Prisma: `import { prisma } from '../lib/prisma'`

### Muscle Groups Enum
```typescript
// packages/shared/src/types/index.ts
export const MUSCLE_GROUPS = [
  'abdos',
  'biceps',
  'dos',
  'epaules',
  'fessiers',
  'ischios',
  'lombaires',
  'mollets',
  'pecs',
  'quadriceps',
  'trapezes',
  'triceps',
] as const;

export type MuscleGroup = (typeof MUSCLE_GROUPS)[number];
```

### Prisma Schema
```prisma
model Exercise {
  id           String   @id @default(uuid())
  name         String
  muscleGroups String[] @map("muscle_groups")
  createdAt    DateTime @default(now()) @map("created_at")

  workoutExercises WorkoutExercise[]

  @@map("exercises")
}
```

### API Endpoints
```typescript
// GET /exercises?muscleGroup=pecs
Response: {
  data: Exercise[];
  total: number;
}

// GET /exercises/muscle-groups
Response: {
  muscleGroups: string[];  // Liste des constantes
}

// POST /exercises
Request: {
  name: string;
  muscleGroups: MuscleGroup[];  // Au moins 1
}

// Response errors
409 Conflict: "Cannot delete exercise used in workout programs"
```

### Seed Exercises (exemples)
```typescript
const seedExercises = [
  { name: 'Développé couché', muscleGroups: ['pecs', 'triceps', 'epaules'] },
  { name: 'Développé incliné', muscleGroups: ['pecs', 'triceps', 'epaules'] },
  { name: 'Tractions', muscleGroups: ['dos', 'biceps'] },
  { name: 'Rowing barre', muscleGroups: ['dos', 'biceps', 'trapezes'] },
  { name: 'Squat', muscleGroups: ['quadriceps', 'fessiers', 'ischios'] },
  { name: 'Soulevé de terre', muscleGroups: ['dos', 'ischios', 'fessiers', 'lombaires'] },
  { name: 'Développé militaire', muscleGroups: ['epaules', 'triceps'] },
  { name: 'Curl biceps', muscleGroups: ['biceps'] },
  { name: 'Extension triceps', muscleGroups: ['triceps'] },
  { name: 'Leg press', muscleGroups: ['quadriceps', 'fessiers'] },
  { name: 'Leg curl', muscleGroups: ['ischios'] },
  { name: 'Mollets debout', muscleGroups: ['mollets'] },
  { name: 'Crunch', muscleGroups: ['abdos'] },
  { name: 'Élévations latérales', muscleGroups: ['epaules'] },
  { name: 'Face pull', muscleGroups: ['epaules', 'trapezes', 'dos'] },
];
```

### Zod Validation
```typescript
const createExerciseSchema = z.object({
  name: z.string().min(2).max(100),
  muscleGroups: z.array(z.enum(MUSCLE_GROUPS)).min(1),
});
```

## Testing
- Tester GET /exercises retourne tous les exercices
- Tester GET /exercises?muscleGroup=pecs filtre correctement
- Tester POST crée un exercice dans la bibliothèque partagée
- Tester PUT modifie un exercice
- Tester DELETE sur exercice utilisé → 409
- Tester GET /exercises/muscle-groups retourne la liste

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
| 2026-01-19 | 1.0 | Implementation completed | Dev James |
| 2026-01-19 | 1.1 | Simplified to shared library (removed isCustom/userId) | Dev James |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Debug Log References
- None

### Completion Notes
- Created MUSCLE_GROUPS constant and MuscleGroup type in packages/shared
- Added Exercise interface to shared types
- Created Exercise model in Prisma (simplified: no isCustom/userId columns)
- Migration applied successfully
- Created all CRUD endpoints with authentication
- GET /exercises/muscle-groups is public (no auth required)
- All other endpoints require authentication
- Filtering by muscleGroup uses Prisma array `has` operator
- Bibliothèque partagée: tous les exercices visibles par tous les utilisateurs
- 31 exercices seeded couvrant les 12 groupes musculaires
- DELETE validation for WorkoutExercise prepared (commented, will activate in Story 2.3)
- All endpoints tested manually: GET, GET/:id, POST, PUT, DELETE, filters

### File List
| File | Status |
|------|--------|
| packages/shared/src/types/index.ts | Modified |
| apps/api/prisma/schema.prisma | Modified |
| apps/api/prisma/migrations/20260119130912_add_exercises/migration.sql | Created |
| apps/api/prisma/seed.ts | Modified |
| apps/api/src/schemas/exercise.schema.ts | Created |
| apps/api/src/routes/exercise.routes.ts | Created |
| apps/api/src/index.ts | Modified |
