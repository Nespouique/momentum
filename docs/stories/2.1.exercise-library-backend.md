# Story 2.1: Exercise Library - Data Model & Backend

## Status: Draft

## Story
**As a** developer,
**I want** a complete exercise data model and API,
**so that** exercises can be managed and used in workout programs.

## Acceptance Criteria
1. Modèle `Exercise` créé (id, name, muscleGroups[], isCustom, userId nullable, createdAt)
2. Constantes pour `muscleGroups` (array multi-sélection) : `abdos, biceps, dos, epaules, fessiers, ischios, lombaires, mollets, pecs, quadriceps, trapezes, triceps`
3. Endpoints API : `GET /exercises`, `GET /exercises/:id`, `POST /exercises`, `PUT /exercises/:id`, `DELETE /exercises/:id`, `GET /exercises/muscle-groups`
4. Filtrage par muscleGroup sur `GET /exercises?muscleGroup=pecs`
5. Filtrage par type `GET /exercises?isCustom=true`
6. Exercices personnalisés liés à l'utilisateur, exercices de base partagés (userId null)
7. Seed avec bibliothèque initiale d'exercices courants (15-20 exercices de base avec groupes musculaires multiples)
8. Validation : impossible de supprimer un exercice utilisé dans un programme

## Tasks / Subtasks
- [ ] Créer modèle Exercise (AC: 1, 2)
  - [ ] Définir enum/constantes pour MuscleGroup
  - [ ] Créer migration Prisma
  - [ ] muscleGroups stocké comme array de strings
  - [ ] Relation optionnelle avec User
- [ ] Créer endpoints CRUD (AC: 3)
  - [ ] GET /exercises - liste avec include user pour custom
  - [ ] GET /exercises/:id - détail exercice
  - [ ] POST /exercises - créer exercice custom (userId = current user, isCustom = true)
  - [ ] PUT /exercises/:id - modifier (seulement si owner)
  - [ ] DELETE /exercises/:id - supprimer (seulement si owner)
  - [ ] GET /exercises/muscle-groups - retourner liste des groupes
- [ ] Implémenter filtrage (AC: 4, 5)
  - [ ] Query param muscleGroup → filter where muscleGroups contains
  - [ ] Query param isCustom → filter boolean
  - [ ] Combiner les filtres
- [ ] Logique custom vs système (AC: 6)
  - [ ] Exercices système: userId = null, isCustom = false
  - [ ] Exercices custom: userId = currentUser, isCustom = true
  - [ ] GET retourne système + custom de l'utilisateur courant
- [ ] Créer seed data (AC: 7)
  - [ ] Créer fichier `prisma/seed-exercises.ts`
  - [ ] 15-20 exercices de base couvrant tous les groupes
  - [ ] Exercices composés avec plusieurs groupes musculaires
- [ ] Validation suppression (AC: 8)
  - [ ] Vérifier si exercice utilisé dans WorkoutExercise
  - [ ] Retourner erreur 409 Conflict si utilisé

## Dev Notes

### Muscle Groups Enum
```typescript
// packages/shared/src/types/index.ts
export const MUSCLE_GROUPS = [
  'abdos',
  'biceps',
  'dos',
  'epaules',
  'fessiers',
  'ischios',
  'lombaires',
  'mollets',
  'pecs',
  'quadriceps',
  'trapezes',
  'triceps',
] as const;

export type MuscleGroup = (typeof MUSCLE_GROUPS)[number];
```

### Prisma Schema
```prisma
model Exercise {
  id           String   @id @default(uuid())
  name         String
  muscleGroups String[] @map("muscle_groups")
  isCustom     Boolean  @default(false) @map("is_custom")
  userId       String?  @map("user_id")
  user         User?    @relation(fields: [userId], references: [id])
  createdAt    DateTime @default(now()) @map("created_at")

  workoutExercises WorkoutExercise[]

  @@map("exercises")
}
```

### API Endpoints
```typescript
// GET /exercises?muscleGroup=pecs&isCustom=false
Response: {
  data: Exercise[];
  total: number;
}

// GET /exercises/muscle-groups
Response: {
  muscleGroups: string[];  // Liste des constantes
}

// POST /exercises
Request: {
  name: string;
  muscleGroups: MuscleGroup[];  // Au moins 1
}

// Response errors
409 Conflict: "Cannot delete exercise used in workout programs"
```

### Seed Exercises (exemples)
```typescript
const seedExercises = [
  { name: 'Développé couché', muscleGroups: ['pecs', 'triceps', 'epaules'] },
  { name: 'Développé incliné', muscleGroups: ['pecs', 'triceps', 'epaules'] },
  { name: 'Tractions', muscleGroups: ['dos', 'biceps'] },
  { name: 'Rowing barre', muscleGroups: ['dos', 'biceps', 'trapezes'] },
  { name: 'Squat', muscleGroups: ['quadriceps', 'fessiers', 'ischios'] },
  { name: 'Soulevé de terre', muscleGroups: ['dos', 'ischios', 'fessiers', 'lombaires'] },
  { name: 'Développé militaire', muscleGroups: ['epaules', 'triceps'] },
  { name: 'Curl biceps', muscleGroups: ['biceps'] },
  { name: 'Extension triceps', muscleGroups: ['triceps'] },
  { name: 'Leg press', muscleGroups: ['quadriceps', 'fessiers'] },
  { name: 'Leg curl', muscleGroups: ['ischios'] },
  { name: 'Mollets debout', muscleGroups: ['mollets'] },
  { name: 'Crunch', muscleGroups: ['abdos'] },
  { name: 'Élévations latérales', muscleGroups: ['epaules'] },
  { name: 'Face pull', muscleGroups: ['epaules', 'trapezes', 'dos'] },
];
```

### Zod Validation
```typescript
const createExerciseSchema = z.object({
  name: z.string().min(2).max(100),
  muscleGroups: z.array(z.enum(MUSCLE_GROUPS)).min(1),
});
```

## Testing
- Tester GET /exercises retourne exercices système + custom user
- Tester GET /exercises?muscleGroup=pecs filtre correctement
- Tester POST crée un exercice avec isCustom=true et userId
- Tester PUT sur exercice d'un autre user → 403
- Tester DELETE sur exercice utilisé → 409
- Tester GET /exercises/muscle-groups retourne la liste

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PO Sarah |
