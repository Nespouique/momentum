# Story 1.9: Password Reset - Backend (Email + API)

## Status: Draft

## Story
**As a** user who has forgotten my password,
**I want** to request a password reset link by email,
**so that** I can regain access to my account.

## Acceptance Criteria
1. `POST /auth/forgot-password` accepts `{ email }` and always returns 200 (no email leak)
2. If user exists, a unique reset token is generated (crypto.randomBytes, 32 bytes hex)
3. Token hash (SHA-256) stored in DB with 1h expiration (`passwordResetToken`, `passwordResetExpiresAt` fields on User)
4. Plain token sent via email link: `{FRONTEND_URL}/reset-password?token={token}`
5. Email sent via Resend SDK from `noreply@hallais.bzh`
6. `POST /auth/reset-password` accepts `{ token, password }` and validates:
   - Token matches a user's stored hash
   - Token is not expired (< 1h)
   - New password meets minimum requirements (8 chars)
7. On successful reset: password updated (bcrypt), reset token fields cleared, returns 200
8. On invalid/expired token: returns 400 with appropriate error code
9. Resend API key stored in `RESEND_API_KEY` env variable
10. Email template is clean, in French, with Momentum branding minimal

## Prerequisites
- **Domain verification**: `hallais.bzh` must be verified in Resend dashboard (DNS records: MX, SPF, DKIM) before emails can be sent from `noreply@hallais.bzh`
- Without domain verification, Resend will reject the sender address

## Tasks / Subtasks
- [ ] Add Resend dependency (AC: 5, 9)
  - [ ] `npm install resend` in `apps/api`
  - [ ] Add `RESEND_API_KEY` to `.env` and `.env.example`
  - [ ] Add `RESEND_FROM_EMAIL=noreply@hallais.bzh` to `.env` and `.env.example`
- [ ] Add password reset fields to User model (AC: 3)
  - [ ] Add `passwordResetToken String? @map("password_reset_token")` to User model
  - [ ] Add `passwordResetExpiresAt DateTime? @map("password_reset_expires_at")` to User model
  - [ ] Run `prisma migrate dev --name add_password_reset_fields`
- [ ] Create email service (AC: 5, 10)
  - [ ] Create `src/services/email.service.ts`
  - [ ] Initialize Resend client with `RESEND_API_KEY`
  - [ ] Implement `sendPasswordResetEmail(to, resetUrl)` function
  - [ ] Email content in French, clean HTML template
- [ ] Create password reset service (AC: 2, 3, 6, 7, 8)
  - [ ] Create `src/services/password-reset.service.ts`
  - [ ] `generateResetToken()`: crypto.randomBytes(32).toString('hex')
  - [ ] `hashToken(token)`: crypto.createHash('sha256').update(token).digest('hex')
  - [ ] `requestPasswordReset(email)`: find user, generate token, store hash + expiry, send email
  - [ ] `resetPassword(token, newPassword)`: validate token hash, check expiry, update password, clear token
- [ ] Create Zod schemas (AC: 1, 6)
  - [ ] Add `forgotPasswordSchema` to `src/schemas/auth.schema.ts`: `{ email: z.string().email() }`
  - [ ] Add `resetPasswordSchema`: `{ token: z.string().min(1), password: z.string().min(8) }`
- [ ] Create API endpoints (AC: 1, 6, 7, 8)
  - [ ] Add `POST /auth/forgot-password` to `auth.routes.ts`
  - [ ] Add `POST /auth/reset-password` to `auth.routes.ts`
  - [ ] Both endpoints are public (no authMiddleware)
  - [ ] Proper error codes: `INVALID_RESET_TOKEN`, `EXPIRED_RESET_TOKEN`, `VALIDATION_ERROR`

## Dev Notes

### Token Flow
```
1. User submits email → POST /auth/forgot-password
2. Backend generates plainToken = crypto.randomBytes(32).toString('hex')
3. Backend stores hashedToken = SHA256(plainToken) + expiresAt (now + 1h)
4. Backend sends email with link: {FRONTEND_URL}/reset-password?token={plainToken}
5. User clicks link → frontend shows new password form
6. User submits → POST /auth/reset-password { token: plainToken, password }
7. Backend hashes submitted token, finds user by matching hash
8. Validates expiry, updates password (bcrypt), clears reset fields
```

### Resend Integration
```typescript
import { Resend } from 'resend';

const resend = new Resend(process.env["RESEND_API_KEY"]);

await resend.emails.send({
  from: process.env["RESEND_FROM_EMAIL"] || 'noreply@hallais.bzh',
  to: userEmail,
  subject: 'Réinitialisation de votre mot de passe - Momentum',
  html: `...`
});
```

### New Environment Variables
```
RESEND_API_KEY="re_xxxxx"
RESEND_FROM_EMAIL="noreply@hallais.bzh"
```

### Prisma Schema Addition
```prisma
model User {
  // ... existing fields ...
  passwordResetToken     String?   @map("password_reset_token")
  passwordResetExpiresAt DateTime? @map("password_reset_expires_at")
}
```

### Error Codes
- `INVALID_RESET_TOKEN` - token doesn't match any user
- `EXPIRED_RESET_TOKEN` - token has expired (> 1h)
- `VALIDATION_ERROR` - invalid input

### Security Notes
- Always return 200 on forgot-password (even if email doesn't exist) to prevent email enumeration
- Store only SHA-256 hash of token in DB (not plain token)
- Clear reset token fields after successful reset
- Token is single-use (cleared after reset)

## Testing
- POST /auth/forgot-password with valid email → 200, email sent
- POST /auth/forgot-password with unknown email → 200, no email sent (no leak)
- POST /auth/forgot-password with invalid format → 400 validation error
- POST /auth/reset-password with valid token + password → 200, password changed
- POST /auth/reset-password with expired token → 400 EXPIRED_RESET_TOKEN
- POST /auth/reset-password with invalid token → 400 INVALID_RESET_TOKEN
- POST /auth/reset-password with short password → 400 VALIDATION_ERROR
- Login with old password after reset → 401
- Login with new password after reset → success

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Story creation | PM John |
